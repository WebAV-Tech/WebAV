!(function(){"use strict";var Yi=Object.defineProperty,Vi=Object.defineProperties;var Wi=Object.getOwnPropertyDescriptors;var He=Object.getOwnPropertySymbols,ji=Object.getPrototypeOf,Xi=Object.prototype.hasOwnProperty,qi=Object.prototype.propertyIsEnumerable,Ki=Reflect.get;var Ye=(N,D,R)=>D in N?Yi(N,D,{enumerable:!0,configurable:!0,writable:!0,value:R}):N[D]=R,Et=(N,D)=>{for(var R in D||(D={}))Xi.call(D,R)&&Ye(N,R,D[R]);if(He)for(var R of He(D))qi.call(D,R)&&Ye(N,R,D[R]);return N},ne=(N,D)=>Vi(N,Wi(D));var Ve=(N,D,R)=>Ki(ji(N),R,D);var T=(N,D,R)=>new Promise((ae,Ht)=>{var F=E=>{try{m(R.next(E))}catch(C){Ht(C)}},At=E=>{try{m(R.throw(E))}catch(C){Ht(C)}},m=E=>E.done?ae(E.value):Promise.resolve(E.value).then(F,At);m((R=R.apply(N,D)).next())});(self.webpackChunkWebAV_Doc_Site=self.webpackChunkWebAV_Doc_Site||[]).push([[301],{50301:function(N,D,R){R.r(D),R.d(D,{AudioClip:function(){return ce},BaseSprite:function(){return Oe},CTRL_KEYS:function(){return Di},Combinator:function(){return Gi},DEFAULT_AUDIO_CONF:function(){return P},EmbedSubtitlesClip:function(){return fi},ImgClip:function(){return di},Log:function(){return z},MP4Clip:function(){return hi},OffscreenSprite:function(){return ve},Rect:function(){return be},adjustAudioDataVolume:function(){return ai},audioResample:function(){return Ie},autoReadStream:function(){return Xt},concatAudioClip:function(){return pi},concatFloat32Array:function(){return dt},concatPCMFragments:function(){return le},createChromakey:function(){return Ri},createEl:function(){return xe},decodeImg:function(){return Te},demuxcode:function(){return De},extractPCM4AudioBuffer:function(){return Vt},extractPCM4AudioData:function(){return Yt},fastConcatMP4:function(){return vi},file2stream:function(){return Qt},mixinMP4AndAudio:function(){return xi},mixinPCM:function(){return Wt},recodemux:function(){return Me},renderTxt2Img:function(){return Ee},renderTxt2ImgBitmap:function(){return We},ringSliceFloat32Array:function(){return jt},sleep:function(){return Tt},stream2file:function(){return yi},throttle:function(){return ke}});var ae=Object.defineProperty,Ht=(d,a,l)=>a in d?ae(d,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):d[a]=l,F=(d,a,l)=>(Ht(d,typeof a!="symbol"?a+"":a,l),l),At=(d,a,l)=>{if(!a.has(d))throw TypeError("Cannot "+l)},m=(d,a,l)=>(At(d,a,"read from private field"),l?l.call(d):a.get(d)),E=(d,a,l)=>{if(a.has(d))throw TypeError("Cannot add the same private member more than once");a instanceof WeakSet?a.add(d):a.set(d,l)},C=(d,a,l,o)=>(At(d,a,"write to private field"),o?o.call(d,l):a.set(d,l),l),q=(d,a,l)=>(At(d,a,"access private method"),l);function xe(d){return document.createElement(d)}function Ee(d,a){const l=xe("div");l.style.cssText=`${a} visibility: hidden; position: fixed;`,l.textContent=d,document.body.appendChild(l);const{width:o,height:p}=l.getBoundingClientRect();l.remove(),l.style.visibility="visible";const u=new Image;u.width=o,u.height=p;const g=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${p}">
    <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">${l.outerHTML}</div>
    </foreignObject>
    </svg>
  `.replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23");return u.src=`data:image/svg+xml;charset=utf-8,${g}`,u}function We(d,a){return T(this,null,function*(){const l=Ee(d,a);yield new Promise(u=>{l.onload=u});const o=new OffscreenCanvas(l.width,l.height),p=o.getContext("2d");return p==null||p.drawImage(l,0,0,l.width,l.height),yield createImageBitmap(o)})}let Ct=1;const Ae={debug:(...d)=>{Ct<=0&&console.debug(...d)},info:(...d)=>{Ct<=1&&console.info(...d)},warn:(...d)=>{Ct<=2&&console.warn(...d)},error:(...d)=>{Ct<=3&&console.error(...d)}},Bt=new Map,z=ne(Et({setLogLevel:d=>{var a;Ct=(a=Bt.get(d))!=null?a:1}},Ae),{create:d=>Object.fromEntries(Object.entries(Ae).map(([a,l])=>[a,(...o)=>l(d,...o)]))});Bt.set(z.debug,0),Bt.set(z.info,1),Bt.set(z.warn,2),Bt.set(z.error,3);const je=()=>{let d,a=16.6;self.onmessage=l=>{l.data.event==="start"&&(self.clearInterval(d),d=self.setInterval(()=>{self.postMessage({})},a)),l.data.event==="stop"&&self.clearInterval(d)}},Xe=()=>{const d=new Blob([`(${je.toString()})()`]),a=URL.createObjectURL(d);return new Worker(a)},mt=new Map;let oe=1;const he=Xe();he.onmessage=()=>{oe+=1;for(const[d,a]of mt.entries())oe%d===0&&a.forEach(l=>l())};const qe=(d,a)=>{var p;const l=Math.round(a/16.6),o=(p=mt.get(l))!=null?p:new Set;return o.add(d),mt.set(l,o),mt.size===1&&o.size===1&&he.postMessage({event:"start"}),()=>{o.delete(d),o.size===0&&mt.delete(l),mt.size===0&&(oe=0,he.postMessage({event:"stop"}))}};class Ke{constructor(a,l,o){this.length_=a,this.scaleFactor_=(a-1)/l,this.interpolate=this.cubic,o.method==="point"?this.interpolate=this.point:o.method==="linear"?this.interpolate=this.linear:o.method==="sinc"&&(this.interpolate=this.sinc),this.tangentFactor_=1-Math.max(0,Math.min(1,o.tension||0)),this.sincFilterSize_=o.sincFilterSize||1,this.kernel_=$e(o.sincWindow||Ze)}point(a,l){return this.getClippedInput_(Math.round(this.scaleFactor_*a),l)}linear(a,l){a=this.scaleFactor_*a;let o=Math.floor(a);return a-=o,(1-a)*this.getClippedInput_(o,l)+a*this.getClippedInput_(o+1,l)}cubic(a,l){a=this.scaleFactor_*a;let o=Math.floor(a),p=[this.getTangent_(o,l),this.getTangent_(o+1,l)],u=[this.getClippedInput_(o,l),this.getClippedInput_(o+1,l)];a-=o;let g=a*a,r=a*g;return(2*r-3*g+1)*u[0]+(r-2*g+a)*p[0]+(-2*r+3*g)*u[1]+(r-g)*p[1]}sinc(a,l){a=this.scaleFactor_*a;let o=Math.floor(a),p=o-this.sincFilterSize_+1,u=o+this.sincFilterSize_,g=0;for(let r=p;r<=u;r++)g+=this.kernel_(a-r)*this.getClippedInput_(r,l);return g}getTangent_(a,l){return this.tangentFactor_*(this.getClippedInput_(a+1,l)-this.getClippedInput_(a-1,l))/2}getClippedInput_(a,l){return 0<=a&&a<this.length_?l[a]:0}}function Ze(d){return Math.exp(-d/2*d/2)}function $e(d){return function(a){return Qe(a)*d(a)}}function Qe(d){return d===0?1:Math.sin(Math.PI*d)/(Math.PI*d)}class Je{constructor(a,l,o){let p=2*Math.PI*o/l,u=0;this.filters=[];for(let g=0;g<=a;g++)g-a/2===0?this.filters[g]=p:(this.filters[g]=Math.sin(p*(g-a/2))/(g-a/2),this.filters[g]*=.54-.46*Math.cos(2*Math.PI*g/a)),u=u+this.filters[g];for(let g=0;g<=a;g++)this.filters[g]/=u;this.z=this.initZ_()}filter(a){this.z.buf[this.z.pointer]=a;let l=0;for(let o=0,p=this.z.buf.length;o<p;o++)l+=this.filters[o]*this.z.buf[(this.z.pointer+o)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,l}reset(){this.z=this.initZ_()}initZ_(){let a=[];for(let l=0;l<this.filters.length-1;l++)a.push(0);return{buf:a,pointer:0}}}class ti{constructor(a,l,o){let p=[];for(let u=0;u<a;u++)p.push(this.getCoeffs_({Fs:l,Fc:o,Q:.5/Math.sin(Math.PI/(a*2)*(u+.5))}));this.stages=[];for(let u=0;u<p.length;u++)this.stages[u]={b0:p[u].b[0],b1:p[u].b[1],b2:p[u].b[2],a1:p[u].a[0],a2:p[u].a[1],k:p[u].k,z:[0,0]}}filter(a){let l=a;for(let o=0,p=this.stages.length;o<p;o++)l=this.runStage_(o,l);return l}getCoeffs_(a){let l={};l.z=[0,0],l.a=[],l.b=[];let o=this.preCalc_(a,l);return l.k=1,l.b.push((1-o.cw)/(2*o.a0)),l.b.push(2*l.b[0]),l.b.push(l.b[0]),l}preCalc_(a,l){let o={},p=2*Math.PI*a.Fc/a.Fs;return o.alpha=Math.sin(p)/(2*a.Q),o.cw=Math.cos(p),o.a0=1+o.alpha,l.a0=o.a0,l.a.push(-2*o.cw/o.a0),l.k=1,l.a.push((1-o.alpha)/o.a0),o}runStage_(a,l){let o=l*this.stages[a].k-this.stages[a].a1*this.stages[a].z[0]-this.stages[a].a2*this.stages[a].z[1],p=this.stages[a].b0*o+this.stages[a].b1*this.stages[a].z[0]+this.stages[a].b2*this.stages[a].z[1];return this.stages[a].z[1]=this.stages[a].z[0],this.stages[a].z[0]=o,p}reset(){for(let a=0;a<this.stages.length;a++)this.stages[a].z=[0,0]}}const ei={point:!1,linear:!1,cubic:!0,sinc:!0},Ce={IIR:16,FIR:71},ii={IIR:ti,FIR:Je};function si(d,a,l,o={}){let p=(l-a)/a+1,u=new Float64Array(d.length*p);o.method=o.method||"cubic";let g=new Ke(d.length,u.length,{method:o.method,tension:o.tension||0,sincFilterSize:o.sincFilterSize||6,sincWindow:o.sincWindow||void 0});if(o.LPF===void 0&&(o.LPF=ei[o.method]),o.LPF){o.LPFType=o.LPFType||"IIR";const r=ii[o.LPFType];if(l>a){let v=new r(o.LPFOrder||Ce[o.LPFType],l,a/2);ri(d,u,g,v)}else{let v=new r(o.LPFOrder||Ce[o.LPFType],a,l/2);ni(d,u,g,v)}}else Be(d,u,g);return u}function Be(d,a,l){for(let o=0,p=a.length;o<p;o++)a[o]=l.interpolate(o,d)}function ri(d,a,l,o){for(let p=0,u=a.length;p<u;p++)a[p]=o.filter(l.interpolate(p,d));o.reset();for(let p=a.length-1;p>=0;p--)a[p]=o.filter(a[p])}function ni(d,a,l,o){for(let p=0,u=d.length;p<u;p++)d[p]=o.filter(d[p]);o.reset();for(let p=d.length-1;p>=0;p--)d[p]=o.filter(d[p]);Be(d,a,l)}function dt(d){const a=new Float32Array(d.map(o=>o.length).reduce((o,p)=>o+p));let l=0;for(const o of d)a.set(o,l),l+=o.length;return a}function le(d){const a=[];for(let l=0;l<d.length;l+=1)for(let o=0;o<d[l].length;o+=1)a[o]==null&&(a[o]=[]),a[o].push(d[l][o]);return a.map(dt)}function Yt(d){return Array(d.numberOfChannels).fill(0).map((a,l)=>{const o=d.allocationSize({planeIndex:l}),p=new ArrayBuffer(o);return d.copyTo(p,{planeIndex:l}),new Float32Array(p)})}function Vt(d){return Array(d.numberOfChannels).fill(0).map((a,l)=>d.getChannelData(l))}function ai(d,a){const l=new Float32Array(dt(Yt(d))).map(p=>p*a),o=new AudioData({sampleRate:d.sampleRate,numberOfChannels:d.numberOfChannels,timestamp:d.timestamp,format:d.format,numberOfFrames:d.numberOfFrames,data:l});return d.close(),o}function Te(d,a){return T(this,null,function*(){var r;var l;const o={type:a,data:d},p=new ImageDecoder(o);yield p.completed;let u=(r=(l=p.tracks.selectedTrack)==null?void 0:l.frameCount)!=null?r:1;const g=[];for(let v=0;v<u;v+=1)g.push((yield p.decode({frameIndex:v})).image);return g})}function Wt(d){var u,g;var a,l;const o=Math.max(...d.map(r=>{var w;var v;return(w=(v=r[0])==null?void 0:v.length)!=null?w:0})),p=new Float32Array(o*2);for(let r=0;r<o;r++){let v=0,w=0;for(let b=0;b<d.length;b++){const B=(u=(a=d[b][0])==null?void 0:a[r])!=null?u:0,t=(g=(l=d[b][1])==null?void 0:l[r])!=null?g:B;v+=B,w+=t}p[r]=v,p[r+o]=w}return p}function Ie(d,a,l){return T(this,null,function*(){const o=d.length,p=Array(l.chanCount).fill(0).map(()=>new Float32Array(0));if(o===0)return p;const u=Math.max(...d.map(w=>w.length));if(u===0)return p;if(globalThis.OfflineAudioContext==null)return d.map(w=>new Float32Array(si(w,a,l.rate,{method:"sinc",LPF:!1})));const g=new globalThis.OfflineAudioContext(l.chanCount,u*l.rate/a,l.rate),r=g.createBufferSource(),v=g.createBuffer(o,u,a);return d.forEach((w,b)=>v.copyToChannel(w,b)),r.buffer=v,r.connect(g.destination),r.start(),Vt(yield g.startRendering())})}function Tt(d){return new Promise(a=>{const l=qe(()=>{l(),a()},d)})}function jt(d,a,l){const o=l-a,p=new Float32Array(o);let u=0;for(;u<o;)p[u]=d[(a+u)%d.length],u+=1;return p}function Xt(d,a){let l=!1;function o(){return T(this,null,function*(){const p=d.getReader();for(;!l;){const{value:u,done:g}=yield p.read();if(g){a.onDone();return}yield a.onChunk(u)}p.releaseLock(),yield d.cancel()})}return o().catch(z.error),()=>{l=!0}}function ke(d,a){let l;return function(...o){if(l==null||performance.now()-l>a)return l=performance.now(),d.apply(this,o)}}var O={};(function(d){var a=function(){var t=new Date,e=4,s=3,n=2,h=1,f=e,c={setLogLevel:function(_){_==this.debug?f=h:_==this.info?f=n:_==this.warn?f=s:(_==this.error,f=e)},debug:function(_,y){console.debug===void 0&&(console.debug=console.log),h>=f&&console.debug("["+a.getDurationString(new Date-t,1e3)+"]","["+_+"]",y)},log:function(_,y){this.debug(_.msg)},info:function(_,y){n>=f&&console.info("["+a.getDurationString(new Date-t,1e3)+"]","["+_+"]",y)},warn:function(_,y){s>=f&&console.warn("["+a.getDurationString(new Date-t,1e3)+"]","["+_+"]",y)},error:function(_,y){e>=f&&console.error("["+a.getDurationString(new Date-t,1e3)+"]","["+_+"]",y)}};return c}();a.getDurationString=function(t,e){var s;function n(S,U){for(var A=""+S,k=A.split(".");k[0].length<U;)k[0]="0"+k[0];return k.join(".")}t<0?(s=!0,t=-t):s=!1;var h=e||1,f=t/h,c=Math.floor(f/3600);f-=c*3600;var _=Math.floor(f/60);f-=_*60;var y=f*1e3;return f=Math.floor(f),y-=f*1e3,y=Math.floor(y),(s?"-":"")+c+":"+n(_,2)+":"+n(f,2)+"."+n(y,3)},a.printRanges=function(t){var e=t.length;if(e>0){for(var s="",n=0;n<e;n++)n>0&&(s+=","),s+="["+a.getDurationString(t.start(n))+","+a.getDurationString(t.end(n))+"]";return s}else return"(empty)"},d.Log=a;var l=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};l.prototype.getPosition=function(){return this.position},l.prototype.getEndPosition=function(){return this.buffer.byteLength},l.prototype.getLength=function(){return this.buffer.byteLength},l.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},l.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},l.prototype.readAnyInt=function(t,e){var s=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?s=this.dataview.getInt8(this.position):s=this.dataview.getUint8(this.position);break;case 2:e?s=this.dataview.getInt16(this.position):s=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";s=this.dataview.getUint8(this.position)<<16,s|=this.dataview.getUint8(this.position+1)<<8,s|=this.dataview.getUint8(this.position+2);break;case 4:e?s=this.dataview.getInt32(this.position):s=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";s=this.dataview.getUint32(this.position)<<32,s|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,s}else throw"Not enough bytes in buffer"},l.prototype.readUint8=function(){return this.readAnyInt(1,!1)},l.prototype.readUint16=function(){return this.readAnyInt(2,!1)},l.prototype.readUint24=function(){return this.readAnyInt(3,!1)},l.prototype.readUint32=function(){return this.readAnyInt(4,!1)},l.prototype.readUint64=function(){return this.readAnyInt(8,!1)},l.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",s=0;s<t;s++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},l.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},l.prototype.readInt8=function(){return this.readAnyInt(1,!0)},l.prototype.readInt16=function(){return this.readAnyInt(2,!0)},l.prototype.readInt32=function(){return this.readAnyInt(4,!0)},l.prototype.readInt64=function(){return this.readAnyInt(8,!1)},l.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),s=0;s<t;s++)e[s]=this.readUint8();return e},l.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),s=0;s<t;s++)e[s]=this.readInt16();return e},l.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),s=0;s<t;s++)e[s]=this.readUint16();return e},l.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),s=0;s<t;s++)e[s]=this.readUint32();return e},l.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),s=0;s<t;s++)e[s]=this.readInt32();return e},d.MP4BoxStream=l;var o=function(t,e,s){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=s!=null?s:o.LITTLE_ENDIAN};o.prototype={},o.prototype.getPosition=function(){return this.position},o.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,s=this._buffer.byteLength;if(e<=s){e>this._byteLength&&(this._byteLength=e);return}for(s<1&&(s=1);e>s;)s*=2;var n=new ArrayBuffer(s),h=new Uint8Array(this._buffer),f=new Uint8Array(n,0,h.length);f.set(h),this.buffer=n,this._byteLength=e}},o.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),s=new Uint8Array(this._buffer,0,e.length);e.set(s),this.buffer=t}},o.BIG_ENDIAN=!1,o.LITTLE_ENDIAN=!0,o.prototype._byteLength=0,Object.defineProperty(o.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(o.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(o.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),o.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},o.prototype.isEof=function(){return this.position>=this._byteLength},o.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},o.prototype.readInt32Array=function(t,e){t=t!=null?t:this.byteLength-this.position/4;var s=new Int32Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e!=null?e:this.endianness),this.position+=s.byteLength,s},o.prototype.readInt16Array=function(t,e){t=t!=null?t:this.byteLength-this.position/2;var s=new Int16Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e!=null?e:this.endianness),this.position+=s.byteLength,s},o.prototype.readInt8Array=function(t){t=t!=null?t:this.byteLength-this.position;var e=new Int8Array(t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readUint32Array=function(t,e){t=t!=null?t:this.byteLength-this.position/4;var s=new Uint32Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e!=null?e:this.endianness),this.position+=s.byteLength,s},o.prototype.readUint16Array=function(t,e){t=t!=null?t:this.byteLength-this.position/2;var s=new Uint16Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e!=null?e:this.endianness),this.position+=s.byteLength,s},o.prototype.readUint8Array=function(t){t=t!=null?t:this.byteLength-this.position;var e=new Uint8Array(t);return o.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},o.prototype.readFloat64Array=function(t,e){t=t!=null?t:this.byteLength-this.position/8;var s=new Float64Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e!=null?e:this.endianness),this.position+=s.byteLength,s},o.prototype.readFloat32Array=function(t,e){t=t!=null?t:this.byteLength-this.position/4;var s=new Float32Array(t);return o.memcpy(s.buffer,0,this.buffer,this.byteOffset+this.position,t*s.BYTES_PER_ELEMENT),o.arrayToNative(s,e!=null?e:this.endianness),this.position+=s.byteLength,s},o.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t!=null?t:this.endianness);return this.position+=4,e},o.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t!=null?t:this.endianness);return this.position+=2,e},o.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},o.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t!=null?t:this.endianness);return this.position+=4,e},o.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t!=null?t:this.endianness);return this.position+=2,e},o.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},o.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t!=null?t:this.endianness);return this.position+=4,e},o.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t!=null?t:this.endianness);return this.position+=8,e},o.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,o.memcpy=function(t,e,s,n,h){var f=new Uint8Array(t,e,h),c=new Uint8Array(s,n,h);f.set(c)},o.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},o.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},o.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s=0;s<t.byteLength;s+=t.BYTES_PER_ELEMENT)for(var n=s+t.BYTES_PER_ELEMENT-1,h=s;n>h;n--,h++){var f=e[h];e[h]=e[n],e[n]=f}return t},o.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],s=0;s<t.length;s++)e[s]=t[s];return String.fromCharCode.apply(null,e)},o.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t!=null?t:this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},o.prototype.readCString=function(t){var e=this.byteLength-this.position,s=new Uint8Array(this._buffer,this._byteOffset+this.position),n=e;t!=null&&(n=Math.min(t,e));for(var h=0;h<n&&s[h]!==0;h++);var f=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(h)]);return t!=null?this.position+=n-h:h!=e&&(this.position+=1),f};var p=Math.pow(2,32);o.prototype.readInt64=function(){return this.readInt32()*p+this.readUint32()},o.prototype.readUint64=function(){return this.readUint32()*p+this.readUint32()},o.prototype.readInt64=function(){return this.readUint32()*p+this.readUint32()},o.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},d.DataStream=o,o.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var s=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.setAttribute("href",s),n.setAttribute("download",t),n.setAttribute("target","_self"),n.click(),window.URL.revokeObjectURL(s)}else throw"DataStream.save: Can't create object URL."},o.prototype._dynamicSize=!0,Object.defineProperty(o.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),o.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),s=new Uint8Array(e),n=new Uint8Array(this._buffer,t,s.length);s.set(n),this.buffer=e,this.position-=t},o.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeInt32(t[s],e)},o.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeInt16(t[s],e)},o.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},o.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeUint32(t[s],e)},o.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeUint16(t[s],e)},o.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},o.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeFloat64(t[s],e)},o.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)o.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var s=0;s<t.length;s++)this.writeFloat32(t[s],e)},o.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e!=null?e:this.endianness),this.position+=4},o.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e!=null?e:this.endianness),this.position+=2},o.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},o.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e!=null?e:this.endianness),this.position+=4},o.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e!=null?e:this.endianness),this.position+=2},o.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},o.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e!=null?e:this.endianness),this.position+=4},o.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e!=null?e:this.endianness),this.position+=8},o.prototype.writeUCS2String=function(t,e,s){s==null&&(s=t.length);for(var n=0;n<t.length&&n<s;n++)this.writeUint16(t.charCodeAt(n),e);for(;n<s;n++)this.writeUint16(0)},o.prototype.writeString=function(t,e,s){var n=0;if(e==null||e=="ASCII")if(s!=null){var h=Math.min(t.length,s);for(n=0;n<h;n++)this.writeUint8(t.charCodeAt(n));for(;n<s;n++)this.writeUint8(0)}else for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,s)))},o.prototype.writeCString=function(t,e){var s=0;if(e!=null){var n=Math.min(t.length,e);for(s=0;s<n;s++)this.writeUint8(t.charCodeAt(s));for(;s<e;s++)this.writeUint8(0)}else{for(s=0;s<t.length;s++)this.writeUint8(t.charCodeAt(s));this.writeUint8(0)}},o.prototype.writeStruct=function(t,e){for(var s=0;s<t.length;s+=2){var n=t[s+1];this.writeType(n,e[t[s]],e)}},o.prototype.writeType=function(t,e,s){var n;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,s);var h=null,f="ASCII",c=this.position;switch(typeof t=="string"&&/:/.test(t)&&(n=t.split(":"),t=n[0],h=parseInt(n[1])),typeof t=="string"&&/,/.test(t)&&(n=t.split(","),t=n[0],f=parseInt(n[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,o.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,o.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,o.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,o.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,o.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,o.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,o.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,o.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,o.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,o.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,o.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,o.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,h);break;case"string":this.writeString(e,f,h);break;case"u16string":this.writeUCS2String(e,this.endianness,h);break;case"u16stringle":this.writeUCS2String(e,o.LITTLE_ENDIAN,h);break;case"u16stringbe":this.writeUCS2String(e,o.BIG_ENDIAN,h);break;default:if(t.length==3){for(var _=t[1],y=0;y<e.length;y++)this.writeType(_,e[y]);break}else{this.writeStruct(t,e);break}}h!=null&&(this.position=c,this._realloc(h),this.position=c+h)},o.prototype.writeUint64=function(t){var e=Math.floor(t/p);this.writeUint32(e),this.writeUint32(t&4294967295)},o.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},o.prototype.adjustUint32=function(t,e){var s=this.position;this.seek(t),this.writeUint32(e),this.seek(s)},o.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var s=new Int32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e!=null?e:this.endianness),this.position+=t*4,s},o.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var s=new Int16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e!=null?e:this.endianness),this.position+=t*2,s},o.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},o.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var s=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e!=null?e:this.endianness),this.position+=t*4,s},o.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var s=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e!=null?e:this.endianness),this.position+=t*2,s},o.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var s=new Float64Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e!=null?e:this.endianness),this.position+=t*8,s},o.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var s=new Float32Array(this._buffer,this.byteOffset+this.position,t);return o.arrayToNative(s,e!=null?e:this.endianness),this.position+=t*4,s};var u=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};u.prototype=new o(new ArrayBuffer,0,o.BIG_ENDIAN),u.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,a.debug("MultiBufferStream","Stream ready for parsing"),!0):(a.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(a.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){a.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var s=new Uint8Array(t.byteLength+e.byteLength);return s.set(new Uint8Array(t),0),s.set(new Uint8Array(e),t.byteLength),s.buffer},u.prototype.reduceBuffer=function(t,e,s){var n;return n=new Uint8Array(s),n.set(new Uint8Array(t,e,s)),n.buffer.fileStart=t.fileStart+e,n.buffer.usedBytes=0,n.buffer},u.prototype.insertBuffer=function(t){for(var e=!0,s=0;s<this.buffers.length;s++){var n=this.buffers[s];if(t.fileStart<=n.fileStart){if(t.fileStart===n.fileStart)if(t.byteLength>n.byteLength){this.buffers.splice(s,1),s--;continue}else a.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=n.fileStart||(t=this.reduceBuffer(t,0,n.fileStart-t.fileStart)),a.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(s,0,t),s===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<n.fileStart+n.byteLength){var h=n.fileStart+n.byteLength-t.fileStart,f=t.byteLength-h;if(f>0)t=this.reduceBuffer(t,h,f);else{e=!1;break}}}e&&(a.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),s===0&&(this.buffer=t))},u.prototype.logBufferLevel=function(t){var e,s,n,h,f=[],c,_="";for(n=0,h=0,e=0;e<this.buffers.length;e++)s=this.buffers[e],e===0?(c={},f.push(c),c.start=s.fileStart,c.end=s.fileStart+s.byteLength,_+="["+c.start+"-"):c.end===s.fileStart?c.end=s.fileStart+s.byteLength:(c={},c.start=s.fileStart,_+=f[f.length-1].end-1+"], ["+c.start+"-",c.end=s.fileStart+s.byteLength,f.push(c)),n+=s.usedBytes,h+=s.byteLength;f.length>0&&(_+=c.end-1+"]");var y=t?a.info:a.debug;this.buffers.length===0?y("MultiBufferStream","No more buffer in memory"):y("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+n+"/"+h+" bytes), continuous ranges: "+_)},u.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(a.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},u.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,s=this.buffer.usedBytes,n=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=s,this.buffer.fileStart=n,a.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},u.prototype.findPosition=function(t,e,s){var n,h=null,f=-1;for(t===!0?n=0:n=this.bufferIndex;n<this.buffers.length&&(h=this.buffers[n],h.fileStart<=e);)f=n,s&&(h.fileStart+h.byteLength<=e?h.usedBytes=h.byteLength:h.usedBytes=e-h.fileStart,this.logBufferLevel()),n++;return f!==-1?(h=this.buffers[f],h.fileStart+h.byteLength>=e?(a.debug("MultiBufferStream","Found position in existing buffer #"+f),f):-1):-1},u.prototype.findEndContiguousBuf=function(t){var e,s,n,h=t!==void 0?t:this.bufferIndex;if(s=this.buffers[h],this.buffers.length>h+1)for(e=h+1;e<this.buffers.length&&(n=this.buffers[e],n.fileStart===s.fileStart+s.byteLength);e++)s=n;return s.fileStart+s.byteLength},u.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},u.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},u.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},u.prototype.seek=function(t,e,s){var n;return n=this.findPosition(e,t,s),n!==-1?(this.buffer=this.buffers[n],this.bufferIndex=n,this.position=t-this.buffer.fileStart,a.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(a.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},u.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},u.prototype.getLength=function(){return this.byteLength},u.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},d.MultiBufferStream=u;var g=function(){var t=3,e=4,s=5,n=6,h=[];h[t]="ES_Descriptor",h[e]="DecoderConfigDescriptor",h[s]="DecoderSpecificInfo",h[n]="SLConfigDescriptor",this.getDescriptorName=function(_){return h[_]};var f=this,c={};return this.parseOneDescriptor=function(_){var y=0,S,U,A;for(S=_.readUint8(),A=_.readUint8();A&128;)y=(A&127)<<7,A=_.readUint8();return y+=A&127,a.debug("MPEG4DescriptorParser","Found "+(h[S]||"Descriptor "+S)+", size "+y+" at position "+_.getPosition()),h[S]?U=new c[h[S]](y):U=new c.Descriptor(y),U.parse(_),U},c.Descriptor=function(_,y){this.tag=_,this.size=y,this.descs=[]},c.Descriptor.prototype.parse=function(_){this.data=_.readUint8Array(this.size)},c.Descriptor.prototype.findDescriptor=function(_){for(var y=0;y<this.descs.length;y++)if(this.descs[y].tag==_)return this.descs[y];return null},c.Descriptor.prototype.parseRemainingDescriptors=function(_){for(var y=_.position;_.position<y+this.size;){var S=f.parseOneDescriptor(_);this.descs.push(S)}},c.ES_Descriptor=function(_){c.Descriptor.call(this,t,_)},c.ES_Descriptor.prototype=new c.Descriptor,c.ES_Descriptor.prototype.parse=function(_){if(this.ES_ID=_.readUint16(),this.flags=_.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=_.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var y=_.readUint8();this.URL=_.readString(y),this.size-=y+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=_.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(_)},c.ES_Descriptor.prototype.getOTI=function(_){var y=this.findDescriptor(e);return y?y.oti:0},c.ES_Descriptor.prototype.getAudioConfig=function(_){var y=this.findDescriptor(e);if(!y)return null;var S=y.findDescriptor(s);if(S&&S.data){var U=(S.data[0]&248)>>3;return U===31&&S.data.length>=2&&(U=32+((S.data[0]&7)<<3)+((S.data[1]&224)>>5)),U}else return null},c.DecoderConfigDescriptor=function(_){c.Descriptor.call(this,e,_)},c.DecoderConfigDescriptor.prototype=new c.Descriptor,c.DecoderConfigDescriptor.prototype.parse=function(_){this.oti=_.readUint8(),this.streamType=_.readUint8(),this.bufferSize=_.readUint24(),this.maxBitrate=_.readUint32(),this.avgBitrate=_.readUint32(),this.size-=13,this.parseRemainingDescriptors(_)},c.DecoderSpecificInfo=function(_){c.Descriptor.call(this,s,_)},c.DecoderSpecificInfo.prototype=new c.Descriptor,c.SLConfigDescriptor=function(_){c.Descriptor.call(this,n,_)},c.SLConfigDescriptor.prototype=new c.Descriptor,this};d.MPEG4DescriptorParser=g;var r={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){r.FullBox.prototype=new r.Box,r.ContainerBox.prototype=new r.Box,r.SampleEntry.prototype=new r.Box,r.TrackGroupTypeBox.prototype=new r.FullBox,r.BASIC_BOXES.forEach(function(t){r.createBoxCtor(t)}),r.FULL_BOXES.forEach(function(t){r.createFullBoxCtor(t)}),r.CONTAINER_BOXES.forEach(function(t){r.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,s){this.type=t,this.size=e,this.uuid=s},FullBox:function(t,e,s){r.Box.call(this,t,e,s),this.flags=0,this.version=0},ContainerBox:function(t,e,s){r.Box.call(this,t,e,s),this.boxes=[]},SampleEntry:function(t,e,s,n){r.ContainerBox.call(this,t,e),this.hdr_size=s,this.start=n},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){r.FullBox.call(this,t,e)},createBoxCtor:function(t,e){r.boxCodes.push(t),r[t+"Box"]=function(s){r.Box.call(this,t,s)},r[t+"Box"].prototype=new r.Box,e&&(r[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){r[t+"Box"]=function(s){r.FullBox.call(this,t,s)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(s){this.parseFullHeader(s),e&&e.call(this,s)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,s=0;s<e;s++)this[t[s]+"s"]=[]}},createContainerBoxCtor:function(t,e,s){r[t+"Box"]=function(n){r.ContainerBox.call(this,t,n),r.addSubBoxArrays.call(this,s)},r[t+"Box"].prototype=new r.ContainerBox,e&&(r[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,s){r.sampleEntryCodes[t]=[],r[t+"SampleEntry"]=function(n,h){r.SampleEntry.call(this,n,h),r.addSubBoxArrays.call(this,s)},r[t+"SampleEntry"].prototype=new r.SampleEntry,e&&(r[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,s,n){r.sampleEntryCodes[t].push(e),r[e+"SampleEntry"]=function(h){r[t+"SampleEntry"].call(this,e,h),r.addSubBoxArrays.call(this,n)},r[e+"SampleEntry"].prototype=new r[t+"SampleEntry"],s&&(r[e+"SampleEntry"].prototype.parse=s)},createEncryptedSampleEntryCtor:function(t,e,s){r.createSampleEntryCtor.call(this,t,e,s,["sinf"])},createSampleGroupCtor:function(t,e){r[t+"SampleGroupEntry"]=function(s){r.SampleGroupEntry.call(this,t,s)},r[t+"SampleGroupEntry"].prototype=new r.SampleGroupEntry,e&&(r[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){r[t+"TrackGroupTypeBox"]=function(s){r.TrackGroupTypeBox.call(this,t,s)},r[t+"TrackGroupTypeBox"].prototype=new r.TrackGroupTypeBox,e&&(r[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,s,n){r.UUIDs.push(t),r.UUIDBoxes[t]=function(h){e?r.FullBox.call(this,"uuid",h,t):s?r.ContainerBox.call(this,"uuid",h,t):r.Box.call(this,"uuid",h,t)},r.UUIDBoxes[t].prototype=e?new r.FullBox:s?new r.ContainerBox:new r.Box,n&&(e?r.UUIDBoxes[t].prototype.parse=function(h){this.parseFullHeader(h),n&&n.call(this,h)}:r.UUIDBoxes[t].prototype.parse=n)}};r.initialize(),r.TKHD_FLAG_ENABLED=1,r.TKHD_FLAG_IN_MOVIE=2,r.TKHD_FLAG_IN_PREVIEW=4,r.TFHD_FLAG_BASE_DATA_OFFSET=1,r.TFHD_FLAG_SAMPLE_DESC=2,r.TFHD_FLAG_SAMPLE_DUR=8,r.TFHD_FLAG_SAMPLE_SIZE=16,r.TFHD_FLAG_SAMPLE_FLAGS=32,r.TFHD_FLAG_DUR_EMPTY=65536,r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,r.TRUN_FLAGS_DATA_OFFSET=1,r.TRUN_FLAGS_FIRST_FLAG=4,r.TRUN_FLAGS_DURATION=256,r.TRUN_FLAGS_SIZE=512,r.TRUN_FLAGS_FLAGS=1024,r.TRUN_FLAGS_CTS_OFFSET=2048,r.Box.prototype.add=function(t){return this.addBox(new r[t+"Box"])},r.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},r.Box.prototype.set=function(t,e){return this[t]=e,this},r.Box.prototype.addEntry=function(t,e){var s=e||"entries";return this[s]||(this[s]=[]),this[s].push(t),this},d.BoxParser=r,r.parseUUID=function(t){return r.parseHex16(t)},r.parseHex16=function(t){for(var e="",s=0;s<16;s++){var n=t.readUint8().toString(16);e+=n.length===1?"0"+n:n}return e},r.parseOneBox=function(t,e,s){var n,h=t.getPosition(),f=0,c,_;if(t.getEndPosition()-h<8)return a.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:r.ERR_NOT_ENOUGH_DATA};if(s&&s<8)return a.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:r.ERR_NOT_ENOUGH_DATA};var y=t.readUint32(),S=t.readString(4),U=S;if(a.debug("BoxParser","Found box of type '"+S+"' and size "+y+" at position "+h),f=8,S=="uuid"){if(t.getEndPosition()-t.getPosition()<16||s-f<16)return t.seek(h),a.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:r.ERR_NOT_ENOUGH_DATA};_=r.parseUUID(t),f+=16,U=_}if(y==1){if(t.getEndPosition()-t.getPosition()<8||s&&s-f<8)return t.seek(h),a.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+S+'" box'),{code:r.ERR_NOT_ENOUGH_DATA};y=t.readUint64(),f+=8}else if(y===0){if(s)y=s;else if(S!=="mdat")return a.error("BoxParser","Unlimited box size not supported for type: '"+S+"'"),n=new r.Box(S,y),{code:r.OK,box:n,size:n.size}}return y!==0&&y<f?(a.error("BoxParser","Box of type "+S+" has an invalid size "+y+" (too small to be a box)"),{code:r.ERR_NOT_ENOUGH_DATA,type:S,size:y,hdr_size:f,start:h}):y!==0&&s&&y>s?(a.error("BoxParser","Box of type '"+S+"' has a size "+y+" greater than its container size "+s),{code:r.ERR_NOT_ENOUGH_DATA,type:S,size:y,hdr_size:f,start:h}):y!==0&&h+y>t.getEndPosition()?(t.seek(h),a.info("BoxParser","Not enough data in stream to parse the entire '"+S+"' box"),{code:r.ERR_NOT_ENOUGH_DATA,type:S,size:y,hdr_size:f,start:h}):e?{code:r.OK,type:S,size:y,hdr_size:f,start:h}:(r[S+"Box"]?n=new r[S+"Box"](y):S!=="uuid"?(a.warn("BoxParser","Unknown box type: '"+S+"'"),n=new r.Box(S,y),n.has_unparsed_data=!0):r.UUIDBoxes[_]?n=new r.UUIDBoxes[_](y):(a.warn("BoxParser","Unknown uuid type: '"+_+"'"),n=new r.Box(S,y),n.uuid=_,n.has_unparsed_data=!0),n.hdr_size=f,n.start=h,n.write===r.Box.prototype.write&&n.type!=="mdat"&&(a.info("BoxParser","'"+U+"' box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),c=t.getPosition()-(n.start+n.size),c<0?(a.warn("BoxParser","Parsing of box '"+U+"' did not read the entire indicated box data size (missing "+-c+" bytes), seeking forward"),t.seek(n.start+n.size)):c>0&&(a.error("BoxParser","Parsing of box '"+U+"' read "+c+" more bytes than the indicated box data size, seeking backwards"),n.size!==0&&t.seek(n.start+n.size)),{code:r.OK,box:n,size:n.size})},r.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},r.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},r.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},r.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},r.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},r.ContainerBox.prototype.parse=function(t){for(var e,s;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)if(s=e.box,this.boxes.push(s),this.subBoxNames&&this.subBoxNames.indexOf(s.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(s.type)]+"s"].push(s);else{var n=s.type!=="uuid"?s.type:s.uuid;this[n]?a.warn("Box of type "+n+" already stored in field of this type"):this[n]=s}else return},r.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},r.SAMPLE_ENTRY_TYPE_VISUAL="Visual",r.SAMPLE_ENTRY_TYPE_AUDIO="Audio",r.SAMPLE_ENTRY_TYPE_HINT="Hint",r.SAMPLE_ENTRY_TYPE_METADATA="Metadata",r.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",r.SAMPLE_ENTRY_TYPE_SYSTEM="System",r.SAMPLE_ENTRY_TYPE_TEXT="Text",r.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},r.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},r.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},r.SampleEntry.prototype.parseFooter=function(t){r.ContainerBox.prototype.parse.call(this,t)},r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_HINT),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),r.createMediaSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_TEXT,"enct"),r.createEncryptedSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"encm"),r.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,s=((e&1)+1)*16;this.layer_size=[];for(var n=0;n<3;n++)s==16?this.layer_size[n]=t.readUint16():this.layer_size[n]=t.readUint32()}),r.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),r.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),r.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){a.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){a.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){a.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){a.error("av1C reserved_2 parsing problem");return}var s=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(s)}),r.createBoxCtor("avcC",function(t){var e,s;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,s=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),s-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),s--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),s-=2+this.PPS[e].length;s>0&&(this.ext=t.readUint8Array(s))}),r.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),r.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),r.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),r.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),r.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),r.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),r.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),r.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint16(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),r.createFullBoxCtor("co64",function(t){var e,s;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(s=0;s<e;s++)this.chunk_offsets.push(t.readUint64())}),r.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),r.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),r.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),r.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),r.createFullBoxCtor("ctts",function(t){var e,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(s=0;s<e;s++){this.sample_counts.push(t.readUint32());var n=t.readInt32();n<0&&a.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(n)}else if(this.version==1)for(s=0;s<e;s++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),r.createBoxCtor("dac3",function(t){var e=t.readUint8(),s=t.readUint8(),n=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|s>>6&3,this.acmod=s>>3&7,this.lfeon=s>>2&1,this.bit_rate_code=s&3|n>>5&7}),r.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var s=0;s<this.num_ind_sub+1;s++){var n={};this.ind_subs.push(n);var h=t.readUint8(),f=t.readUint8(),c=t.readUint8();n.fscod=h>>6,n.bsid=h>>1&31,n.bsmod=(h&1)<<4|f>>4&15,n.acmod=f>>1&7,n.lfeon=f&1,n.num_dep_sub=c>>1&15,n.num_dep_sub>0&&(n.chan_loc=(c&1)<<8|t.readUint8())}}),r.createFullBoxCtor("dfLa",function(t){var e=127,s=128,n=[],h=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(t);do{var f=t.readUint8(),c=Math.min(f&e,h.length-1);if(c?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),n.push(h[c]),f&s)break}while(!0);this.numMetadataBlocks=n.length+" ("+n.join(", ")+")"}),r.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),r.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),r.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),r.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),r.createFullBoxCtor("dref",function(t){var e,s;this.entries=[];for(var n=t.readUint32(),h=0;h<n;h++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)s=e.box,this.entries.push(s);else return}),r.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var n={};this.entries.push(n),this.version===1?(n.segment_duration=t.readUint64(),n.media_time=t.readInt64()):(n.segment_duration=t.readUint32(),n.media_time=t.readInt32()),n.media_rate_integer=t.readInt16(),n.media_rate_fraction=t.readInt16()}}),r.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),r.createEntityToGroupCtor=function(t,e){r[t+"Box"]=function(s){r.FullBox.call(this,t,s)},r[t+"Box"].prototype=new r.FullBox,r[t+"Box"].prototype.parse=function(s){if(this.parseFullHeader(s),e)e.call(this,s);else for(this.group_id=s.readUint32(),this.num_entities_in_group=s.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var n=s.readUint32();this.entity_ids.push(n)}}},r.createEntityToGroupCtor("aebr"),r.createEntityToGroupCtor("afbr"),r.createEntityToGroupCtor("albc"),r.createEntityToGroupCtor("altr"),r.createEntityToGroupCtor("brst"),r.createEntityToGroupCtor("dobr"),r.createEntityToGroupCtor("eqiv"),r.createEntityToGroupCtor("favc"),r.createEntityToGroupCtor("fobr"),r.createEntityToGroupCtor("iaug"),r.createEntityToGroupCtor("pano"),r.createEntityToGroupCtor("slid"),r.createEntityToGroupCtor("ster"),r.createEntityToGroupCtor("tsyn"),r.createEntityToGroupCtor("wbbr"),r.createEntityToGroupCtor("prgr"),r.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof g<"u"){var s=new g;this.esd=s.parseOneDescriptor(new o(e.buffer,0,o.BIG_ENDIAN))}}),r.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),r.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),r.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var s=0;e>=4;)this.compatible_brands[s]=t.readString(4),e-=4,s++}),r.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),r.createBoxCtor("hvcC",function(t){var e,s,n,h;this.configurationVersion=t.readUint8(),h=t.readUint8(),this.general_profile_space=h>>6,this.general_tier_flag=(h&32)>>5,this.general_profile_idc=h&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),h=t.readUint8(),this.constantFrameRate=h>>6,this.numTemporalLayers=(h&13)>>3,this.temporalIdNested=(h&4)>>2,this.lengthSizeMinusOne=h&3,this.nalu_arrays=[];var f=t.readUint8();for(e=0;e<f;e++){var c=[];this.nalu_arrays.push(c),h=t.readUint8(),c.completeness=(h&128)>>7,c.nalu_type=h&63;var _=t.readUint16();for(s=0;s<_;s++){var y={};c.push(y),n=t.readUint16(),y.data=t.readUint8Array(n)}}}),r.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var s=0;s<this.entry_count;s++)if(e=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===r.OK)e.box.type!=="infe"&&a.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[s]=e.box;else return}),r.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var s=0;if(this.version<2)s=t.readUint16();else if(this.version===2)s=t.readUint32();else throw"version of iloc box not supported";for(var n=0;n<s;n++){var h={};if(this.items.push(h),this.version<2)h.item_ID=t.readUint16();else if(this.version===2)h.item_ID=t.readUint16();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?h.construction_method=t.readUint16()&15:h.construction_method=0,h.data_reference_index=t.readUint16(),this.base_offset_size){case 0:h.base_offset=0;break;case 4:h.base_offset=t.readUint32();break;case 8:h.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var f=t.readUint16();h.extents=[];for(var c=0;c<f;c++){var _={};if(h.extents.push(_),this.version===1||this.version===2)switch(this.index_size){case 0:_.extent_index=0;break;case 4:_.extent_index=t.readUint32();break;case 8:_.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:_.extent_offset=0;break;case 4:_.extent_offset=t.readUint32();break;case 8:_.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:_.extent_length=0;break;case 4:_.extent_length=t.readUint32();break;case 8:_.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),r.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),r.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),a.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),r.createFullBoxCtor("ipma",function(t){var e,s;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var n={};this.associations.push(n),this.version<1?n.id=t.readUint16():n.id=t.readUint32();var h=t.readUint8();for(n.props=[],s=0;s<h;s++){var f=t.readUint8(),c={};n.props.push(c),c.essential=(f&128)>>7===1,this.flags&1?c.property_index=(f&127)<<8|t.readUint8():c.property_index=f&127}}}),r.createFullBoxCtor("iref",function(t){var e,s;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)this.version===0?s=new r.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):s=new r.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),s.write===r.Box.prototype.write&&s.type!=="mdat"&&(a.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.references.push(s);else return}),r.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),r.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),r.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),r.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var s=0;s<e;s++){var n={};this.levels[s]=n,n.track_ID=t.readUint32();var h=t.readUint8();switch(n.padding_flag=h>>7,n.assignment_type=h&127,n.assignment_type){case 0:n.grouping_type=t.readString(4);break;case 1:n.grouping_type=t.readString(4),n.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:n.sub_track_id=t.readUint32();break;default:a.warn("BoxParser","Unknown leva assignement type")}}}),r.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),r.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()}),r.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),r.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),r.createFullBoxCtor("mehd",function(t){this.flags&1&&(a.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),r.createFullBoxCtor("meta",function(t){this.boxes=[],r.ContainerBox.prototype.parse.call(this,t)}),r.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),r.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),r.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),r.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),r.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),r.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var s=0;s<Math.floor((e+1)/2);s++)this.padbits=t.readUint8()}),r.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),r.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),r.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),r.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var s=0;s<e;s++)this.rate[s]=t.readUint32(),this.initial_delay[s]=t.readUint32()}),r.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),r.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),r.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),r.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),r.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),r.createFullBoxCtor("pssh",function(t){if(this.system_id=r.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var s=0;s<e;s++)this.kid[s]=r.parseHex16(t)}var n=t.readUint32();n>0&&(this.data=t.readUint8Array(n))}),r.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),r.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),r.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),r.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var s=0;s<e;s++)this.version===0?this.offset[s]=t.readUint32():this.offset[s]=t.readUint64()}),r.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var s=0;s<e;s++)this.sample_info_size[s]=t.readUint8()}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),r.createSampleEntryCtor(r.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),r.createSampleGroupCtor("alst",function(t){var e,s=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<s;e++)this.sample_offset[e]=t.readUint32();var n=this.description_length-4-4*s;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<n/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),r.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),r.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var s=t.readUint8(),n=0;n<s;n++){var h={};this.dependency.push(h),h.subSeqDirectionFlag=t.readUint8(),h.layerNumber=t.readUint8(),h.subSequenceIdentifier=t.readUint16()}}),r.createSampleGroupCtor("dtrt",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("mvif",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),r.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),r.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)a.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),r.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),r.SampleGroupEntry.prototype.parse=function(t){a.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},r.createSampleGroupCtor("scif",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("scnm",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=r.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),r.createSampleGroupCtor("stsa",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),r.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),r.createSampleGroupCtor("tsas",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("tscl",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createSampleGroupCtor("vipr",function(t){a.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),r.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var n={};this.entries.push(n),n.sample_count=t.readInt32(),n.group_description_index=t.readInt32()}}),r.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),r.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("sdtp",function(t){var e,s=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var n=0;n<s;n++)e=t.readUint8(),this.is_leading[n]=e>>6,this.sample_depends_on[n]=e>>4&3,this.sample_is_depended_on[n]=e>>2&3,this.sample_has_redundancy[n]=e&3}),r.createFullBoxCtor("senc"),r.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),a.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),s=0;s<e;s++){var n;r[this.grouping_type+"SampleGroupEntry"]?n=new r[this.grouping_type+"SampleGroupEntry"](this.grouping_type):n=new r.SampleGroupEntry(this.grouping_type),this.entries.push(n),this.version===1?this.default_length===0?n.description_length=t.readUint32():n.description_length=this.default_length:n.description_length=this.default_length,n.write===r.SampleGroupEntry.prototype.write&&(a.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),n.data=t.readUint8Array(n.description_length),t.position-=n.description_length),n.parse(t)}}),r.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),s=0;s<e;s++){var n={};this.references.push(n);var h=t.readUint32();n.reference_type=h>>31&1,n.referenced_size=h&2147483647,n.subsegment_duration=t.readUint32(),h=t.readUint32(),n.starts_with_SAP=h>>31&1,n.SAP_type=h>>28&7,n.SAP_delta_time=h&268435455}}),r.SingleItemTypeReferenceBox=function(t,e,s,n){r.Box.call(this,t,e),this.hdr_size=s,this.start=n},r.SingleItemTypeReferenceBox.prototype=new r.Box,r.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var s=0;s<e;s++)this.references[s]={},this.references[s].to_item_ID=t.readUint16()},r.SingleItemTypeReferenceBoxLarge=function(t,e,s,n){r.Box.call(this,t,e),this.hdr_size=s,this.start=n},r.SingleItemTypeReferenceBoxLarge.prototype=new r.Box,r.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var s=0;s<e;s++)this.references[s]={},this.references[s].to_item_ID=t.readUint32()},r.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),r.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),r.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),s=0;s<e;s++){var n={};this.subsegments.push(n),n.ranges=[];for(var h=t.readUint32(),f=0;f<h;f++){var c={};n.ranges.push(c),c.level=t.readUint8(),c.range_size=t.readUint24()}}}),r.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var s=0;s<e;s++)this.chunk_offsets.push(t.readUint32())}),r.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var s=0;s<e;s++)this.priority[s]=t.readUint16()}),r.createFullBoxCtor("sthd"),r.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var s=0;s<e;s++)this.attribute_list[s]=t.readUint32()}),r.createFullBoxCtor("stsc",function(t){var e,s;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(s=0;s<e;s++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),r.createFullBoxCtor("stsd",function(t){var e,s,n,h;for(this.entries=[],n=t.readUint32(),e=1;e<=n;e++)if(s=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),s.code===r.OK)r[s.type+"SampleEntry"]?(h=new r[s.type+"SampleEntry"](s.size),h.hdr_size=s.hdr_size,h.start=s.start):(a.warn("BoxParser","Unknown sample entry type: "+s.type),h=new r.SampleEntry(s.type,s.size,s.hdr_size,s.start)),h.write===r.SampleEntry.prototype.write&&(a.info("BoxParser","SampleEntry "+h.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),h.parseDataAndRewind(t)),h.parse(t),this.entries.push(h);else return}),r.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var s=0;s<e;s++)this.group_description_index[s]=t.readUint32()}),r.createFullBoxCtor("stsh",function(t){var e,s;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(s=0;s<e;s++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),r.createFullBoxCtor("stss",function(t){var e,s;if(s=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<s;e++)this.sample_numbers.push(t.readUint32())}),r.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),r.createFullBoxCtor("stts",function(t){var e,s,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(s=0;s<e;s++)this.sample_counts.push(t.readUint32()),n=t.readInt32(),n<0&&(a.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),n=1),this.sample_deltas.push(n)}),r.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var s=t.readUint32();this.stereo_indication_type=t.readString(s);var n,h;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(n=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),n.code===r.OK)h=n.box,this.boxes.push(h),this[h.type]=h;else return}),r.createBoxCtor("styp",function(t){r.ftypBox.prototype.parse.call(this,t)}),r.createFullBoxCtor("stz2",function(t){var e,s;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),s=t.readUint32(),this.field_size===4)for(e=0;e<s;e+=2){var n=t.readUint8();this.sample_sizes[e]=n>>4&15,this.sample_sizes[e+1]=n&15}else if(this.field_size===8)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<s;e++)this.sample_sizes[e]=t.readUint16();else a.error("BoxParser","Error in length field in stz2 box")}),r.createFullBoxCtor("subs",function(t){var e,s,n,h;for(n=t.readUint32(),this.entries=[],e=0;e<n;e++){var f={};if(this.entries[e]=f,f.sample_delta=t.readUint32(),f.subsamples=[],h=t.readUint16(),h>0)for(s=0;s<h;s++){var c={};f.subsamples.push(c),this.version==1?c.size=t.readUint32():c.size=t.readUint16(),c.priority=t.readUint8(),c.discardable=t.readUint8(),c.codec_specific_parameters=t.readUint32()}}}),r.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=r.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),r.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),r.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&r.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),r.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var s=t.readUint32(),n=0;n<s;n++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),r.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),r.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),r.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),r.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),r.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),r.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),r.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},r.createTrackGroupCtor("msrc"),r.TrackReferenceTypeBox=function(t,e,s,n){r.Box.call(this,t,e),this.hdr_size=s,this.start=n},r.TrackReferenceTypeBox.prototype=new r.Box,r.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},r.trefBox.prototype.parse=function(t){for(var e,s;t.getPosition()<this.start+this.size;)if(e=r.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===r.OK)s=new r.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),s.write===r.Box.prototype.write&&s.type!=="mdat"&&(a.info("BoxParser","TrackReference "+s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),this.boxes.push(s);else return},r.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=r.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===r.OK)box=ret.box,this.boxes.push(box);else return}),r.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),r.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),r.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&r.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var s=0;s<this.sample_count;s++)this.flags&r.TRUN_FLAGS_DURATION&&(this.sample_duration[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_SIZE&&(this.sample_size[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_FLAGS&&(this.sample_flags[s]=t.readUint32()),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[s]=t.readUint32():this.sample_composition_time_offset[s]=t.readInt32())}),r.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var s=0;s<e;s++)this.attribute_list[s]=t.readUint32()}),r.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),r.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var s=0;s<e;s++)this.compatible_brands[s]=t.readString(4)}),r.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),r.createFullBoxCtor("uncC",function(t){var e;for(this.profile=t.readUint32(),this.component_count=t.readUint16(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var s=t.readUint8();this.component_little_endian=s>>7&1,this.block_pad_lsb=s>>6&1,this.block_little_endian=s>>5&1,this.block_reversed=s>>4&1,this.pad_unknown=s>>3&1,this.pixel_size=t.readUint8(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}),r.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),r.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),r.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),r.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=r.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),r.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),r.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=r.parseHex16(t)}),r.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var s={},n=0,h=0;this.version===1?(n=t.readUint64(),h=t.readUint64()):(n=t.readUint32(),h=t.readUint32()),s.absolute_time=n,s.absolute_duration=h,this.entries.push(s)}}),r.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),r.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),r.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),r.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),r.createFullBoxCtor("vvcC",function(t){var e,s,n={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(x){this.held_bits=x.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(x){this.held_bits=x.readUint16(),this.num_held_bits=16},extract_bits:function(x){var L=this.held_bits>>this.num_held_bits-x&(1<<x)-1;return this.num_held_bits-=x,L}};if(n.stream_read_1_bytes(t),n.extract_bits(5),this.lengthSizeMinusOne=n.extract_bits(2),this.ptl_present_flag=n.extract_bits(1),this.ptl_present_flag){n.stream_read_2_bytes(t),this.ols_idx=n.extract_bits(9),this.num_sublayers=n.extract_bits(3),this.constant_frame_rate=n.extract_bits(2),this.chroma_format_idc=n.extract_bits(2),n.stream_read_1_bytes(t),this.bit_depth_minus8=n.extract_bits(3),n.extract_bits(5);{if(n.stream_read_2_bytes(t),n.extract_bits(2),this.num_bytes_constraint_info=n.extract_bits(6),this.general_profile_idc=n.extract_bits(7),this.general_tier_flag=n.extract_bits(1),this.general_level_idc=t.readUint8(),n.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=n.extract_bits(1),this.ptl_multilayer_enabled_flag=n.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var h=n.extract_bits(6);n.stream_read_1_bytes(t);var f=n.extract_bits(2);this.general_constraint_info[e]=h<<2|f}this.general_constraint_info[this.num_bytes_constraint_info-1]=n.extract_bits(6)}else n.extract_bits(6);if(this.num_sublayers>1){for(n.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,s=this.num_sublayers-2;s>=0;--s){var c=n.extract_bits(1);this.ptl_sublayer_present_mask|=c<<s}for(s=this.num_sublayers;s<=8&&this.num_sublayers>1;++s)n.extract_bits(1);for(this.sublayer_level_idc=[],s=this.num_sublayers-2;s>=0;--s)this.ptl_sublayer_present_mask&1<<s&&(this.sublayer_level_idc[s]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var _=12,y=13;this.nalu_arrays=[];var S=t.readUint8();for(e=0;e<S;e++){var U=[];this.nalu_arrays.push(U),n.stream_read_1_bytes(t),U.completeness=n.extract_bits(1),n.extract_bits(2),U.nalu_type=n.extract_bits(5);var A=1;for(U.nalu_type!=y&&U.nalu_type!=_&&(A=t.readUint16()),s=0;s<A;s++){var k=t.readUint16();U.push({data:t.readUint8Array(k),length:k})}}}),r.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),r.SampleEntry.prototype.isVideo=function(){return!1},r.SampleEntry.prototype.isAudio=function(){return!1},r.SampleEntry.prototype.isSubtitle=function(){return!1},r.SampleEntry.prototype.isMetadata=function(){return!1},r.SampleEntry.prototype.isHint=function(){return!1},r.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},r.SampleEntry.prototype.getWidth=function(){return""},r.SampleEntry.prototype.getHeight=function(){return""},r.SampleEntry.prototype.getChannelCount=function(){return""},r.SampleEntry.prototype.getSampleRate=function(){return""},r.SampleEntry.prototype.getSampleSize=function(){return""},r.VisualSampleEntry.prototype.isVideo=function(){return!0},r.VisualSampleEntry.prototype.getWidth=function(){return this.width},r.VisualSampleEntry.prototype.getHeight=function(){return this.height},r.AudioSampleEntry.prototype.isAudio=function(){return!0},r.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},r.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},r.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},r.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},r.MetadataSampleEntry.prototype.isMetadata=function(){return!0},r.decimalToHex=function(t,e){var s=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;s.length<e;)s="0"+s;return s},r.avc1SampleEntry.prototype.getCodec=r.avc2SampleEntry.prototype.getCodec=r.avc3SampleEntry.prototype.getCodec=r.avc4SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+r.decimalToHex(this.avcC.AVCProfileIndication)+r.decimalToHex(this.avcC.profile_compatibility)+r.decimalToHex(this.avcC.AVCLevelIndication):t},r.hev1SampleEntry.prototype.getCodec=r.hvc1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var s=this.hvcC.general_profile_compatibility,n=0;for(t=0;t<32&&(n|=s&1,t!=31);t++)n<<=1,s>>=1;e+=r.decimalToHex(n,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var h=!1,f="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||h)&&(f="."+r.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+f,h=!0);e+=f}return e},r.vvc1SampleEntry.prototype.getCodec=r.vvi1SampleEntry.prototype.getCodec=function(){var t,e=r.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var s="";if(this.vvcC.general_constraint_info){var n=[],h=0;h|=this.vvcC.ptl_frame_only_constraint<<7,h|=this.vvcC.ptl_multilayer_enabled<<6;var f;for(t=0;t<this.vvcC.general_constraint_info.length;++t)h|=this.vvcC.general_constraint_info[t]>>2&63,n.push(h),h&&(f=t),h=this.vvcC.general_constraint_info[t]>>2&3;if(f===void 0)s=".CA";else{s=".C";var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",_=0,y=0;for(t=0;t<=f;++t)for(_=_<<8|n[t],y+=8;y>=5;){var S=_>>y-5&31;s+=c[S],y-=5,_&=(1<<y)-1}y&&(_<<=5-y,s+=c[_&31])}}e+=s}return e},r.mp4aSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),s=this.esds.esd.getAudioConfig();return t+"."+r.decimalToHex(e)+(s?"."+s:"")}else return t},r.stxtSampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},r.vp08SampleEntry.prototype.getCodec=r.vp09SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var s=this.vpcC.bitDepth;return s==8&&(s="08"),t+".0"+this.vpcC.profile+"."+e+"."+s},r.av01SampleEntry.prototype.getCodec=function(){var t=r.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var s;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?s=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(s=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+s},r.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),a.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>p?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>p&&t.writeUint64(this.size)},r.FullBox.prototype.writeHeader=function(t){this.size+=4,r.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},r.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},r.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},r.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},r.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},r.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},r.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},r.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},r.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var s=this.entries[e];t.writeUint32(s.segment_duration),t.writeInt32(s.media_time),t.writeInt16(s.media_rate_integer),t.writeInt16(s.media_rate_fraction)}},r.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},r.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},r.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},r.hvcCBox.prototype.write=function(t){var e,s;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,s=0;s<this.nalu_arrays[e].length;s++)this.size+=2+this.nalu_arrays[e][s].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.general_profile_space<<6+this.general_tier_flag<<5+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),s=0;s<this.nalu_arrays[e].length;s++)t.writeUint16(this.nalu_arrays[e][s].data.length),t.writeUint8Array(this.nalu_arrays[e][s].data)},r.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},r.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},r.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},r.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},r.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},r.SampleEntry.prototype.writeHeader=function(t){this.size=8,r.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},r.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},r.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},r.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},r.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},r.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var s=this.entries[e];t.writeInt32(s.sample_count),t.writeInt32(s.group_description_index)}},r.sgpdBox.prototype.write=function(t){var e,s;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)s=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=s.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)s=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(s.description_length),s.write(t)},r.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var s=this.references[e];t.writeUint32(s.reference_type<<31|s.referenced_size),t.writeUint32(s.subsegment_duration),t.writeUint32(s.starts_with_SAP<<31|s.SAP_type<<28|s.SAP_delta_time)}},r.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},r.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},r.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},r.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;a.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},r.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},r.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},r.stszBox.prototype.write=function(t){var e,s=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){s=!1;break}else e++;else s=!1;this.size=8,s||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),s?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),s||t.writeUint32Array(this.sample_sizes)},r.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},r.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},r.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&r.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&r.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&r.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&r.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&r.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},r.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},r.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},r.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&r.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&r.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&r.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&r.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&r.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&r.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&r.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&r.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&r.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},r["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},r["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},r.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},r.cttsBox.prototype.unpack=function(t){var e,s,n;for(n=0,e=0;e<this.sample_counts.length;e++)for(s=0;s<this.sample_counts[e];s++)t[n].pts=t[n].dts+this.sample_offsets[e],n++},r.sttsBox.prototype.unpack=function(t){var e,s,n;for(n=0,e=0;e<this.sample_counts.length;e++)for(s=0;s<this.sample_counts[e];s++)n===0?t[n].dts=0:t[n].dts=t[n-1].dts+this.sample_deltas[e],n++},r.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},r.stscBox.prototype.unpack=function(t){var e,s,n,h,f;for(h=0,f=0,e=0;e<this.first_chunk.length;e++)for(s=0;s<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);s++)for(f++,n=0;n<this.samples_per_chunk[e];n++){if(t[h])t[h].description_index=this.sample_description_index[e],t[h].chunk_index=f;else return;h++}},r.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},r.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],r.boxEqualFields=function(t,e){if(t&&!e)return!1;var s;for(s in t)if(!(r.DIFF_BOXES_PROP_NAMES.indexOf(s)>-1)){if(t[s]instanceof r.Box||e[s]instanceof r.Box||typeof t[s]>"u"||typeof e[s]>"u"||typeof t[s]=="function"||typeof e[s]=="function"||t.subBoxNames&&t.subBoxNames.indexOf(s.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(s.slice(0,4))>-1||s==="data"||s==="start"||s==="size"||s==="creation_time"||s==="modification_time"||r.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(s)>-1)continue;if(t[s]!==e[s])return!1}return!0},r.boxEqual=function(t,e){if(!r.boxEqualFields(t,e))return!1;for(var s=0;s<r.DIFF_BOXES_PROP_NAMES.length;s++){var n=r.DIFF_BOXES_PROP_NAMES[s];if(t[n]&&e[n]&&!r.boxEqual(t[n],e[n]))return!1}return!0};var v=function(){};v.prototype.parseSample=function(t){var e={},s;e.resources=[];var n=new l(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=n.readString(t.data.length);else if(e.documentString=n.readString(t.subsamples[0].size),t.subsamples.length>1)for(s=1;s<t.subsamples.length;s++)e.resources[s]=n.readUint8Array(t.subsamples[s].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var w=function(){};w.prototype.parseSample=function(t){var e,s=new l(t.data.buffer);return e=s.readString(t.data.length),e},w.prototype.parseConfig=function(t){var e,s=new l(t.buffer);return s.readUint32(),e=s.readCString(),e},d.XMLSubtitlein4Parser=v,d.Textin4Parser=w;var b=function(t){this.stream=t||new u,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};b.prototype.setSegmentOptions=function(t,e,s){var n=this.getTrackById(t);if(n){var h={};this.fragmentedTracks.push(h),h.id=t,h.user=e,h.trak=n,n.nextSample=0,h.segmentStream=null,h.nb_samples=1e3,h.rapAlignement=!0,s&&(s.nbSamples&&(h.nb_samples=s.nbSamples),s.rapAlignement&&(h.rapAlignement=s.rapAlignement))}},b.prototype.unsetSegmentOptions=function(t){for(var e=-1,s=0;s<this.fragmentedTracks.length;s++){var n=this.fragmentedTracks[s];n.id==t&&(e=s)}e>-1&&this.fragmentedTracks.splice(e,1)},b.prototype.setExtractionOptions=function(t,e,s){var n=this.getTrackById(t);if(n){var h={};this.extractedTracks.push(h),h.id=t,h.user=e,h.trak=n,n.nextSample=0,h.nb_samples=1e3,h.samples=[],s&&s.nbSamples&&(h.nb_samples=s.nbSamples)}},b.prototype.unsetExtractionOptions=function(t){for(var e=-1,s=0;s<this.extractedTracks.length;s++){var n=this.extractedTracks[s];n.id==t&&(e=s)}e>-1&&this.extractedTracks.splice(e,1)},b.prototype.parse=function(){var t,e,s=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=r.parseOneBox(this.stream,s),t.code===r.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var n;switch(e=t.box,n=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),n){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[n]!==void 0&&a.warn("ISOFile","Duplicate Box of type: "+n+", overriding previous occurrence"),this[n]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},b.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(a.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(a.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(a.warn("ISOFile","Not ready to start parsing"),!1))},b.prototype.appendBuffer=function(t,e){var s;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(s=this.nextSeekPosition,this.nextSeekPosition=void 0):s=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(s=this.stream.getEndFilePositionAfter(s))):this.nextParsePosition?s=this.nextParsePosition:s=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(a.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+s),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),a.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),s},b.prototype.getInfo=function(){var t,e,s={},n,h,f,c,_=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(s.hasMoov=!0,s.duration=this.moov.mvhd.duration,s.timescale=this.moov.mvhd.timescale,s.isFragmented=this.moov.mvex!=null,s.isFragmented&&this.moov.mvex.mehd&&(s.fragment_duration=this.moov.mvex.mehd.fragment_duration),s.isProgressive=this.isProgressive,s.hasIOD=this.moov.iods!=null,s.brands=[],s.brands.push(this.ftyp.major_brand),s.brands=s.brands.concat(this.ftyp.compatible_brands),s.created=new Date(_+this.moov.mvhd.creation_time*1e3),s.modified=new Date(_+this.moov.mvhd.modification_time*1e3),s.tracks=[],s.audioTracks=[],s.videoTracks=[],s.subtitleTracks=[],s.metadataTracks=[],s.hintTracks=[],s.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(n=this.moov.traks[t],c=n.mdia.minf.stbl.stsd.entries[0],h={},s.tracks.push(h),h.id=n.tkhd.track_id,h.name=n.mdia.hdlr.name,h.references=[],n.tref)for(e=0;e<n.tref.boxes.length;e++)f={},h.references.push(f),f.type=n.tref.boxes[e].type,f.track_ids=n.tref.boxes[e].track_ids;n.edts&&(h.edits=n.edts.elst.entries),h.created=new Date(_+n.tkhd.creation_time*1e3),h.modified=new Date(_+n.tkhd.modification_time*1e3),h.movie_duration=n.tkhd.duration,h.movie_timescale=s.timescale,h.layer=n.tkhd.layer,h.alternate_group=n.tkhd.alternate_group,h.volume=n.tkhd.volume,h.matrix=n.tkhd.matrix,h.track_width=n.tkhd.width/65536,h.track_height=n.tkhd.height/65536,h.timescale=n.mdia.mdhd.timescale,h.cts_shift=n.mdia.minf.stbl.cslg,h.duration=n.mdia.mdhd.duration,h.samples_duration=n.samples_duration,h.codec=c.getCodec(),h.kind=n.udta&&n.udta.kinds.length?n.udta.kinds[0]:{schemeURI:"",value:""},h.language=n.mdia.elng?n.mdia.elng.extended_language:n.mdia.mdhd.languageString,h.nb_samples=n.samples.length,h.size=n.samples_size,h.bitrate=h.size*8*h.timescale/h.samples_duration,c.isAudio()?(h.type="audio",s.audioTracks.push(h),h.audio={},h.audio.sample_rate=c.getSampleRate(),h.audio.channel_count=c.getChannelCount(),h.audio.sample_size=c.getSampleSize()):c.isVideo()?(h.type="video",s.videoTracks.push(h),h.video={},h.video.width=c.getWidth(),h.video.height=c.getHeight()):c.isSubtitle()?(h.type="subtitles",s.subtitleTracks.push(h)):c.isHint()?(h.type="metadata",s.hintTracks.push(h)):c.isMetadata()?(h.type="metadata",s.metadataTracks.push(h)):(h.type="metadata",s.otherTracks.push(h))}else s.hasMoov=!1;if(s.mime="",s.hasMoov&&s.tracks){for(s.videoTracks&&s.videoTracks.length>0?s.mime+='video/mp4; codecs="':s.audioTracks&&s.audioTracks.length>0?s.mime+='audio/mp4; codecs="':s.mime+='application/mp4; codecs="',t=0;t<s.tracks.length;t++)t!==0&&(s.mime+=","),s.mime+=s.tracks[t].codec;s.mime+='"; profiles="',s.mime+=this.ftyp.compatible_brands.join(),s.mime+='"'}return s},b.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},b.prototype.processSamples=function(t){var e,s;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var n=this.fragmentedTracks[e];for(s=n.trak;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){a.debug("ISOFile","Creating media fragment on track #"+n.id+" for sample "+s.nextSample);var h=this.createFragment(n.id,s.nextSample,n.segmentStream);if(h)n.segmentStream=h,s.nextSample++;else break;if((s.nextSample%n.nb_samples===0||t||s.nextSample>=s.samples.length)&&(a.info("ISOFile","Sending fragmented data on track #"+n.id+" for samples ["+Math.max(0,s.nextSample-n.nb_samples)+","+(s.nextSample-1)+"]"),a.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(n.id,n.user,n.segmentStream.buffer,s.nextSample,t||s.nextSample>=s.samples.length),n.segmentStream=null,n!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var f=this.extractedTracks[e];for(s=f.trak;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){a.debug("ISOFile","Exporting on track #"+f.id+" sample #"+s.nextSample);var c=this.getSample(s,s.nextSample);if(c)s.nextSample++,f.samples.push(c);else{this.setNextSeekPositionFromSample(s.samples[s.nextSample]);break}if((s.nextSample%f.nb_samples===0||s.nextSample>=s.samples.length)&&(a.debug("ISOFile","Sending samples on track #"+f.id+" for sample "+s.nextSample),this.onSamples&&this.onSamples(f.id,f.user,f.samples),f.samples=[],f!==this.extractedTracks[e]))break}}}},b.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},b.prototype.getBoxes=function(t,e){var s=[];return b._sweep.call(this,t,s,e),s},b._sweep=function(t,e,s){this.type&&this.type==t&&e.push(this);for(var n in this.boxes){if(e.length&&s)return;b._sweep.call(this.boxes[n],t,e,s)}},b.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},b.prototype.getTrackSample=function(t,e){var s=this.getTrackById(t),n=this.getSample(s,e);return n},b.prototype.releaseUsedSamples=function(t,e){var s=0,n=this.getTrackById(t);n.lastValidSample||(n.lastValidSample=0);for(var h=n.lastValidSample;h<e;h++)s+=this.releaseSample(n,h);a.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+s+", remaining: "+this.samplesDataSize+")"),n.lastValidSample=e},b.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},b.prototype.stop=function(){this.sampleProcessingStarted=!1},b.prototype.flush=function(){a.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},b.prototype.seekTrack=function(t,e,s){var n,h,f=1/0,c=0,_=0,y;if(s.samples.length===0)return a.info("ISOFile","No sample in track, cannot seek! Using time "+a.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(n=0;n<s.samples.length;n++){if(h=s.samples[n],n===0)_=0,y=h.timescale;else if(h.cts>t*h.timescale){_=n-1;break}e&&h.is_sync&&(c=n)}for(e&&(_=c),t=s.samples[_].cts,s.nextSample=_;s.samples[_].alreadyRead===s.samples[_].size&&s.samples[_+1];)_++;return f=s.samples[_].offset+s.samples[_].alreadyRead,a.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+s.nextSample+" on track "+s.tkhd.track_id+", time "+a.getDurationString(t,y)+" and offset: "+f),{offset:f,time:t/y}},b.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},b.prototype.seek=function(t,e){var s=this.moov,n,h,f,c={offset:1/0,time:1/0};if(this.moov){for(f=0;f<s.traks.length;f++)n=s.traks[f],!(t>this.getTrackDuration(n))&&(h=this.seekTrack(t,e,n),h.offset<c.offset&&(c.offset=h.offset),h.time<c.time&&(c.time=h.time));return a.info("ISOFile","Seeking at time "+a.getDurationString(c.time,1)+" needs a buffer with a fileStart position of "+c.offset),c.offset===1/0?c={offset:this.nextParsePosition,time:0}:c.offset=this.stream.getEndFilePositionAfter(c.offset),a.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+c.offset),c}else throw"Cannot seek: moov not received!"},b.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var s=this.boxes[e],n=t.boxes[e];if(!r.boxEqual(s,n))return!1;e++}return!0},d.ISOFile=b,b.prototype.lastBoxStartPosition=0,b.prototype.parsingMdat=null,b.prototype.nextParsePosition=0,b.prototype.discardMdatData=!1,b.prototype.processIncompleteBox=function(t){var e,s,n;return t.type==="mdat"?(e=new r[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,n=this.stream.seek(e.start+e.size,!1,this.discardMdatData),n?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),s=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,s?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},b.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},b.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(a.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},b.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},b.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},b.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},b.prototype.add=r.Box.prototype.add,b.prototype.addBox=r.Box.prototype.addBox,b.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var s=this.add("moov");return s.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),s.add("mvex"),this},b.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var s=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,s.add("tkhd").set("flags",r.TKHD_FLAG_ENABLED|r.TKHD_FLAG_IN_MOVIE|r.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var n=s.add("mdia");n.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),n.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),n.add("elng").set("extended_language",e.language||"fr-FR");var h=n.add("minf");if(r[e.type+"SampleEntry"]!==void 0){var f=new r[e.type+"SampleEntry"];f.data_reference_index=1;var c="";for(var _ in r.sampleEntryCodes)for(var y=r.sampleEntryCodes[_],S=0;S<y.length;S++)if(y.indexOf(e.type)>-1){c=_;break}switch(c){case"Visual":if(h.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),f.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var U=new r.avcCBox;U.parse(new l(e.avcDecoderConfigRecord)),f.addBox(U)}else if(e.hevcDecoderConfigRecord){var A=new r.hvcCBox;A.parse(new l(e.hevcDecoderConfigRecord)),f.addBox(A)}break;case"Audio":h.add("smhd").set("balance",e.balance||0),f.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":h.add("hmhd");break;case"Subtitle":switch(h.add("sthd"),e.type){case"stpp":f.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":h.add("nmhd");break;case"System":h.add("nmhd");break;default:h.add("nmhd");break}e.description&&f.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(x){f.addBox(x)}),h.add("dinf").add("dref").addEntry(new r["url Box"]().set("flags",1));var k=h.add("stbl");return k.add("stsd").addEntry(f),k.add("stts").set("sample_counts",[]).set("sample_deltas",[]),k.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),k.add("stco").set("chunk_offsets",[]),k.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(s),e.id}},r.Box.prototype.computeSize=function(t){var e=t||new o;e.endianness=o.BIG_ENDIAN,this.write(e)},b.prototype.addSample=function(t,e,s){var n=s||{},h={},f=this.getTrackById(t);if(f!==null){h.number=f.samples.length,h.track_id=f.tkhd.track_id,h.timescale=f.mdia.mdhd.timescale,h.description_index=n.sample_description_index?n.sample_description_index-1:0,h.description=f.mdia.minf.stbl.stsd.entries[h.description_index],h.data=e,h.size=e.byteLength,h.alreadyRead=h.size,h.duration=n.duration||1,h.cts=n.cts||0,h.dts=n.dts||0,h.is_sync=n.is_sync||!1,h.is_leading=n.is_leading||0,h.depends_on=n.depends_on||0,h.is_depended_on=n.is_depended_on||0,h.has_redundancy=n.has_redundancy||0,h.degradation_priority=n.degradation_priority||0,h.offset=0,h.subsamples=n.subsamples,f.samples.push(h),f.samples_size+=h.size,f.samples_duration+=h.duration,f.first_dts===void 0&&(f.first_dts=n.dts),this.processSamples();var c=this.createSingleSampleMoof(h);return this.addBox(c),c.computeSize(),c.trafs[0].truns[0].data_offset=c.size+8,this.add("mdat").data=new Uint8Array(e),h}},b.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var s=new r.moofBox;s.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var n=s.add("traf"),h=this.getTrackById(t.track_id);return n.add("tfhd").set("track_id",t.track_id).set("flags",r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),n.add("tfdt").set("baseMediaDecodeTime",t.dts-(h.first_dts||0)),n.add("trun").set("flags",r.TRUN_FLAGS_DATA_OFFSET|r.TRUN_FLAGS_DURATION|r.TRUN_FLAGS_SIZE|r.TRUN_FLAGS_FLAGS|r.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),s},b.prototype.lastMoofIndex=0,b.prototype.samplesDataSize=0,b.prototype.resetTables=function(){var t,e,s,n,h,f,c,_;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,s=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,s.chunk_offsets=[],n=e.mdia.minf.stbl.stsc,n.first_chunk=[],n.samples_per_chunk=[],n.sample_description_index=[],h=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,h.sample_sizes=[],f=e.mdia.minf.stbl.stts,f.sample_counts=[],f.sample_deltas=[],c=e.mdia.minf.stbl.ctts,c&&(c.sample_counts=[],c.sample_offsets=[]),_=e.mdia.minf.stbl.stss;var y=e.mdia.minf.stbl.boxes.indexOf(_);y!=-1&&(e.mdia.minf.stbl.boxes[y]=null)}},b.initSampleGroups=function(t,e,s,n,h){var f,c,_,y;function S(U,A,k){this.grouping_type=U,this.grouping_type_parameter=A,this.sbgp=k,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),c=0;c<s.length;c++){for(y=s[c].grouping_type+"/"+s[c].grouping_type_parameter,_=new S(s[c].grouping_type,s[c].grouping_type_parameter,s[c]),e&&(e.sample_groups_info[y]=_),t.sample_groups_info[y]||(t.sample_groups_info[y]=_),f=0;f<n.length;f++)n[f].grouping_type===s[c].grouping_type&&(_.description=n[f],_.description.used=!0);if(h)for(f=0;f<h.length;f++)h[f].grouping_type===s[c].grouping_type&&(_.fragment_description=h[f],_.fragment_description.used=!0,_.is_fragment=!0)}if(e){if(h)for(c=0;c<h.length;c++)!h[c].used&&h[c].version>=2&&(y=h[c].grouping_type+"/0",_=new S(h[c].grouping_type,0),_.is_fragment=!0,e.sample_groups_info[y]||(e.sample_groups_info[y]=_))}else for(c=0;c<n.length;c++)!n[c].used&&n[c].version>=2&&(y=n[c].grouping_type+"/0",_=new S(n[c].grouping_type,0),t.sample_groups_info[y]||(t.sample_groups_info[y]=_))},b.setSampleGroupProperties=function(t,e,s,n){var h,f;e.sample_groups=[];for(h in n)if(e.sample_groups[h]={},e.sample_groups[h].grouping_type=n[h].grouping_type,e.sample_groups[h].grouping_type_parameter=n[h].grouping_type_parameter,s>=n[h].last_sample_in_run&&(n[h].last_sample_in_run<0&&(n[h].last_sample_in_run=0),n[h].entry_index++,n[h].entry_index<=n[h].sbgp.entries.length-1&&(n[h].last_sample_in_run+=n[h].sbgp.entries[n[h].entry_index].sample_count)),n[h].entry_index<=n[h].sbgp.entries.length-1?e.sample_groups[h].group_description_index=n[h].sbgp.entries[n[h].entry_index].group_description_index:e.sample_groups[h].group_description_index=-1,e.sample_groups[h].group_description_index!==0){var c;n[h].fragment_description?c=n[h].fragment_description:c=n[h].description,e.sample_groups[h].group_description_index>0?(e.sample_groups[h].group_description_index>65535?f=(e.sample_groups[h].group_description_index>>16)-1:f=e.sample_groups[h].group_description_index-1,c&&f>=0&&(e.sample_groups[h].description=c.entries[f])):c&&c.version>=2&&c.default_group_description_index>0&&(e.sample_groups[h].description=c.entries[c.default_group_description_index-1])}},b.process_sdtp=function(t,e,s){e&&(t?(e.is_leading=t.is_leading[s],e.depends_on=t.sample_depends_on[s],e.is_depended_on=t.sample_is_depended_on[s],e.has_redundancy=t.sample_has_redundancy[s]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},b.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},b.prototype.buildTrakSampleLists=function(t){var e,s,n,h,f,c,_,y,S,U,A,k,x,L,M,xt,Ot,_t,X,ht,re,we,lt,Gt;if(t.samples=[],t.samples_duration=0,t.samples_size=0,s=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,n=t.mdia.minf.stbl.stsc,h=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,f=t.mdia.minf.stbl.stts,c=t.mdia.minf.stbl.ctts,_=t.mdia.minf.stbl.stss,y=t.mdia.minf.stbl.stsd,S=t.mdia.minf.stbl.subs,k=t.mdia.minf.stbl.stdp,U=t.mdia.minf.stbl.sbgps,A=t.mdia.minf.stbl.sgpds,_t=-1,X=-1,ht=-1,re=-1,we=0,lt=0,Gt=0,b.initSampleGroups(t,null,U,A),!(typeof h>"u")){for(e=0;e<h.sample_sizes.length;e++){var I={};I.number=e,I.track_id=t.tkhd.track_id,I.timescale=t.mdia.mdhd.timescale,I.alreadyRead=0,t.samples[e]=I,I.size=h.sample_sizes[e],t.samples_size+=I.size,e===0?(L=1,x=0,I.chunk_index=L,I.chunk_run_index=x,Ot=n.samples_per_chunk[x],xt=0,x+1<n.first_chunk.length?M=n.first_chunk[x+1]-1:M=1/0):e<Ot?(I.chunk_index=L,I.chunk_run_index=x):(L++,I.chunk_index=L,xt=0,L<=M||(x++,x+1<n.first_chunk.length?M=n.first_chunk[x+1]-1:M=1/0),I.chunk_run_index=x,Ot+=n.samples_per_chunk[x]),I.description_index=n.sample_description_index[I.chunk_run_index]-1,I.description=y.entries[I.description_index],I.offset=s.chunk_offsets[I.chunk_index-1]+xt,xt+=I.size,e>_t&&(X++,_t<0&&(_t=0),_t+=f.sample_counts[X]),e>0?(t.samples[e-1].duration=f.sample_deltas[X],t.samples_duration+=t.samples[e-1].duration,I.dts=t.samples[e-1].dts+t.samples[e-1].duration):I.dts=0,c?(e>=ht&&(re++,ht<0&&(ht=0),ht+=c.sample_counts[re]),I.cts=t.samples[e].dts+c.sample_offsets[re]):I.cts=I.dts,_?(e==_.sample_numbers[we]-1?(I.is_sync=!0,we++):(I.is_sync=!1,I.degradation_priority=0),S&&S.entries[lt].sample_delta+Gt==e+1&&(I.subsamples=S.entries[lt].subsamples,Gt+=S.entries[lt].sample_delta,lt++)):I.is_sync=!0,b.process_sdtp(t.mdia.minf.stbl.sdtp,I,I.number),k?I.degradation_priority=k.priority[e]:I.degradation_priority=0,S&&S.entries[lt].sample_delta+Gt==e&&(I.subsamples=S.entries[lt].subsamples,Gt+=S.entries[lt].sample_delta),(U.length>0||A.length>0)&&b.setSampleGroupProperties(t,I,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},b.prototype.updateSampleLists=function(){var t,e,s,n,h,f,c,_,y,S,U,A,k,x,L;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(y=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,y.type=="moof")for(S=y,t=0;t<S.trafs.length;t++){for(U=S.trafs[t],A=this.getTrackById(U.tfhd.track_id),k=this.getTrexById(U.tfhd.track_id),U.tfhd.flags&r.TFHD_FLAG_SAMPLE_DESC?n=U.tfhd.default_sample_description_index:n=k?k.default_sample_description_index:1,U.tfhd.flags&r.TFHD_FLAG_SAMPLE_DUR?h=U.tfhd.default_sample_duration:h=k?k.default_sample_duration:0,U.tfhd.flags&r.TFHD_FLAG_SAMPLE_SIZE?f=U.tfhd.default_sample_size:f=k?k.default_sample_size:0,U.tfhd.flags&r.TFHD_FLAG_SAMPLE_FLAGS?c=U.tfhd.default_sample_flags:c=k?k.default_sample_flags:0,U.sample_number=0,U.sbgps.length>0&&b.initSampleGroups(A,U,U.sbgps,A.mdia.minf.stbl.sgpds,U.sgpds),e=0;e<U.truns.length;e++){var M=U.truns[e];for(s=0;s<M.sample_count;s++){x={},x.moof_number=this.lastMoofIndex,x.number_in_traf=U.sample_number,U.sample_number++,x.number=A.samples.length,U.first_sample_index=A.samples.length,A.samples.push(x),x.track_id=A.tkhd.track_id,x.timescale=A.mdia.mdhd.timescale,x.description_index=n-1,x.description=A.mdia.minf.stbl.stsd.entries[x.description_index],x.size=f,M.flags&r.TRUN_FLAGS_SIZE&&(x.size=M.sample_size[s]),A.samples_size+=x.size,x.duration=h,M.flags&r.TRUN_FLAGS_DURATION&&(x.duration=M.sample_duration[s]),A.samples_duration+=x.duration,A.first_traf_merged||s>0?x.dts=A.samples[A.samples.length-2].dts+A.samples[A.samples.length-2].duration:(U.tfdt?x.dts=U.tfdt.baseMediaDecodeTime:x.dts=0,A.first_traf_merged=!0),x.cts=x.dts,M.flags&r.TRUN_FLAGS_CTS_OFFSET&&(x.cts=x.dts+M.sample_composition_time_offset[s]),L=c,M.flags&r.TRUN_FLAGS_FLAGS?L=M.sample_flags[s]:s===0&&M.flags&r.TRUN_FLAGS_FIRST_FLAG&&(L=M.first_sample_flags),x.is_sync=!(L>>16&1),x.is_leading=L>>26&3,x.depends_on=L>>24&3,x.is_depended_on=L>>22&3,x.has_redundancy=L>>20&3,x.degradation_priority=L&65535;var xt=!!(U.tfhd.flags&r.TFHD_FLAG_BASE_DATA_OFFSET),Ot=!!(U.tfhd.flags&r.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),_t=!!(M.flags&r.TRUN_FLAGS_DATA_OFFSET),X=0;xt?X=U.tfhd.base_data_offset:Ot||e===0?X=S.start:X=_,e===0&&s===0?_t?x.offset=X+M.data_offset:x.offset=X:x.offset=_,_=x.offset+x.size,(U.sbgps.length>0||U.sgpds.length>0||A.mdia.minf.stbl.sbgps.length>0||A.mdia.minf.stbl.sgpds.length>0)&&b.setSampleGroupProperties(A,x,x.number_in_traf,U.sample_groups_info)}}if(U.subs){A.has_fragment_subsamples=!0;var ht=U.first_sample_index;for(e=0;e<U.subs.entries.length;e++)ht+=U.subs.entries[e].sample_delta,x=A.samples[ht-1],x.subsamples=U.subs.entries[e].subsamples}}}},b.prototype.getSample=function(t,e){var s,n=t.samples[e];if(!this.moov)return null;if(!n.data)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.samplesDataSize+=n.size,a.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+n.size+" (total: "+this.samplesDataSize+")");else if(n.alreadyRead==n.size)return n;for(;;){var h=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(h>-1){s=this.stream.buffers[h];var f=s.byteLength-(n.offset+n.alreadyRead-s.fileStart);if(n.size-n.alreadyRead<=f)return a.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-s.fileStart)+" read size: "+(n.size-n.alreadyRead)+" full size: "+n.size+")"),o.memcpy(n.data.buffer,n.alreadyRead,s,n.offset+n.alreadyRead-s.fileStart,n.size-n.alreadyRead),s.usedBytes+=n.size-n.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead=n.size,n;if(f===0)return null;a.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-s.fileStart)+" read size: "+f+" full size: "+n.size+")"),o.memcpy(n.data.buffer,n.alreadyRead,s,n.offset+n.alreadyRead-s.fileStart,f),n.alreadyRead+=f,s.usedBytes+=f,this.stream.logBufferLevel()}else return null}},b.prototype.releaseSample=function(t,e){var s=t.samples[e];return s.data?(this.samplesDataSize-=s.size,s.data=null,s.alreadyRead=0,s.size):0},b.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},b.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var s=this.moov.traks[t];t>0&&(e+=","),e+=s.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},b.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var s=this.moov.mvex.trexs[e];if(s.track_id==t)return s}return null},b.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var s=this.moov.traks[e];if(s.tkhd.track_id==t)return s}return null},b.prototype.items=[],b.prototype.itemsDataSize=0,b.prototype.flattenItemInfo=function(){var t=this.items,e,s,n,h=this.meta;if(h!=null&&h.hdlr!==void 0&&h.iinf!==void 0){for(e=0;e<h.iinf.item_infos.length;e++)n={},n.id=h.iinf.item_infos[e].item_ID,t[n.id]=n,n.ref_to=[],n.name=h.iinf.item_infos[e].item_name,h.iinf.item_infos[e].protection_index>0&&(n.protection=h.ipro.protections[h.iinf.item_infos[e].protection_index-1]),h.iinf.item_infos[e].item_type?n.type=h.iinf.item_infos[e].item_type:n.type="mime",n.content_type=h.iinf.item_infos[e].content_type,n.content_encoding=h.iinf.item_infos[e].content_encoding;if(h.iloc)for(e=0;e<h.iloc.items.length;e++){var f=h.iloc.items[e];switch(n=t[f.item_ID],f.data_reference_index!==0&&(a.warn("Item storage with reference to other files: not supported"),n.source=h.dinf.boxes[f.data_reference_index-1]),f.construction_method){case 0:break;case 1:a.warn("Item storage with construction_method : not supported");break;case 2:a.warn("Item storage with construction_method : not supported");break}for(n.extents=[],n.size=0,s=0;s<f.extents.length;s++)n.extents[s]={},n.extents[s].offset=f.extents[s].extent_offset+f.base_offset,n.extents[s].length=f.extents[s].extent_length,n.extents[s].alreadyRead=0,n.size+=n.extents[s].length}if(h.pitm&&(t[h.pitm.item_id].primary=!0),h.iref)for(e=0;e<h.iref.references.length;e++){var c=h.iref.references[e];for(s=0;s<c.references.length;s++)t[c.from_item_ID].ref_to.push({type:c.type,id:c.references[s]})}if(h.iprp)for(var _=0;_<h.iprp.ipmas.length;_++){var y=h.iprp.ipmas[_];for(e=0;e<y.associations.length;e++){var S=y.associations[e];for(n=t[S.id],n.properties===void 0&&(n.properties={},n.properties.boxes=[]),s=0;s<S.props.length;s++){var U=S.props[s];if(U.property_index>0&&U.property_index-1<h.iprp.ipco.boxes.length){var A=h.iprp.ipco.boxes[U.property_index-1];n.properties[A.type]=A,n.properties.boxes.push(A)}}}}}},b.prototype.getItem=function(t){var e,s;if(!this.meta)return null;if(s=this.items[t],!s.data&&s.size)s.data=new Uint8Array(s.size),s.alreadyRead=0,this.itemsDataSize+=s.size,a.debug("ISOFile","Allocating item #"+t+" of size "+s.size+" (total: "+this.itemsDataSize+")");else if(s.alreadyRead===s.size)return s;for(var n=0;n<s.extents.length;n++){var h=s.extents[n];if(h.alreadyRead!==h.length){var f=this.stream.findPosition(!0,h.offset+h.alreadyRead,!1);if(f>-1){e=this.stream.buffers[f];var c=e.byteLength-(h.offset+h.alreadyRead-e.fileStart);if(h.length-h.alreadyRead<=c)a.debug("ISOFile","Getting item #"+t+" extent #"+n+" data (alreadyRead: "+h.alreadyRead+" offset: "+(h.offset+h.alreadyRead-e.fileStart)+" read size: "+(h.length-h.alreadyRead)+" full extent size: "+h.length+" full item size: "+s.size+")"),o.memcpy(s.data.buffer,s.alreadyRead,e,h.offset+h.alreadyRead-e.fileStart,h.length-h.alreadyRead),e.usedBytes+=h.length-h.alreadyRead,this.stream.logBufferLevel(),s.alreadyRead+=h.length-h.alreadyRead,h.alreadyRead=h.length;else return a.debug("ISOFile","Getting item #"+t+" extent #"+n+" partial data (alreadyRead: "+h.alreadyRead+" offset: "+(h.offset+h.alreadyRead-e.fileStart)+" read size: "+c+" full extent size: "+h.length+" full item size: "+s.size+")"),o.memcpy(s.data.buffer,s.alreadyRead,e,h.offset+h.alreadyRead-e.fileStart,c),h.alreadyRead+=c,s.alreadyRead+=c,e.usedBytes+=c,this.stream.logBufferLevel(),null}else return null}}return s.alreadyRead===s.size?s:null},b.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var s=0;s<e.extents.length;s++){var n=e.extents[s];n.alreadyRead=0}return e.size}else return 0},b.prototype.processItems=function(t){for(var e in this.items){var s=this.items[e];this.getItem(s.id),t&&!s.sent&&(t(s),s.sent=!0,s.data=null)}},b.prototype.hasItem=function(t){for(var e in this.items){var s=this.items[e];if(s.name===t)return s.id}return-1},b.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},b.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},b.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},s=null;if(e.itemId?s=this.getItem(e.itemId):s=this.getPrimaryItem(),s==null)return null;var n=new b;n.discardMdatData=!1;var h={type:s.type,description_boxes:s.properties.boxes};s.properties.ispe&&(h.width=s.properties.ispe.image_width,h.height=s.properties.ispe.image_height);var f=n.addTrack(h);return f?(n.addSample(f,s.data),n):null},b.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},b.prototype.createFragment=function(t,e,s){var n=this.getTrackById(t),h=this.getSample(n,e);if(h==null)return this.setNextSeekPositionFromSample(n.samples[e]),null;var f=s||new o;f.endianness=o.BIG_ENDIAN;var c=this.createSingleSampleMoof(h);c.write(f),c.trafs[0].truns[0].data_offset=c.size+8,a.debug("MP4Box","Adjusting data_offset with new value "+c.trafs[0].truns[0].data_offset),f.adjustUint32(c.trafs[0].truns[0].data_offset_position,c.trafs[0].truns[0].data_offset);var _=new r.mdatBox;return _.data=h.data,_.write(f),f},b.writeInitializationSegment=function(t,e,s,n){var h;a.debug("ISOFile","Generating initialization segment");var f=new o;f.endianness=o.BIG_ENDIAN,t.write(f);var c=e.add("mvex");for(s&&c.add("mehd").set("fragment_duration",s),h=0;h<e.traks.length;h++)c.add("trex").set("track_id",e.traks[h].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",n).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(f),f.buffer},b.prototype.save=function(t){var e=new o;e.endianness=o.BIG_ENDIAN,this.write(e),e.save(t)},b.prototype.getBuffer=function(){var t=new o;return t.endianness=o.BIG_ENDIAN,this.write(t),t.buffer},b.prototype.initializeSegmentation=function(){var t,e,s,n;for(this.onSegment===null&&a.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var h=new r.moovBox;h.mvhd=this.moov.mvhd,h.boxes.push(h.mvhd),s=this.getTrackById(this.fragmentedTracks[t].id),h.boxes.push(s),h.traks.push(s),n={},n.id=s.tkhd.track_id,n.user=this.fragmentedTracks[t].user,n.buffer=b.writeInitializationSegment(this.ftyp,h,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(n)}return e},r.Box.prototype.printHeader=function(t){this.size+=8,this.size>p&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},r.FullBox.prototype.printHeader=function(t){this.size+=4,r.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},r.Box.prototype.print=function(t){this.printHeader(t)},r.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var s=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=s}},b.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},r.mvhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},r.tkhdBox.prototype.print=function(t){r.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var B={};B.createFile=function(t,e){var s=t!==void 0?t:!0,n=new b(e);return n.discardMdatData=!s,n},d.createFile=B.createFile})(O);const P={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};let oi=0;var It,W,gt,yt,pt,tt,j,K,kt,qt,zt,de,Ft,Kt,Zt,pe;class hi{constructor(a,l={}){E(this,Ft),E(this,Zt),E(this,It,z.create(`id:${oi++},`)),E(this,W,[]),E(this,gt,0),F(this,"ready"),E(this,yt,!1),E(this,pt,!1),E(this,tt,{duration:0,width:0,height:0,audioSampleRate:P.sampleRate,audioChanCount:P.channelCount}),E(this,j,new Float32Array(0)),E(this,K,new Float32Array(0)),E(this,kt,1),E(this,qt,!1),E(this,zt,null),E(this,de,(()=>{const o=li(p=>{var u;if(p instanceof Error)throw p;C(this,j,dt([m(this,j),p[0]])),C(this,K,dt([m(this,K),(u=p[1])!=null?u:p[0]]))});return p=>{var g;const u=Yt(p);if(m(this,kt)!==1)for(const r of u)for(let v=0;v<r.length;v++)r[v]*=m(this,kt);p.sampleRate!==P.sampleRate?o(()=>Ie(u,p.sampleRate,{rate:P.sampleRate,chanCount:P.channelCount})):(C(this,j,dt([m(this,j),u[0]])),C(this,K,dt([m(this,K),(g=u[1])!=null?g:u[0]]))),p.close()}})()),F(this,"tickInterceptor",(o,p)=>T(this,null,function*(){return p})),this.ready=new Promise(o=>{var u,g;let p=null;C(this,kt,typeof l.audio=="object"&&"volume"in l.audio?l.audio.volume:1),C(this,zt,De(a,{audio:l.audio!==!1,start:((u=l.start)!=null?u:0)*1e6,end:((g=l.end)!=null?g:1/0)*1e6},{onReady:r=>{l.audio!==!1&&C(this,qt,r.audioTracks.length>0);const v=r.videoTracks[0];C(this,tt,{duration:0,width:v.track_width,height:v.track_height,audioSampleRate:P.sampleRate,audioChanCount:P.channelCount}),m(this,It).info("MP4Clip info:",r),o({width:v.track_width,height:v.track_height,duration:v.duration===0?-1:v.duration/v.timescale*1e6})},onVideoOutput:r=>{var v;m(this,W).push(r),p=r,m(this,tt).duration=Math.max(m(this,tt).duration,r.timestamp+((v=r.duration)!=null?v:0))},onAudioOutput:m(this,de),onComplete:()=>{if(C(this,pt,!0),m(this,It).info("MP4Clip decode complete"),p==null)throw Error("mp4 parse error, no video frame")}}))})}tick(a){return T(this,null,function*(){if(a<m(this,gt))throw Error("time not allow rollback");if(m(this,pt)&&a>=m(this,tt).duration)return yield this.tickInterceptor(a,{audio:[],state:"done"});const l=m(this,qt)?yield q(this,Zt,pe).call(this,a-m(this,gt)):[],o=yield q(this,Ft,Kt).call(this,a);return C(this,gt,a),o==null?yield this.tickInterceptor(a,{audio:l,state:"success"}):yield this.tickInterceptor(a,{video:o,audio:l,state:"success"})})}destroy(){var a;m(this,yt)||(m(this,It).info("MP4Clip destroy, ts:",m(this,gt),", remainder frame count:",m(this,W).length,", decodeEnded:",m(this,pt)),C(this,yt,!0),(a=m(this,zt))==null||a.stop(),C(this,zt,null),m(this,W).forEach(l=>l.close()),C(this,W,[]))}}It=new WeakMap,W=new WeakMap,gt=new WeakMap,yt=new WeakMap,pt=new WeakMap,tt=new WeakMap,j=new WeakMap,K=new WeakMap,kt=new WeakMap,qt=new WeakMap,zt=new WeakMap,de=new WeakMap,Ft=new WeakSet,Kt=function(d){return T(this,null,function*(){var o;var a;if(m(this,W).length===0)return m(this,yt)||m(this,pt)?null:(yield Tt(50),q(this,Ft,Kt).call(this,d));const l=m(this,W)[0];return d<l.timestamp?null:d>l.timestamp+((o=l.duration)!=null?o:0)?((a=m(this,W).shift())==null||a.close(),q(this,Ft,Kt).call(this,d)):(m(this,W).shift(),l)})},Zt=new WeakSet,pe=function(d){return T(this,null,function*(){const a=Math.ceil(d*(m(this,tt).audioSampleRate/1e6));if(a===0)return[];if(!m(this,pt)&&!m(this,yt)&&m(this,j).length<a)return yield Tt(50),q(this,Zt,pe).call(this,d);const l=[m(this,j).slice(0,a),m(this,K).slice(0,a)];return C(this,j,m(this,j).slice(a)),m(this,tt).audioChanCount>1&&C(this,K,m(this,K).slice(a)),l})};function li(d){const a=[];let l=0;function o(g,r){a[r]=g,p()}function p(){const g=a[l];g!=null&&(d(g),l+=1,p())}let u=0;return g=>{const r=u;u+=1,g().then(v=>o(v,r)).catch(v=>o(v,r))}}var Z,bt,et,ue,ze;class di{constructor(a){E(this,ue),F(this,"ready"),E(this,Z,{duration:0,width:0,height:0}),E(this,bt,null),E(this,et,[]),a instanceof ImageBitmap?(C(this,bt,a),m(this,Z).width=a.width,m(this,Z).height=a.height,this.ready=Promise.resolve({width:a.width,height:a.height,duration:1/0})):this.ready=q(this,ue,ze).call(this,a.stream,a.type).then(()=>({width:m(this,Z).width,height:m(this,Z).height,duration:1/0}))}tick(a){return T(this,null,function*(){var o;if(m(this,bt)!=null)return{video:yield createImageBitmap(m(this,bt)),state:"success"};const l=a%m(this,Z).duration;return{video:((o=m(this,et).find(p=>{var u;return l>=p.timestamp&&l<=p.timestamp+((u=p.duration)!=null?u:0)}))!=null?o:m(this,et)[0]).clone(),state:"success"}})}destroy(){var a;z.info("ImgClip destroy"),(a=m(this,bt))==null||a.close(),m(this,et).forEach(l=>l.close())}}Z=new WeakMap,bt=new WeakMap,et=new WeakMap,ue=new WeakSet,ze=function(d,a){return T(this,null,function*(){C(this,et,yield Te(d,a));const l=m(this,et)[0];if(l==null)throw Error("No frame available in gif");C(this,Z,{duration:m(this,et).reduce((o,p)=>{var u;return o+((u=p.duration)!=null?u:0)},0),width:l.codedWidth,height:l.codedHeight}),z.info("ImgClip ready:",m(this,Z))})};var Pt,it,ut,Lt,st,vt,fe,Fe;const $t=class{constructor(d,a={}){E(this,fe),F(this,"ready"),E(this,Pt,{duration:0,width:0,height:0}),E(this,it,new Float32Array),E(this,ut,new Float32Array),E(this,Lt,0),E(this,st,0),E(this,vt,void 0),C(this,vt,Et({loop:!1,volume:1},a)),this.ready=q(this,fe,Fe).call(this,d).then(()=>({width:0,height:0,duration:a.loop?1/0:m(this,Pt).duration}))}getPCMData(){return[m(this,it),m(this,ut)]}tick(d){return T(this,null,function*(){if(d<m(this,Lt))throw Error("time not allow rollback");if(!m(this,vt).loop&&d>=m(this,Pt).duration)return{audio:[],state:"done"};const a=d-m(this,Lt);C(this,Lt,d);const l=Math.ceil(a*(P.sampleRate/1e6)),o=m(this,st)+l,p=m(this,vt).loop?[jt(m(this,it),m(this,st),o),jt(m(this,ut),m(this,st),o)]:[m(this,it).slice(m(this,st),o),m(this,ut).slice(m(this,st),o)];return C(this,st,o),{audio:p,state:"success"}})}destroy(){C(this,it,new Float32Array(0)),C(this,ut,new Float32Array(0)),z.info("---- audioclip destroy ----")}};let ce=$t;Pt=new WeakMap,it=new WeakMap,ut=new WeakMap,Lt=new WeakMap,st=new WeakMap,vt=new WeakMap,fe=new WeakSet,Fe=function(d){return T(this,null,function*(){var p;$t.ctx==null&&($t.ctx=new AudioContext({sampleRate:P.sampleRate}));const a=performance.now(),l=d instanceof ReadableStream?yield ui(d,$t.ctx):d;z.info("Audio clip decoded complete:",performance.now()-a);const o=m(this,vt).volume;if(o!==1)for(const u of l)for(let g=0;g<u.length;g+=1)u[g]*=o;m(this,Pt).duration=l[0].length/P.sampleRate*1e6,C(this,it,l[0]),C(this,ut,(p=l[1])!=null?p:m(this,it)),z.info("Audio clip convert to AudioData, time:",performance.now()-a)})},F(ce,"ctx",null);function pi(d,a){return T(this,null,function*(){const l=[];for(const o of d)yield o.ready,l.push(o.getPCMData());return new ce(le(l),a)})}function ui(d,a){return T(this,null,function*(){const l=yield new Response(d).arrayBuffer();return Vt(yield a.decodeAudioData(l))})}var $,St,Q,J,G,rt,nt,_e,Pe;class fi{constructor(a,l){var w,b;E(this,_e),F(this,"ready"),E(this,$,[]),E(this,St,{color:"#FFF",textBgColor:null,type:"srt",fontSize:30,letterSpacing:null,bottomOffset:30,fontFamily:"Noto Sans SC",strokeStyle:"#000",lineWidth:null,lineCap:null,lineJoin:null,textShadow:{offsetX:2,offsetY:2,blur:4,color:"#000"},videoWidth:1280,videoHeight:720}),E(this,Q,void 0),E(this,J,void 0),E(this,G,null),E(this,rt,0),E(this,nt,0);var o;if(C(this,$,ci(a).map(({start:B,end:t,text:e})=>({start:B*1e6,end:t*1e6,text:e}))),m(this,$).length===0)throw Error("No subtitles content");C(this,St,Object.assign(m(this,St),l)),C(this,nt,l.textBgColor==null?0:((w=l.fontSize)!=null?w:50)*.2);const{fontSize:p,fontFamily:u,videoWidth:g,videoHeight:r,letterSpacing:v}=m(this,St);C(this,rt,p+m(this,nt)*2),C(this,Q,new OffscreenCanvas(g,r)),C(this,J,m(this,Q).getContext("2d")),m(this,J).font=`${p}px ${u}`,m(this,J).textAlign="center",m(this,J).textBaseline="top",m(this,J).letterSpacing=v!=null?v:"0px",this.ready=Promise.resolve({width:g,height:r,duration:(b=(o=m(this,$).at(-1))==null?void 0:o.end)!=null?b:0})}tick(a){return T(this,null,function*(){var r,v;var l,o;if(m(this,G)!=null&&a>=m(this,G).timestamp&&a<=m(this,G).timestamp+((r=m(this,G).duration)!=null?r:0))return{video:m(this,G).clone(),state:"success"};let p=0;for(;p<m(this,$).length&&!(a<=m(this,$)[p].end);p+=1);const u=(v=m(this,$)[p])!=null?v:m(this,$).at(-1);if(a>u.end)return{state:"done"};if(a<u.start){m(this,J).clearRect(0,0,m(this,Q).width,m(this,Q).height);const w=new VideoFrame(m(this,Q),{timestamp:a,duration:u.start-a});return(l=m(this,G))==null||l.close(),C(this,G,w),{video:w.clone(),state:"success"}}q(this,_e,Pe).call(this,u.text);const g=new VideoFrame(m(this,Q),{timestamp:a,duration:u.end-a});return(o=m(this,G))==null||o.close(),C(this,G,g),{video:g.clone(),state:"success"}})}destroy(){var a;(a=m(this,G))==null||a.close()}}$=new WeakMap,St=new WeakMap,Q=new WeakMap,J=new WeakMap,G=new WeakMap,rt=new WeakMap,nt=new WeakMap,_e=new WeakSet,Pe=function(d){const a=d.split(`
`).reverse().map(n=>n.trim()),{width:l,height:o}=m(this,Q),{color:p,fontSize:u,textBgColor:g,textShadow:r,strokeStyle:v,lineWidth:w,lineCap:b,lineJoin:B,bottomOffset:t}=m(this,St),e=m(this,J);e.clearRect(0,0,l,o),e.globalAlpha=.6;let s=t;for(const n of a){const h=e.measureText(n),f=l/2;g!=null&&(e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.fillStyle=g,e.globalAlpha=.5,e.fillRect(f-h.actualBoundingBoxLeft-m(this,nt),o-s-m(this,rt),h.width+m(this,nt)*2,m(this,rt))),e.shadowColor=r.color,e.shadowOffsetX=r.offsetX,e.shadowOffsetY=r.offsetY,e.shadowBlur=r.blur,e.globalAlpha=1,v!=null&&(e.lineWidth=w!=null?w:u/6,b!=null&&(e.lineCap=b),B!=null&&(e.lineJoin=B),e.strokeStyle=v,e.strokeText(n,f,o-s-m(this,rt)+m(this,nt))),e.fillStyle=p,e.fillText(n,f,o-s-m(this,rt)+m(this,nt)),s+=m(this,rt)+u*.2}};function Le(d){const a=d.match(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/);if(a==null)throw Error(`time format error: ${d}`);const l=Number(a[1]),o=Number(a[2]),p=Number(a[3]),u=Number(a[4]);return l*60*60+o*60+p+u/1e3}function ci(d){return d.split(/\r|\n/).map(a=>a.trim()).filter(a=>a.length>0).map(a=>({lineStr:a,match:a.match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/)})).filter(({lineStr:a},l,o)=>{var p;return!(/^\d+$/.test(a)&&((p=o[l+1])==null?void 0:p.match)!=null)}).reduce((a,{lineStr:l,match:o})=>{if(o==null){const p=a.at(-1);if(p==null)return a;p.text+=p.text.length===0?l:`
${l}`}else a.push({start:Le(o[1]),end:Le(o[2]),text:""});return a},[])}var at;class Re{constructor(){E(this,at,new Map),F(this,"on",(a,l)=>{var p;const o=(p=m(this,at).get(a))!=null?p:new Set;return o.add(l),m(this,at).has(a)||m(this,at).set(a,o),()=>{o.delete(l),o.size===0&&m(this,at).delete(a)}}),F(this,"once",(a,l)=>{const o=this.on(a,(...p)=>{o(),l(...p)});return o}),F(this,"emit",(a,...l)=>{const o=m(this,at).get(a);o!=null&&o.forEach(p=>p(...l))})}destroy(){m(this,at).clear()}}at=new WeakMap;function De(d,a,l){const o=new VideoDecoder({output:t=>{l.onVideoOutput(t)},error:z.error}),p=new AudioDecoder({output:t=>{l.onAudioOutput(t)},error:z.error});let u=null,g=!0,r=0,v=null,w=!0;const b=Xt(d.pipeThrough(new me),{onDone:()=>T(this,null,function*(){if(z.info("demuxcode stream done"),u==null)throw Error("MP4 demux unready");try{yield Promise.all([o.state==="configured"?o.flush():null,p.state==="configured"?p.flush():null]),z.info("demuxcode decode done"),l.onComplete()}catch(t){z.info(t)}}),onChunk:s=>T(this,[s],function*({chunkType:t,data:e}){if(t==="ready"){z.info("demuxcode chunk ready"),v=e.file,u=e.info;const{videoDecoderConf:n,audioDecoderConf:h}=ge(e.file,e.info);n!=null&&o.configure(n),a.audio&&h!=null&&p.configure(h),l.onReady(e.info);return}else if(t==="samples"){const{id:n,type:h,samples:f}=e;for(let c=0;c<f.length;c+=1){const _=f[c];g&&_.is_sync&&(r=c);const y=1e6*_.cts/_.timescale;if(!(y<a.start||y>a.end))if(h==="video"){if(w&&c===0&&_.cts!==0?(_.cts=0,w=!1):w=!0,g&&!_.is_sync){g=!1;for(let S=r;S<c;S++)o.decode(new EncodedVideoChunk(ye(f[S])))}o.decode(new EncodedVideoChunk(ye(_)))}else h==="audio"&&a.audio&&p.decode(new EncodedAudioChunk(ye(_)))}v==null||v.releaseUsedSamples(n,f.length)}})});let B=!1;return{stop:()=>{B||(B=!0,v==null||v.stop(),b(),o.close(),p.close())}}}function Me(d){z.info("recodemux opts:",d);const a=O.createFile(),l=new Re,o=_i(d,a,l);let p=null;d.audio==null?l.emit("AudioReady"):p=gi(d.audio,a,l);let u=0;return{encodeVideo:(g,r)=>{o.encode(g,r),g.close(),o.encodeQueueSize>u&&(u=o.encodeQueueSize)},encodeAudio:g=>{p!=null&&(p.encode(g),g.close())},getEecodeQueueSize:()=>o.encodeQueueSize,flush:()=>T(this,null,function*(){yield Promise.all([o.state==="configured"?o.flush():null,(p==null?void 0:p.state)==="configured"?p.flush():null])}),close:()=>{l.destroy(),o.state==="configured"&&o.close(),(p==null?void 0:p.state)==="configured"&&p.close()},mp4file:a}}function _i(d,a,l){const o={timescale:1e6,width:d.video.width,height:d.video.height,brands:["isom","iso2","avc1","mp42","mp41"],avcDecoderConfigRecord:null};let p,u=[],g=!1;return l.once("AudioReady",()=>{g=!0,u.forEach(r=>{const v=Dt(r);a.addSample(p,v.data,v)}),u=[]}),mi(d,(r,v)=>{var w;if(p==null&&v!=null&&(o.avcDecoderConfigRecord=(w=v.decoderConfig)==null?void 0:w.description,p=a.addTrack(o),l.emit("VideoReady"),z.info("VideoEncoder, video track ready, trackId:",p)),g){const b=Dt(r);a.addSample(p,b.data,b)}else u.push(r)})}function mi(d,a){const l=new VideoEncoder({error:z.error,output:a}),o=d.video;return l.configure({codec:"avc1.4D0032",framerate:o.expectFPS,bitrate:d.bitrate,width:o.width,height:o.height,alpha:"discard",avc:{format:"avc"}}),l}function gi(d,a,l){const o={timescale:1e6,samplerate:d.sampleRate,channel_count:d.channelCount,hdlr:"soun",type:d.codec==="aac"?"mp4a":"Opus"};let p=0,u=[],g=!1;l.once("VideoReady",()=>{g=!0,u.forEach(v=>{const w=Dt(v);a.addSample(p,w.data,w)}),u=[]});const r=new AudioEncoder({error:z.error,output:(v,w)=>{var b,B;if(p===0&&((b=w.decoderConfig)==null?void 0:b.description)!=null&&(p=a.addTrack(ne(Et({},o),{description:Ei((B=w.decoderConfig)==null?void 0:B.description)})),l.emit("AudioReady"),z.info("AudioEncoder, audio track ready, trackId:",p)),g){const t=Dt(v);a.addSample(p,t.data,t)}else u.push(v)}});return r.configure({codec:d.codec==="aac"?P.codec:"opus",sampleRate:d.sampleRate,numberOfChannels:d.channelCount,bitrate:128e3}),r}function yi(d){const a=d.getReader();let l=0;const o=O.createFile();let p=!1;function u(){return T(this,null,function*(){for(var g;!p;){const{done:r,value:v}=yield a.read();if(r){z.info("stream source read done"),o.flush(),(g=o.onFlush)==null||g.call(o);return}const w=v.buffer;w.fileStart=l,l+=w.byteLength,o.appendBuffer(w)}a.releaseLock(),d.cancel()})}return u().catch(z.error),{file:o,stop:()=>{p=!0}}}var Rt;class me{constructor(){F(this,"readable"),F(this,"writable"),E(this,Rt,0);const a=O.createFile();let l=0,o=!1;this.readable=new ReadableStream({start:p=>{a.onReady=u=>{var g,r;const v=(g=u.videoTracks[0])==null?void 0:g.id;v!=null&&a.setExtractionOptions(v,"video",{nbSamples:100});const w=(r=u.audioTracks[0])==null?void 0:r.id;w!=null&&a.setExtractionOptions(w,"audio",{nbSamples:100}),p.enqueue({chunkType:"ready",data:{info:u,file:a}}),a.start()},a.onSamples=(u,g,r)=>{var v;p.enqueue({chunkType:"samples",data:{id:u,type:g,samples:r}}),l=(v=p.desiredSize)!=null?v:0},a.onFlush=()=>{p.close()}},pull:p=>{var u;l=(u=p.desiredSize)!=null?u:0},cancel:()=>{a.stop(),o=!0}},{highWaterMark:50}),this.writable=new WritableStream({write:p=>T(this,null,function*(){if(o){this.writable.abort();return}const u=p.buffer;for(u.fileStart=m(this,Rt),C(this,Rt,m(this,Rt)+u.byteLength),a.appendBuffer(u);l<0;)yield Tt(50)}),close:()=>{var p;a.flush(),a.stop(),(p=a.onFlush)==null||p.call(a)}})}}Rt=new WeakMap;function Qt(d,a,l){let o=0,p=0;const u=d.boxes,g=[],r=()=>{if(u.length<4||p>=u.length)return null;if(g.length===0)for(let t=1;;t+=1){const e=d.getTrackById(t);if(e==null)break;g.push({track:e,id:t})}const B=new O.DataStream;B.endianness=O.DataStream.BIG_ENDIAN;for(let t=p;t<u.length;t++)u[t].write(B),delete u[t];return g.forEach(({track:t,id:e})=>{d.releaseUsedSamples(e,t.samples.length),t.samples=[]}),d.mdats=[],d.moofs=[],p=u.length,new Uint8Array(B.buffer)};let v=!1,w=!1,b=null;return{stream:new ReadableStream({start(B){o=self.setInterval(()=>{const t=r();t!=null&&!w&&B.enqueue(t)},a),b=()=>{clearInterval(o),d.flush();const t=r();t!=null&&!w&&B.enqueue(t),w||B.close()},v&&b()},cancel(){w=!0,clearInterval(o),l==null||l()}}),stop:()=>{v||(v=!0,b==null||b())}}}function bi(d){var a,l;for(const o of d.mdia.minf.stbl.stsd.entries){const p=(l=(a=o.avcC)!=null?a:o.hvcC)!=null?l:o.vpcC;if(p!=null){const u=new O.DataStream(void 0,0,O.DataStream.BIG_ENDIAN);return p.write(u),new Uint8Array(u.buffer.slice(8))}}throw Error("avcC, hvcC or VPX not found")}function Dt(d){var o;const a=new ArrayBuffer(d.byteLength);d.copyTo(a);const l=d.timestamp;return{duration:(o=d.duration)!=null?o:0,dts:l,cts:l,is_sync:d.type==="key",data:a}}function ge(d,a){const l=a.videoTracks[0],o={};if(l!=null){const u=bi(d.getTrackById(l.id)).buffer,{descKey:g,type:r}=l.codec.startsWith("avc1")?{descKey:"avcDecoderConfigRecord",type:"avc1"}:l.codec.startsWith("hvc1")?{descKey:"hevcDecoderConfigRecord",type:"hvc1"}:{descKey:"",type:""};g!==""&&(o.videoTrackConf={timescale:l.timescale,duration:l.duration,width:l.video.width,height:l.video.height,brands:a.brands,type:r,[g]:u}),o.videoDecoderConf={codec:l.codec,codedHeight:l.video.height,codedWidth:l.video.width,description:u}}const p=a.audioTracks[0];return p!=null&&(o.audioTrackConf={timescale:p.timescale,samplerate:p.audio.sample_rate,channel_count:p.audio.channel_count,hdlr:"soun",type:p.codec.startsWith("mp4a")?"mp4a":p.codec},o.audioDecoderConf={codec:p.codec.startsWith("mp4a")?P.codec:p.codec,numberOfChannels:p.audio.channel_count,sampleRate:p.audio.sample_rate}),o}function vi(d){z.info("fastConcatMP4, streams len:",d.length);const a=O.createFile(),{stream:l,stop:o}=Qt(a,500,()=>{});function p(){return T(this,null,function*(){let u=0,g=0,r=0,v=0,w=0,b=0,B=null,t=null;for(const e of d)yield new Promise(s=>T(this,null,function*(){let n=null;Xt(e.pipeThrough(new me),{onDone:s,onChunk:c=>T(this,[c],function*({chunkType:h,data:f}){if(h==="ready"){const{videoTrackConf:_,audioTrackConf:y}=ge(f.file,f.info);n=f.file,u===0&&_!=null&&(u=a.addTrack(_)),v===0&&y!=null&&(v=a.addTrack(y))}else if(h==="samples"){const{id:_,type:y,samples:S}=f,U=y==="video"?u:v,A=y==="video"?g:w,k=y==="video"?r:b;S.forEach(L=>{a.addSample(U,L.data,{duration:L.duration,dts:L.dts+A,cts:L.cts+k,is_sync:L.is_sync})}),n==null||n.releaseUsedSamples(_,S.length);const x=S.at(-1);if(x==null)return;y==="video"?B=x:y==="audio"&&(t=x)}})})})),B!=null&&(g+=B.dts,r+=B.cts),t!=null&&(w+=t.dts,b+=t.cts);o()})}return p().catch(z.error),l}function Si(d){let a=[];const l=new AudioDecoder({output:o=>{a.push(o)},error:z.error});return l.configure(d),{decode:o=>T(this,null,function*(){o.forEach(u=>{l.decode(new EncodedAudioChunk({type:u.is_sync?"key":"delta",timestamp:1e6*u.cts/u.timescale,duration:1e6*u.duration/u.timescale,data:u.data}))}),yield l.flush();const p=a;return a=[],p}),close:()=>{l.close()}}}function Ui(d,a){const l=new AudioEncoder({output:u=>{a(Dt(u))},error:z.error});l.configure({codec:d.codec,sampleRate:d.sampleRate,numberOfChannels:d.numberOfChannels});let o=null;function p(u,g){return new AudioData({timestamp:g,numberOfChannels:d.numberOfChannels,numberOfFrames:u.length/d.numberOfChannels,sampleRate:d.sampleRate,format:"f32-planar",data:u})}return{encode:(u,g)=>T(this,null,function*(){o!=null&&l.encode(p(o.data,o.ts)),o={data:u,ts:g}}),stop:()=>T(this,null,function*(){o!=null&&(wi(o.data,d.numberOfChannels,d.sampleRate),l.encode(p(o.data,o.ts)),o=null),yield l.flush(),l.close()})}}function wi(d,a,l){const o=d.length-1,p=Math.min(l/2,o);for(let u=0;u<p;u++)for(let g=1;g<=a;g++)d[Math.floor(o/g)-u]*=u/p}function xi(d,a){z.info("mixinMP4AndAudio, opts:",{volume:a.volume,loop:a.loop});const l=O.createFile(),{stream:o,stop:p}=Qt(l,500);let u=null,g=null,r=[],v=0,w=0,b=0,B=!0,t=48e3;Xt(d.pipeThrough(new me),{onDone:()=>T(this,null,function*(){yield g==null?void 0:g.stop(),u==null||u.close(),p()}),onChunk:c=>T(this,[c],function*({chunkType:h,data:f}){var _;if(h==="ready"){const{videoTrackConf:y,audioTrackConf:S,audioDecoderConf:U}=ge(f.file,f.info);v===0&&y!=null&&(v=l.addTrack(y));const A=S!=null?S:{timescale:1e6,samplerate:t,channel_count:P.channelCount,hdlr:"soun",name:"SoundHandler",type:"mp4a"};w===0&&(w=l.addTrack(A),t=(_=S==null?void 0:S.samplerate)!=null?_:t,B=S!=null);const k=new AudioContext({sampleRate:t});r=Vt(yield k.decodeAudioData(yield new Response(a.stream).arrayBuffer())),U!=null&&(u=Si(U)),g=Ui(U!=null?U:{codec:A.type==="mp4a"?P.codec:A.type,numberOfChannels:A.channel_count,sampleRate:A.samplerate},x=>l.addSample(w,x.data,x))}else if(h==="samples"){const{id:y,type:S,samples:U}=f;if(S==="video"){U.forEach(A=>l.addSample(y,A.data,A)),B||(yield s(U));return}S==="audio"&&(yield n(U))}})});function e(h){const f=r.map(c=>a.loop?jt(c,b,b+h):c.slice(b,b+h));if(b+=h,a.volume!==1)for(const c of f)for(let _=0;_<c.length;_++)c[_]*=a.volume;return f}function s(h){return T(this,null,function*(){const f=h[0],c=h[h.length-1],_=Math.floor((c.cts+c.duration-f.cts)/c.timescale*t),y=Wt([e(_)]);y.length!==0&&(g==null||g.encode(y,f.cts/f.timescale*1e6))})}function n(h){return T(this,null,function*(){if(u==null)return;const f=(yield u.decode(h)).map(Yt),c=le(f),_=e(c[0].length),y=h[0];g==null||g.encode(Wt([c,_]),y.cts/y.timescale*1e6)})}return o}function ye(d){return{type:d.is_sync?"key":"delta",timestamp:1e6*d.cts/d.timescale,duration:1e6*d.duration/d.timescale,data:d.data}}function Ei(d){const a=d.byteLength,l=new Uint8Array([0,0,0,0,3,23+a,0,2,0,4,18+a,64,21,0,0,0,0,0,0,0,0,0,0,0,5,a,...new Uint8Array(d instanceof ArrayBuffer?d:d.buffer),6,1,2]),o=new O.BoxParser.esdsBox(l.byteLength);return o.hdr_size=0,o.parse(new O.DataStream(l,0,O.DataStream.BIG_ENDIAN)),o}const Ai=`#version 300 es
  layout (location = 0) in vec4 a_position;
  layout (location = 1) in vec2 a_texCoord;
  out vec2 v_texCoord;
  void main () {
    gl_Position = a_position;
    v_texCoord = a_texCoord;
  }
`,Ci=`#version 300 es
precision mediump float;
out vec4 FragColor;
in vec2 v_texCoord;

uniform sampler2D frameTexture;
uniform vec3 keyColor;

// \u8272\u5EA6\u7684\u76F8\u4F3C\u5EA6\u8BA1\u7B97
uniform float similarity;
// \u900F\u660E\u5EA6\u7684\u5E73\u6ED1\u5EA6\u8BA1\u7B97
uniform float smoothness;
// \u964D\u4F4E\u7EFF\u5E55\u9971\u548C\u5EA6\uFF0C\u63D0\u9AD8\u62A0\u56FE\u51C6\u786E\u5EA6
uniform float spill;

vec2 RGBtoUV(vec3 rgb) {
  return vec2(
    rgb.r * -0.169 + rgb.g * -0.331 + rgb.b *  0.5    + 0.5,
    rgb.r *  0.5   + rgb.g * -0.419 + rgb.b * -0.081  + 0.5
  );
}

void main() {
  // \u83B7\u53D6\u5F53\u524D\u50CF\u7D20\u7684rgba\u503C
  vec4 rgba = texture(frameTexture, v_texCoord);
  // \u8BA1\u7B97\u5F53\u524D\u50CF\u7D20\u4E0E\u7EFF\u5E55\u50CF\u7D20\u7684\u8272\u5EA6\u5DEE\u503C
  vec2 chromaVec = RGBtoUV(rgba.rgb) - RGBtoUV(keyColor);
  // \u8BA1\u7B97\u5F53\u524D\u50CF\u7D20\u4E0E\u7EFF\u5E55\u50CF\u7D20\u7684\u8272\u5EA6\u8DDD\u79BB\uFF08\u5411\u91CF\u957F\u5EA6\uFF09, \u8D8A\u76F8\u50CF\u5219\u8272\u5EA6\u8DDD\u79BB\u8D8A\u5C0F
  float chromaDist = sqrt(dot(chromaVec, chromaVec));
  // \u8BBE\u7F6E\u4E86\u4E00\u4E2A\u76F8\u4F3C\u5EA6\u9608\u503C\uFF0CbaseMask\u4E3A\u8D1F\uFF0C\u5219\u8868\u660E\u662F\u7EFF\u5E55\uFF0C\u4E3A\u6B63\u5219\u8868\u660E\u4E0D\u662F\u7EFF\u5E55
  float baseMask = chromaDist - similarity;
  // \u5982\u679CbaseMask\u4E3A\u8D1F\u6570\uFF0CfullMask\u7B49\u4E8E0\uFF1BbaseMask\u4E3A\u6B63\u6570\uFF0C\u8D8A\u5927\uFF0C\u5219\u900F\u660E\u5EA6\u8D8A\u4F4E
  float fullMask = pow(clamp(baseMask / smoothness, 0., 1.), 1.5);
  rgba.a = fullMask; // \u8BBE\u7F6E\u900F\u660E\u5EA6
  // \u5982\u679CbaseMask\u4E3A\u8D1F\u6570\uFF0CspillVal\u7B49\u4E8E0\uFF1BbaseMask\u4E3A\u6574\u6570\uFF0C\u8D8A\u5C0F\uFF0C\u9971\u548C\u5EA6\u8D8A\u4F4E
  float spillVal = pow(clamp(baseMask / spill, 0., 1.), 1.5);
  float desat = clamp(rgba.r * 0.2126 + rgba.g * 0.7152 + rgba.b * 0.0722, 0., 1.); // \u8BA1\u7B97\u5F53\u524D\u50CF\u7D20\u7684\u7070\u5EA6\u503C
  rgba.rgb = mix(vec3(desat, desat, desat), rgba.rgb, spillVal);
  FragColor = rgba;
}
`,Bi=[-1,1,-1,-1,1,-1,1,-1,1,1,-1,1],Ti=[0,1,0,0,1,0,1,0,1,1,0,1];function Ii(d,a,l){var g;const o=Ne(d,d.VERTEX_SHADER,a),p=Ne(d,d.FRAGMENT_SHADER,l),u=d.createProgram();if(d.attachShader(u,o),d.attachShader(u,p),d.linkProgram(u),!d.getProgramParameter(u,d.LINK_STATUS))throw Error((g=d.getProgramInfoLog(u))!=null?g:"Unable to initialize the shader program");return u}function Ne(d,a,l){const o=d.createShader(a);if(d.shaderSource(o,l),d.compileShader(o),!d.getShaderParameter(o,d.COMPILE_STATUS)){const p=d.getShaderInfoLog(o);throw d.deleteShader(o),Error(p!=null?p:"An error occurred compiling the shaders")}return o}function ki(d,a,l){d.bindTexture(d.TEXTURE_2D,l),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,a),d.drawArrays(d.TRIANGLES,0,6)}function zi(d){const a=d.createTexture();if(a==null)throw Error("Create WebGL texture error");d.bindTexture(d.TEXTURE_2D,a);const l=0,o=d.RGBA,p=1,u=1,g=0,r=d.RGBA,v=d.UNSIGNED_BYTE,w=new Uint8Array([0,0,255,255]);return d.texImage2D(d.TEXTURE_2D,l,o,p,u,g,r,v,w),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),a}function Fi(d){const a=new OffscreenCanvas(d.width,d.height),l=a.getContext("webgl2",{premultipliedAlpha:!1,alpha:!0});if(l==null)throw Error("Cant create gl context");const o=Ii(l,Ai,Ci);l.useProgram(o),l.uniform3fv(l.getUniformLocation(o,"keyColor"),d.keyColor.map(v=>v/255)),l.uniform1f(l.getUniformLocation(o,"similarity"),d.similarity),l.uniform1f(l.getUniformLocation(o,"smoothness"),d.smoothness),l.uniform1f(l.getUniformLocation(o,"spill"),d.spill);const p=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,p),l.bufferData(l.ARRAY_BUFFER,new Float32Array(Bi),l.STATIC_DRAW);const u=l.getAttribLocation(o,"a_position");l.vertexAttribPointer(u,2,l.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),l.enableVertexAttribArray(u);const g=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,g),l.bufferData(l.ARRAY_BUFFER,new Float32Array(Ti),l.STATIC_DRAW);const r=l.getAttribLocation(o,"a_texCoord");return l.vertexAttribPointer(r,2,l.FLOAT,!1,Float32Array.BYTES_PER_ELEMENT*2,0),l.enableVertexAttribArray(r),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,1),{cvs:a,gl:l}}function Pi(d){return d instanceof VideoFrame?{width:d.codedWidth,height:d.codedHeight}:{width:d.width,height:d.height}}function Li(d){const a=new OffscreenCanvas(1,1).getContext("2d");a.drawImage(d,0,0);const{data:[l,o,p]}=a.getImageData(0,0,1,1);return[l,o,p]}const Ri=d=>{let a=null,l=null,o=d.keyColor,p=null;return u=>T(this,null,function*(){var g;if((a==null||l==null||p==null)&&(o==null&&(o=Li(u)),{cvs:a,gl:l}=Fi(Et(ne(Et({},Pi(u)),{keyColor:o}),d)),p=zi(l)),ki(l,u,p),u instanceof VideoFrame){const r=new VideoFrame(a,{alpha:"keep",timestamp:u.timestamp,duration:(g=u.duration)!=null?g:void 0});return u.close(),r}return createImageBitmap(a,{imageOrientation:u instanceof ImageBitmap?"flipY":"none"})})},Di=["t","b","l","r","lt","lb","rt","rb","rotate"],H=class{constructor(d,a,l,o,p){F(this,"x",0),F(this,"y",0),F(this,"w",0),F(this,"h",0),F(this,"angle",0),F(this,"master",null),this.x=d!=null?d:0,this.y=a!=null?a:0,this.w=l!=null?l:0,this.h=o!=null?o:0,this.master=p!=null?p:null}get center(){const{x:d,y:a,w:l,h:o}=this;return{x:d+l/2,y:a+o/2}}get ctrls(){const{w:d,h:a}=this,l=H.CTRL_SIZE,o=l/2,p=d/2,u=a/2,g=l*1.5,r=g/2;return{t:new H(-o,-u-o,l,l,this),b:new H(-o,u-o,l,l,this),l:new H(-p-o,-o,l,l,this),r:new H(p-o,-o,l,l,this),lt:new H(-p-o,-u-o,l,l,this),lb:new H(-p-o,u-o,l,l,this),rt:new H(p-o,-u-o,l,l,this),rb:new H(p-o,u-o,l,l,this),rotate:new H(-r,-u-l*2-r,g,g,this)}}clone(){const{x:d,y:a,w:l,h:o,master:p}=this;return new H(d,a,l,o,p)}checkHit(d,a){var n,h;let{angle:l,center:o,x:p,y:u,w:g,h:r,master:v}=this;const w=(n=v==null?void 0:v.center)!=null?n:o,b=(h=v==null?void 0:v.angle)!=null?h:l;v==null&&(p=p-w.x,u=u-w.y);const B=d-w.x,t=a-w.y;let e=B,s=t;return b!==0&&(e=B*Math.cos(b)+t*Math.sin(b),s=t*Math.cos(b)-B*Math.sin(b)),!(e<p||e>p+g||s<u||s>u+r)}};let be=H;F(be,"CTRL_SIZE",16);var Mt,ft;class Oe{constructor(a){F(this,"rect",new be),F(this,"visible",!0),F(this,"zIndex",0),F(this,"opacity",1),F(this,"flip",null),E(this,Mt,null),E(this,ft,null),F(this,"audioNode",null),F(this,"initReady",Promise.resolve()),this.name=a}render(a){const{rect:{center:l,angle:o}}=this;a.setTransform(this.flip==="horizontal"?-1:1,0,0,this.flip==="vertical"?-1:1,l.x,l.y),a.rotate((this.flip==null?1:-1)*o),a.globalAlpha=this.opacity}setAnimation(a,l){var o,p;C(this,Mt,Object.entries(a).map(([u,g])=>{var v;const r=(v={from:0,to:100}[u])!=null?v:Number(u.slice(0,-1));if(isNaN(r)||r>100||r<0)throw Error("keyFrame must between 0~100");return[r/100,g]})),C(this,ft,Object.assign({},m(this,ft),{duration:l.duration*1e6,delay:((o=l.delay)!=null?o:0)*1e6,iterCount:(p=l.iterCount)!=null?p:1/0}))}animate(a){if(m(this,Mt)==null||m(this,ft)==null||a<m(this,ft).delay)return;const l=Mi(a,m(this,Mt),m(this,ft));for(const o in l)switch(o){case"opacity":this.opacity=l[o];break;case"x":case"y":case"w":case"h":case"angle":this.rect[o]=l[o];break}}}Mt=new WeakMap,ft=new WeakMap;function Mi(d,a,l){if(d/l.duration>=l.iterCount)return{};const o=d%l.duration,p=d===l.duration?1:o/l.duration,u=a.findIndex(t=>t[0]>=p);if(u===-1)return{};const g=a[u-1],r=a[u],v=r[1];if(g==null)return v;const w=g[1],b={},B=(p-g[0])/(r[0]-g[0]);for(const t in v){const e=t;w[e]!=null&&(b[e]=(v[e]-w[e])*B+w[e])}return b}var Nt,ct,Jt;class ve extends Oe{constructor(a,l){super(a),E(this,Nt,void 0),F(this,"ready"),E(this,ct,null),F(this,"duration",1/0),E(this,Jt,!1),C(this,Nt,l),this.ready=l.ready.then(({width:o,height:p,duration:u})=>{this.rect.w=o,this.rect.h=p,this.duration=u})}offscreenRender(a,l){return T(this,null,function*(){var o;this.animate(l),Ve(ve.prototype,this,"render").call(this,a);const{w:p,h:u}=this.rect,{video:g,audio:r,state:v}=yield m(this,Nt).tick(l);if(v==="done")return{audio:r!=null?r:[],done:!0};const w=g!=null?g:m(this,ct);return w!=null&&a.drawImage(w,-p/2,-u/2,p,u),g!=null&&((o=m(this,ct))==null||o.close(),C(this,ct,g)),{audio:r!=null?r:[],done:!1}})}destroy(){var a;m(this,Jt)||(C(this,Jt,!0),z.info(`OffscreenSprite ${this.name} destroy`),(a=m(this,ct))==null||a.close(),C(this,ct,null),m(this,Nt).destroy())}}Nt=new WeakMap,ct=new WeakMap,Jt=new WeakMap;let Ni=0,Se=new Map;const Oi=(()=>{let d=0;const a=ke(()=>{let l=0;for(const o of Se.values())l+=o();d=l},10);return function l(){return T(this,null,function*(){if(a(),d>100){if(yield Tt(d),a(),d<50)return;yield l()}})}})();var ot,te,Y,Ut,ee,ie,V,se,wt,Ue,Ge;class Gi{constructor(a){var u;E(this,Ue),E(this,ot,z.create(`id:${Ni++},`)),E(this,te,!1),E(this,Y,[]),E(this,Ut,void 0),E(this,ee,void 0),E(this,ie,null),E(this,V,void 0),E(this,se,void 0),E(this,wt,new Re),F(this,"on",m(this,wt).on);const{width:l,height:o}=a;C(this,Ut,new OffscreenCanvas(l,o));const p=m(this,Ut).getContext("2d",{alpha:!1});if(p==null)throw Error("Can not create 2d offscreen context");C(this,ee,p),C(this,se,Object.assign({bgColor:"#000"},a)),C(this,V,Me({video:{width:l,height:o,expectFPS:30},audio:{codec:"aac",sampleRate:P.sampleRate,channelCount:P.channelCount},bitrate:(u=a.bitrate)!=null?u:2e6})),Se.set(this,m(this,V).getEecodeQueueSize)}static isSupported(){return T(this,null,function*(){var a;return self.OffscreenCanvas!=null&&self.VideoEncoder!=null&&self.VideoDecoder!=null&&self.VideoFrame!=null&&self.AudioEncoder!=null&&self.AudioDecoder!=null&&self.AudioData!=null&&((a=(yield self.VideoEncoder.isConfigSupported({codec:"avc1.4D0032",width:1280,height:720})).supported)!=null?a:!1)&&(yield self.AudioEncoder.isConfigSupported({codec:P.codec,sampleRate:P.sampleRate,numberOfChannels:P.channelCount})).supported})}add(o){return T(this,arguments,function*(a,l={}){var p,u;m(this,ot).info("Combinator add sprite:",a.name),yield a.ready,m(this,ot).info("Combinator add sprite ready:",a.name),m(this,Y).push({sprite:a,offset:((p=l.offset)!=null?p:0)*1e6,duration:l.duration==null?a.duration:l.duration*1e6,main:(u=l.main)!=null?u:!1}),m(this,Y).sort((g,r)=>g.sprite.zIndex-r.sprite.zIndex)})}output(){if(m(this,Y).length===0)throw Error("No clip added");const a=m(this,Y).find(r=>r.main),l=a!=null?a.offset+a.duration:Math.max(...m(this,Y).map(r=>r.offset+r.duration));if(l===1/0)throw Error("Unable to determine the end time, please specify a main sprite, or limit the duration of ImgClip, AudioCli");l===-1&&m(this,ot).warn("Unable to determine the end time, process value don't update");let o=performance.now();const p=q(this,Ue,Ge).call(this,l,r=>{m(this,ot).debug("OutputProgress:",r),m(this,wt).emit("OutputProgress",r)},()=>T(this,null,function*(){yield m(this,V).flush(),m(this,ot).info("===== output ended =====, cost:",performance.now()-o),m(this,wt).emit("OutputProgress",1),this.destroy()}));C(this,ie,()=>{p(),m(this,V).close(),g()});const{stream:u,stop:g}=Qt(m(this,V).mp4file,500,this.destroy);return u}destroy(){var a;m(this,te)||(C(this,te,!0),Se.delete(this),(a=m(this,ie))==null||a.call(this),m(this,wt).destroy())}}ot=new WeakMap,te=new WeakMap,Y=new WeakMap,Ut=new WeakMap,ee=new WeakMap,ie=new WeakMap,V=new WeakMap,se=new WeakMap,wt=new WeakMap,Ue=new WeakSet,Ge=function(d,a,l){let o=0,p=!1;(()=>T(this,null,function*(){let b=0;const{width:B,height:t}=m(this,Ut),e=m(this,ee);let s=0;for(;;){if(p||d!==-1&&s>d||m(this,Y).length===0){w(),yield l();return}o=s/d,e.fillStyle=m(this,se).bgColor,e.fillRect(0,0,B,t);const n=[];for(let f=0;!p&&f<m(this,Y).length;f++){const c=m(this,Y)[f];if(s<c.offset)continue;e.save();const{audio:_,done:y}=yield c.sprite.offscreenRender(e,s-c.offset);if(n.push(_),e.restore(),c.duration>0&&s>c.offset+c.duration||y){if(c.main){w(),yield l();return}c.sprite.destroy(),m(this,Y).splice(f,1)}}if(p)return;if(n.flat().every(f=>f.length===0))m(this,V).encodeAudio(Hi(s,33e3,P.sampleRate));else{const f=Wt(n);m(this,V).encodeAudio(new AudioData({timestamp:s,numberOfChannels:P.channelCount,numberOfFrames:f.length/P.channelCount,sampleRate:P.sampleRate,format:"f32-planar",data:f}))}const h=new VideoFrame(m(this,Ut),{duration:33e3,timestamp:s});s+=33e3,m(this,V).encodeVideo(h,{keyFrame:b%150===0}),e.resetTransform(),e.clearRect(0,0,B,t),b+=1,yield Oi()}}))().catch(m(this,ot).error);let u=1,g=0,r=0;const v=setInterval(()=>{const b=m(this,V).getEecodeQueueSize();u=Math.max(u,b),g=b/u,r=Math.max(g*.5+o*.5,r),a(r)},500),w=()=>{p||(p=!0,clearInterval(v),m(this,Y).forEach(b=>b.sprite.destroy()))};return w};function Hi(d,a,l){const o=Math.floor(l*a/1e6);return new AudioData({timestamp:d,numberOfChannels:P.channelCount,numberOfFrames:o,sampleRate:l,format:"f32-planar",data:new Float32Array(o*2)})}}}]);
}());