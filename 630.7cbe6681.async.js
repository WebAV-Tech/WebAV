!(function(){"use strict";var ke=Object.defineProperty,Fe=Object.defineProperties;var De=Object.getOwnPropertyDescriptors;var ie=Object.getOwnPropertySymbols;var Me=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable;var re=(H,P,E)=>P in H?ke(H,P,{enumerable:!0,configurable:!0,writable:!0,value:E}):H[P]=E,Dt=(H,P)=>{for(var E in P||(P={}))Me.call(P,E)&&re(H,E,P[E]);if(ie)for(var E of ie(P))Re.call(P,E)&&re(H,E,P[E]);return H},se=(H,P)=>Fe(H,De(P));var Q=(H,P,E)=>new Promise((W,j)=>{var M=T=>{try{y(E.next(T))}catch(D){j(D)}},G=T=>{try{y(E.throw(T))}catch(D){j(D)}},y=T=>T.done?W(T.value):Promise.resolve(T.value).then(M,G);y((E=E.apply(H,P)).next())});(self.webpackChunkWebAV_Doc_Site=self.webpackChunkWebAV_Doc_Site||[]).push([[630],{56790:function(H,P,E){E.d(P,{C8:function(){return j.Z},t4:function(){return M.t4},x1:function(){return M.x1},zX:function(){return W.Z}});var W=E(66680),j=E(21770),M=E(42550),G=E(8880),y=E(80334)},64217:function(H,P,E){E.d(P,{Z:function(){return tt}});var W=E(1413),j=`accept acceptCharset accessKey action allowFullScreen allowTransparency
    alt async autoComplete autoFocus autoPlay capture cellPadding cellSpacing challenge
    charSet checked classID className colSpan cols content contentEditable contextMenu
    controls coords crossOrigin data dateTime default defer dir disabled download draggable
    encType form formAction formEncType formMethod formNoValidate formTarget frameBorder
    headers height hidden high href hrefLang htmlFor httpEquiv icon id inputMode integrity
    is keyParams keyType kind label lang list loop low manifest marginHeight marginWidth max maxLength media
    mediaGroup method min minLength multiple muted name noValidate nonce open
    optimum pattern placeholder poster preload radioGroup readOnly rel required
    reversed role rowSpan rows sandbox scope scoped scrolling seamless selected
    shape size sizes span spellCheck src srcDoc srcLang srcSet start step style
    summary tabIndex target title type useMap value width wmode wrap`,M=`onCopy onCut onPaste onCompositionEnd onCompositionStart onCompositionUpdate onKeyDown
    onKeyPress onKeyUp onFocus onBlur onChange onInput onSubmit onClick onContextMenu onDoubleClick
    onDrag onDragEnd onDragEnter onDragExit onDragLeave onDragOver onDragStart onDrop onMouseDown
    onMouseEnter onMouseLeave onMouseMove onMouseOut onMouseOver onMouseUp onSelect onTouchCancel
    onTouchEnd onTouchMove onTouchStart onScroll onWheel onAbort onCanPlay onCanPlayThrough
    onDurationChange onEmptied onEncrypted onEnded onError onLoadedData onLoadedMetadata
    onLoadStart onPause onPlay onPlaying onProgress onRateChange onSeeked onSeeking onStalled onSuspend onTimeUpdate onVolumeChange onWaiting onLoad onError`,G="".concat(j," ").concat(M).split(/[\s\n]+/),y="aria-",T="data-";function D(et,it){return et.indexOf(it)===0}function tt(et){var it=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,L;it===!1?L={aria:!0,data:!0,attr:!0}:it===!0?L={aria:!0}:L=(0,W.Z)({},it);var k={};return Object.keys(et).forEach(function(x){(L.aria&&(x==="role"||D(x,y))||L.data&&D(x,T)||L.attr&&G.includes(x))&&(k[x]=et[x])}),k}},88306:function(H,P,E){E.d(P,{Z:function(){return W}});function W(j,M){for(var G=j,y=0;y<M.length;y+=1){if(G==null)return;G=G[M[y]]}return G}},8880:function(H,P,E){E.d(P,{T:function(){return L},Z:function(){return D}});var W=E(71002),j=E(1413),M=E(74902),G=E(84506),y=E(88306);function T(k,x,R,F){if(!x.length)return R;var gt=(0,G.Z)(x),rt=gt[0],X=gt.slice(1),Y;return!k&&typeof rt=="number"?Y=[]:Array.isArray(k)?Y=(0,M.Z)(k):Y=(0,j.Z)({},k),F&&R===void 0&&X.length===1?delete Y[rt][X[0]]:Y[rt]=T(Y[rt],X,R,F),Y}function D(k,x,R){var F=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return x.length&&F&&R===void 0&&!(0,y.Z)(k,x.slice(0,-1))?k:T(k,x,R,F)}function tt(k){return(0,W.Z)(k)==="object"&&k!==null&&Object.getPrototypeOf(k)===Object.prototype}function et(k){return Array.isArray(k)?[]:{}}var it=typeof Reflect=="undefined"?Object.keys:Reflect.ownKeys;function L(){for(var k=arguments.length,x=new Array(k),R=0;R<k;R++)x[R]=arguments[R];var F=et(x[0]);return x.forEach(function(gt){function rt(X,Y){var yt=new Set(Y),K=(0,y.Z)(gt,X),Z=Array.isArray(K);if(Z||tt(K)){if(!yt.has(K)){yt.add(K);var Tt=(0,y.Z)(F,X);Z?F=D(F,X,[]):(!Tt||(0,W.Z)(Tt)!=="object")&&(F=D(F,X,et(K))),it(K).forEach(function(Mt){rt([].concat((0,M.Z)(X),[Mt]),yt)})}}else F=D(F,X,K)}rt([])}),F}},84506:function(H,P,E){E.d(P,{Z:function(){return y}});var W=E(83878),j=E(59199),M=E(40181),G=E(25267);function y(T){return(0,W.Z)(T)||(0,j.Z)(T)||(0,M.Z)(T)||(0,G.Z)()}},71471:function(H,P,E){E.d(P,{JN:function(){return Ce},V0:function(){return Ie},Zd:function(){return Pe},cJ:function(){return Te},u_:function(){return Ae}});var W=Object.defineProperty,j=(l,o,d)=>o in l?W(l,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):l[o]=d,M=(l,o,d)=>(j(l,typeof o!="symbol"?o+"":o,d),d),G=(l,o,d)=>{if(!o.has(l))throw TypeError("Cannot "+d)},y=(l,o,d)=>(G(l,o,"read from private field"),d?d.call(l):o.get(l)),T=(l,o,d)=>{if(o.has(l))throw TypeError("Cannot add the same private member more than once");o instanceof WeakSet?o.add(l):o.set(l,d)},D=(l,o,d,h)=>(G(l,o,"write to private field"),h?h.call(l,d):o.set(l,d),d),tt=(l,o,d)=>(G(l,o,"access private method"),d),et=Object.defineProperty,it=(l,o,d)=>o in l?et(l,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):l[o]=d,L=(l,o,d)=>(it(l,typeof o!="symbol"?o+"":o,d),d),k=(l,o,d)=>{if(!o.has(l))throw TypeError("Cannot "+d)},x=(l,o,d)=>(k(l,o,"read from private field"),d?d.call(l):o.get(l)),R=(l,o,d)=>{if(o.has(l))throw TypeError("Cannot add the same private member more than once");o instanceof WeakSet?o.add(l):o.set(l,d)},F=(l,o,d,h)=>(k(l,o,"write to private field"),h?h.call(l,d):o.set(l,d),d),gt=(l,o,d)=>(k(l,o,"access private method"),d);function rt(l){return document.createElement(l)}function X(l,o){const d=rt("div");d.style.cssText=`${o} visibility: hidden; position: fixed;`,d.textContent=l,document.body.appendChild(d);const{width:h,height:m}=d.getBoundingClientRect();d.remove(),d.style.visibility="visible";const g=new Image;g.width=h,g.height=m;const U=`
    <svg xmlns="http://www.w3.org/2000/svg" width="${h}" height="${m}">
    <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">${d.outerHTML}</div>
    </foreignObject>
    </svg>
  `.replace(/\n/g,"").replace(/\t/g,"").replace(/#/g,"%23");return g.src=`data:image/svg+xml;charset=utf-8,${U}`,g}let Y=1;const yt={debug:(...l)=>{Y<=0&&console.debug(...l)},info:(...l)=>{Y<=1&&console.info(...l)},warn:(...l)=>{Y<=2&&console.warn(...l)},error:(...l)=>{Y<=3&&console.error(...l)}},K=new Map,Z=se(Dt({setLogLevel:l=>{var o;Y=(o=K.get(l))!=null?o:1}},yt),{create:l=>Object.fromEntries(Object.entries(yt).map(([o,d])=>[o,(...h)=>d(l,...h)]))});K.set(Z.debug,0),K.set(Z.info,1),K.set(Z.warn,2),K.set(Z.error,3);const Tt=()=>{let l,o=16.6;self.onmessage=d=>{d.data.event==="start"&&(self.clearInterval(l),l=self.setInterval(()=>{self.postMessage({})},o)),d.data.event==="stop"&&self.clearInterval(l)}},Mt=()=>{const l=new Blob([`(${Tt.toString()})()`]),o=URL.createObjectURL(l);return new Worker(o)},ne=new Map;let Zt=1;const ae=Mt();ae.onmessage=()=>{Zt+=1;for(const[l,o]of ne.entries())Zt%l===0&&o.forEach(d=>d())};function oe(l){return Array(l.numberOfChannels).fill(0).map((o,d)=>l.getChannelData(d))}function Xt(l,o,d){const h=d-o,m=new Float32Array(h);let g=0;for(;g<h;)m[g]=l[(o+g)%l.length],g+=1;return m}var he={};(function(l){var o=function(){var t=new Date,e=4,r=3,n=2,a=1,p=e,c={setLogLevel:function(u){u==this.debug?p=a:u==this.info?p=n:u==this.warn?p=r:(u==this.error,p=e)},debug:function(u,f){console.debug===void 0&&(console.debug=console.log),a>=p&&console.debug("["+o.getDurationString(new Date-t,1e3)+"]","["+u+"]",f)},log:function(u,f){this.debug(u.msg)},info:function(u,f){n>=p&&console.info("["+o.getDurationString(new Date-t,1e3)+"]","["+u+"]",f)},warn:function(u,f){r>=p&&console.warn("["+o.getDurationString(new Date-t,1e3)+"]","["+u+"]",f)},error:function(u,f){e>=p&&console.error("["+o.getDurationString(new Date-t,1e3)+"]","["+u+"]",f)}};return c}();o.getDurationString=function(t,e){var r;function n(b,v){for(var w=""+b,C=w.split(".");C[0].length<v;)C[0]="0"+C[0];return C.join(".")}t<0?(r=!0,t=-t):r=!1;var a=e||1,p=t/a,c=Math.floor(p/3600);p-=c*3600;var u=Math.floor(p/60);p-=u*60;var f=p*1e3;return p=Math.floor(p),f-=p*1e3,f=Math.floor(f),(r?"-":"")+c+":"+n(u,2)+":"+n(p,2)+"."+n(f,3)},o.printRanges=function(t){var e=t.length;if(e>0){for(var r="",n=0;n<e;n++)n>0&&(r+=","),r+="["+o.getDurationString(t.start(n))+","+o.getDurationString(t.end(n))+"]";return r}else return"(empty)"},l.Log=o;var d=function(t){if(t instanceof ArrayBuffer)this.buffer=t,this.dataview=new DataView(t);else throw"Needs an array buffer";this.position=0};d.prototype.getPosition=function(){return this.position},d.prototype.getEndPosition=function(){return this.buffer.byteLength},d.prototype.getLength=function(){return this.buffer.byteLength},d.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},d.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},d.prototype.readAnyInt=function(t,e){var r=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:e?r=this.dataview.getInt8(this.position):r=this.dataview.getUint8(this.position);break;case 2:e?r=this.dataview.getInt16(this.position):r=this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";r=this.dataview.getUint8(this.position)<<16,r|=this.dataview.getUint8(this.position+1)<<8,r|=this.dataview.getUint8(this.position+2);break;case 4:e?r=this.dataview.getInt32(this.position):r=this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";r=this.dataview.getUint32(this.position)<<32,r|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,r}else throw"Not enough bytes in buffer"},d.prototype.readUint8=function(){return this.readAnyInt(1,!1)},d.prototype.readUint16=function(){return this.readAnyInt(2,!1)},d.prototype.readUint24=function(){return this.readAnyInt(3,!1)},d.prototype.readUint32=function(){return this.readAnyInt(4,!1)},d.prototype.readUint64=function(){return this.readAnyInt(8,!1)},d.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",r=0;r<t;r++)e+=String.fromCharCode(this.readUint8());return e}else throw"Not enough bytes in buffer"},d.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(e!==0)t.push(e);else break}return String.fromCharCode.apply(null,t)},d.prototype.readInt8=function(){return this.readAnyInt(1,!0)},d.prototype.readInt16=function(){return this.readAnyInt(2,!0)},d.prototype.readInt32=function(){return this.readAnyInt(4,!0)},d.prototype.readInt64=function(){return this.readAnyInt(8,!1)},d.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),r=0;r<t;r++)e[r]=this.readUint8();return e},d.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),r=0;r<t;r++)e[r]=this.readInt16();return e},d.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),r=0;r<t;r++)e[r]=this.readUint16();return e},d.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),r=0;r<t;r++)e[r]=this.readUint32();return e},d.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),r=0;r<t;r++)e[r]=this.readInt32();return e},l.MP4BoxStream=d;var h=function(t,e,r){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:typeof t=="object"?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=r!=null?r:h.LITTLE_ENDIAN};h.prototype={},h.prototype.getPosition=function(){return this.position},h.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,r=this._buffer.byteLength;if(e<=r){e>this._byteLength&&(this._byteLength=e);return}for(r<1&&(r=1);e>r;)r*=2;var n=new ArrayBuffer(r),a=new Uint8Array(this._buffer),p=new Uint8Array(n,0,a.length);p.set(a),this.buffer=n,this._byteLength=e}},h.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),r=new Uint8Array(this._buffer,0,e.length);e.set(r),this.buffer=t}},h.BIG_ENDIAN=!1,h.LITTLE_ENDIAN=!0,h.prototype._byteLength=0,Object.defineProperty(h.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(h.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(h.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),h.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},h.prototype.isEof=function(){return this.position>=this._byteLength},h.prototype.mapUint8Array=function(t){this._realloc(t*1);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},h.prototype.readInt32Array=function(t,e){t=t!=null?t:this.byteLength-this.position/4;var r=new Int32Array(t);return h.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),h.arrayToNative(r,e!=null?e:this.endianness),this.position+=r.byteLength,r},h.prototype.readInt16Array=function(t,e){t=t!=null?t:this.byteLength-this.position/2;var r=new Int16Array(t);return h.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),h.arrayToNative(r,e!=null?e:this.endianness),this.position+=r.byteLength,r},h.prototype.readInt8Array=function(t){t=t!=null?t:this.byteLength-this.position;var e=new Int8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readUint32Array=function(t,e){t=t!=null?t:this.byteLength-this.position/4;var r=new Uint32Array(t);return h.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),h.arrayToNative(r,e!=null?e:this.endianness),this.position+=r.byteLength,r},h.prototype.readUint16Array=function(t,e){t=t!=null?t:this.byteLength-this.position/2;var r=new Uint16Array(t);return h.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),h.arrayToNative(r,e!=null?e:this.endianness),this.position+=r.byteLength,r},h.prototype.readUint8Array=function(t){t=t!=null?t:this.byteLength-this.position;var e=new Uint8Array(t);return h.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},h.prototype.readFloat64Array=function(t,e){t=t!=null?t:this.byteLength-this.position/8;var r=new Float64Array(t);return h.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),h.arrayToNative(r,e!=null?e:this.endianness),this.position+=r.byteLength,r},h.prototype.readFloat32Array=function(t,e){t=t!=null?t:this.byteLength-this.position/4;var r=new Float32Array(t);return h.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),h.arrayToNative(r,e!=null?e:this.endianness),this.position+=r.byteLength,r},h.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,t!=null?t:this.endianness);return this.position+=4,e},h.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,t!=null?t:this.endianness);return this.position+=2,e},h.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},h.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,t!=null?t:this.endianness);return this.position+=4,e},h.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,t!=null?t:this.endianness);return this.position+=2,e},h.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},h.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,t!=null?t:this.endianness);return this.position+=4,e},h.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,t!=null?t:this.endianness);return this.position+=8,e},h.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,h.memcpy=function(t,e,r,n,a){var p=new Uint8Array(t,e,a),c=new Uint8Array(r,n,a);p.set(c)},h.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},h.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},h.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),r=0;r<t.byteLength;r+=t.BYTES_PER_ELEMENT)for(var n=r+t.BYTES_PER_ELEMENT-1,a=r;n>a;n--,a++){var p=e[a];e[a]=e[n],e[n]=p}return t},h.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],r=0;r<t.length;r++)e[r]=t[r];return String.fromCharCode.apply(null,e)},h.prototype.readString=function(t,e){return e==null||e=="ASCII"?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(t!=null?t:this.byteLength-this.position)]):new TextDecoder(e).decode(this.mapUint8Array(t))},h.prototype.readCString=function(t){var e=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),n=e;t!=null&&(n=Math.min(t,e));for(var a=0;a<n&&r[a]!==0;a++);var p=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(a)]);return t!=null?this.position+=n-a:a!=e&&(this.position+=1),p};var m=Math.pow(2,32);h.prototype.readInt64=function(){return this.readInt32()*m+this.readUint32()},h.prototype.readUint64=function(){return this.readUint32()*m+this.readUint32()},h.prototype.readInt64=function(){return this.readUint32()*m+this.readUint32()},h.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},l.DataStream=h,h.prototype.save=function(t){var e=new Blob([this.buffer]);if(window.URL&&URL.createObjectURL){var r=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.setAttribute("href",r),n.setAttribute("download",t),n.setAttribute("target","_self"),n.click(),window.URL.revokeObjectURL(r)}else throw"DataStream.save: Can't create object URL."},h.prototype._dynamicSize=!0,Object.defineProperty(h.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),h.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),r=new Uint8Array(e),n=new Uint8Array(this._buffer,t,r.length);r.set(n),this.buffer=e,this.position-=t},h.prototype.writeInt32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt32(t[r],e)},h.prototype.writeInt16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeInt16(t[r],e)},h.prototype.writeInt8Array=function(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},h.prototype.writeUint32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint32(t[r],e)},h.prototype.writeUint16Array=function(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeUint16(t[r],e)},h.prototype.writeUint8Array=function(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},h.prototype.writeFloat64Array=function(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat64(t[r],e)},h.prototype.writeFloat32Array=function(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)h.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var r=0;r<t.length;r++)this.writeFloat32(t[r],e)},h.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,e!=null?e:this.endianness),this.position+=4},h.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,e!=null?e:this.endianness),this.position+=2},h.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},h.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,e!=null?e:this.endianness),this.position+=4},h.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,e!=null?e:this.endianness),this.position+=2},h.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},h.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,e!=null?e:this.endianness),this.position+=4},h.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,e!=null?e:this.endianness),this.position+=8},h.prototype.writeUCS2String=function(t,e,r){r==null&&(r=t.length);for(var n=0;n<t.length&&n<r;n++)this.writeUint16(t.charCodeAt(n),e);for(;n<r;n++)this.writeUint16(0)},h.prototype.writeString=function(t,e,r){var n=0;if(e==null||e=="ASCII")if(r!=null){var a=Math.min(t.length,r);for(n=0;n<a;n++)this.writeUint8(t.charCodeAt(n));for(;n<r;n++)this.writeUint8(0)}else for(n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,r)))},h.prototype.writeCString=function(t,e){var r=0;if(e!=null){var n=Math.min(t.length,e);for(r=0;r<n;r++)this.writeUint8(t.charCodeAt(r));for(;r<e;r++)this.writeUint8(0)}else{for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));this.writeUint8(0)}},h.prototype.writeStruct=function(t,e){for(var r=0;r<t.length;r+=2){var n=t[r+1];this.writeType(n,e[t[r]],e)}},h.prototype.writeType=function(t,e,r){var n;if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,r);var a=null,p="ASCII",c=this.position;switch(typeof t=="string"&&/:/.test(t)&&(n=t.split(":"),t=n[0],a=parseInt(n[1])),typeof t=="string"&&/,/.test(t)&&(n=t.split(","),t=n[0],p=parseInt(n[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,h.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,h.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,h.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,h.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,h.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,h.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,h.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,h.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,h.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,h.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,h.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,h.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,a);break;case"string":this.writeString(e,p,a);break;case"u16string":this.writeUCS2String(e,this.endianness,a);break;case"u16stringle":this.writeUCS2String(e,h.LITTLE_ENDIAN,a);break;case"u16stringbe":this.writeUCS2String(e,h.BIG_ENDIAN,a);break;default:if(t.length==3){for(var u=t[1],f=0;f<e.length;f++)this.writeType(u,e[f]);break}else{this.writeStruct(t,e);break}}a!=null&&(this.position=c,this._realloc(a),this.position=c+a)},h.prototype.writeUint64=function(t){var e=Math.floor(t/m);this.writeUint32(e),this.writeUint32(t&4294967295)},h.prototype.writeUint24=function(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)},h.prototype.adjustUint32=function(t,e){var r=this.position;this.seek(t),this.writeUint32(e),this.seek(r)},h.prototype.mapInt32Array=function(t,e){this._realloc(t*4);var r=new Int32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(r,e!=null?e:this.endianness),this.position+=t*4,r},h.prototype.mapInt16Array=function(t,e){this._realloc(t*2);var r=new Int16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(r,e!=null?e:this.endianness),this.position+=t*2,r},h.prototype.mapInt8Array=function(t){this._realloc(t*1);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e},h.prototype.mapUint32Array=function(t,e){this._realloc(t*4);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(r,e!=null?e:this.endianness),this.position+=t*4,r},h.prototype.mapUint16Array=function(t,e){this._realloc(t*2);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(r,e!=null?e:this.endianness),this.position+=t*2,r},h.prototype.mapFloat64Array=function(t,e){this._realloc(t*8);var r=new Float64Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(r,e!=null?e:this.endianness),this.position+=t*8,r},h.prototype.mapFloat32Array=function(t,e){this._realloc(t*4);var r=new Float32Array(this._buffer,this.byteOffset+this.position,t);return h.arrayToNative(r,e!=null?e:this.endianness),this.position+=t*4,r};var g=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};g.prototype=new h(new ArrayBuffer,0,h.BIG_ENDIAN),g.prototype.initialized=function(){var t;return this.bufferIndex>-1?!0:this.buffers.length>0?(t=this.buffers[0],t.fileStart===0?(this.buffer=t,this.bufferIndex=0,o.debug("MultiBufferStream","Stream ready for parsing"),!0):(o.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)):(o.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1)},ArrayBuffer.concat=function(t,e){o.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(e),t.byteLength),r.buffer},g.prototype.reduceBuffer=function(t,e,r){var n;return n=new Uint8Array(r),n.set(new Uint8Array(t,e,r)),n.buffer.fileStart=t.fileStart+e,n.buffer.usedBytes=0,n.buffer},g.prototype.insertBuffer=function(t){for(var e=!0,r=0;r<this.buffers.length;r++){var n=this.buffers[r];if(t.fileStart<=n.fileStart){if(t.fileStart===n.fileStart)if(t.byteLength>n.byteLength){this.buffers.splice(r,1),r--;continue}else o.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=n.fileStart||(t=this.reduceBuffer(t,0,n.fileStart-t.fileStart)),o.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(r,0,t),r===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<n.fileStart+n.byteLength){var a=n.fileStart+n.byteLength-t.fileStart,p=t.byteLength-a;if(p>0)t=this.reduceBuffer(t,a,p);else{e=!1;break}}}e&&(o.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),r===0&&(this.buffer=t))},g.prototype.logBufferLevel=function(t){var e,r,n,a,p=[],c,u="";for(n=0,a=0,e=0;e<this.buffers.length;e++)r=this.buffers[e],e===0?(c={},p.push(c),c.start=r.fileStart,c.end=r.fileStart+r.byteLength,u+="["+c.start+"-"):c.end===r.fileStart?c.end=r.fileStart+r.byteLength:(c={},c.start=r.fileStart,u+=p[p.length-1].end-1+"], ["+c.start+"-",c.end=r.fileStart+r.byteLength,p.push(c)),n+=r.usedBytes,a+=r.byteLength;p.length>0&&(u+=c.end-1+"]");var f=t?o.info:o.debug;this.buffers.length===0?f("MultiBufferStream","No more buffer in memory"):f("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+n+"/"+a+" bytes), continuous ranges: "+u)},g.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)e=this.buffers[t],e.usedBytes===e.byteLength&&(o.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},g.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length)if(t=this.buffers[this.bufferIndex+1],t.fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,r=this.buffer.usedBytes,n=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=r,this.buffer.fileStart=n,o.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1;else return!1},g.prototype.findPosition=function(t,e,r){var n,a=null,p=-1;for(t===!0?n=0:n=this.bufferIndex;n<this.buffers.length&&(a=this.buffers[n],a.fileStart<=e);)p=n,r&&(a.fileStart+a.byteLength<=e?a.usedBytes=a.byteLength:a.usedBytes=e-a.fileStart,this.logBufferLevel()),n++;return p!==-1?(a=this.buffers[p],a.fileStart+a.byteLength>=e?(o.debug("MultiBufferStream","Found position in existing buffer #"+p),p):-1):-1},g.prototype.findEndContiguousBuf=function(t){var e,r,n,a=t!==void 0?t:this.bufferIndex;if(r=this.buffers[a],this.buffers.length>a+1)for(e=a+1;e<this.buffers.length&&(n=this.buffers[e],n.fileStart===r.fileStart+r.byteLength);e++)r=n;return r.fileStart+r.byteLength},g.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t},g.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},g.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},g.prototype.seek=function(t,e,r){var n;return n=this.findPosition(e,t,r),n!==-1?(this.buffer=this.buffers[n],this.bufferIndex=n,this.position=t-this.buffer.fileStart,o.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(o.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},g.prototype.getPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},g.prototype.getLength=function(){return this.byteLength},g.prototype.getEndPosition=function(){if(this.bufferIndex===-1||this.buffers[this.bufferIndex]===null)throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},l.MultiBufferStream=g;var U=function(){var t=3,e=4,r=5,n=6,a=[];a[t]="ES_Descriptor",a[e]="DecoderConfigDescriptor",a[r]="DecoderSpecificInfo",a[n]="SLConfigDescriptor",this.getDescriptorName=function(u){return a[u]};var p=this,c={};return this.parseOneDescriptor=function(u){var f=0,b,v,w;for(b=u.readUint8(),w=u.readUint8();w&128;)f=(w&127)<<7,w=u.readUint8();return f+=w&127,o.debug("MPEG4DescriptorParser","Found "+(a[b]||"Descriptor "+b)+", size "+f+" at position "+u.getPosition()),a[b]?v=new c[a[b]](f):v=new c.Descriptor(f),v.parse(u),v},c.Descriptor=function(u,f){this.tag=u,this.size=f,this.descs=[]},c.Descriptor.prototype.parse=function(u){this.data=u.readUint8Array(this.size)},c.Descriptor.prototype.findDescriptor=function(u){for(var f=0;f<this.descs.length;f++)if(this.descs[f].tag==u)return this.descs[f];return null},c.Descriptor.prototype.parseRemainingDescriptors=function(u){for(var f=u.position;u.position<f+this.size;){var b=p.parseOneDescriptor(u);this.descs.push(b)}},c.ES_Descriptor=function(u){c.Descriptor.call(this,t,u)},c.ES_Descriptor.prototype=new c.Descriptor,c.ES_Descriptor.prototype.parse=function(u){if(this.ES_ID=u.readUint16(),this.flags=u.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=u.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){var f=u.readUint8();this.URL=u.readString(f),this.size-=f+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=u.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(u)},c.ES_Descriptor.prototype.getOTI=function(u){var f=this.findDescriptor(e);return f?f.oti:0},c.ES_Descriptor.prototype.getAudioConfig=function(u){var f=this.findDescriptor(e);if(!f)return null;var b=f.findDescriptor(r);if(b&&b.data){var v=(b.data[0]&248)>>3;return v===31&&b.data.length>=2&&(v=32+((b.data[0]&7)<<3)+((b.data[1]&224)>>5)),v}else return null},c.DecoderConfigDescriptor=function(u){c.Descriptor.call(this,e,u)},c.DecoderConfigDescriptor.prototype=new c.Descriptor,c.DecoderConfigDescriptor.prototype.parse=function(u){this.oti=u.readUint8(),this.streamType=u.readUint8(),this.bufferSize=u.readUint24(),this.maxBitrate=u.readUint32(),this.avgBitrate=u.readUint32(),this.size-=13,this.parseRemainingDescriptors(u)},c.DecoderSpecificInfo=function(u){c.Descriptor.call(this,r,u)},c.DecoderSpecificInfo.prototype=new c.Descriptor,c.SLConfigDescriptor=function(u){c.Descriptor.call(this,n,u)},c.SLConfigDescriptor.prototype=new c.Descriptor,this};l.MPEG4DescriptorParser=U;var s={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"],["grpl"],["j2kH"],["etyp",["tyco"]]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){s.FullBox.prototype=new s.Box,s.ContainerBox.prototype=new s.Box,s.SampleEntry.prototype=new s.Box,s.TrackGroupTypeBox.prototype=new s.FullBox,s.BASIC_BOXES.forEach(function(t){s.createBoxCtor(t)}),s.FULL_BOXES.forEach(function(t){s.createFullBoxCtor(t)}),s.CONTAINER_BOXES.forEach(function(t){s.createContainerBoxCtor(t[0],null,t[1])})},Box:function(t,e,r){this.type=t,this.size=e,this.uuid=r},FullBox:function(t,e,r){s.Box.call(this,t,e,r),this.flags=0,this.version=0},ContainerBox:function(t,e,r){s.Box.call(this,t,e,r),this.boxes=[]},SampleEntry:function(t,e,r,n){s.ContainerBox.call(this,t,e),this.hdr_size=r,this.start=n},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){s.FullBox.call(this,t,e)},createBoxCtor:function(t,e){s.boxCodes.push(t),s[t+"Box"]=function(r){s.Box.call(this,t,r)},s[t+"Box"].prototype=new s.Box,e&&(s[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){s[t+"Box"]=function(r){s.FullBox.call(this,t,r)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(r){this.parseFullHeader(r),e&&e.call(this,r)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,r=0;r<e;r++)this[t[r]+"s"]=[]}},createContainerBoxCtor:function(t,e,r){s[t+"Box"]=function(n){s.ContainerBox.call(this,t,n),s.addSubBoxArrays.call(this,r)},s[t+"Box"].prototype=new s.ContainerBox,e&&(s[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,r){s.sampleEntryCodes[t]=[],s[t+"SampleEntry"]=function(n,a){s.SampleEntry.call(this,n,a),s.addSubBoxArrays.call(this,r)},s[t+"SampleEntry"].prototype=new s.SampleEntry,e&&(s[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,r,n){s.sampleEntryCodes[t].push(e),s[e+"SampleEntry"]=function(a){s[t+"SampleEntry"].call(this,e,a),s.addSubBoxArrays.call(this,n)},s[e+"SampleEntry"].prototype=new s[t+"SampleEntry"],r&&(s[e+"SampleEntry"].prototype.parse=r)},createEncryptedSampleEntryCtor:function(t,e,r){s.createSampleEntryCtor.call(this,t,e,r,["sinf"])},createSampleGroupCtor:function(t,e){s[t+"SampleGroupEntry"]=function(r){s.SampleGroupEntry.call(this,t,r)},s[t+"SampleGroupEntry"].prototype=new s.SampleGroupEntry,e&&(s[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){s[t+"TrackGroupTypeBox"]=function(r){s.TrackGroupTypeBox.call(this,t,r)},s[t+"TrackGroupTypeBox"].prototype=new s.TrackGroupTypeBox,e&&(s[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,r,n){s.UUIDs.push(t),s.UUIDBoxes[t]=function(a){e?s.FullBox.call(this,"uuid",a,t):r?s.ContainerBox.call(this,"uuid",a,t):s.Box.call(this,"uuid",a,t)},s.UUIDBoxes[t].prototype=e?new s.FullBox:r?new s.ContainerBox:new s.Box,n&&(e?s.UUIDBoxes[t].prototype.parse=function(a){this.parseFullHeader(a),n&&n.call(this,a)}:s.UUIDBoxes[t].prototype.parse=n)}};s.initialize(),s.TKHD_FLAG_ENABLED=1,s.TKHD_FLAG_IN_MOVIE=2,s.TKHD_FLAG_IN_PREVIEW=4,s.TFHD_FLAG_BASE_DATA_OFFSET=1,s.TFHD_FLAG_SAMPLE_DESC=2,s.TFHD_FLAG_SAMPLE_DUR=8,s.TFHD_FLAG_SAMPLE_SIZE=16,s.TFHD_FLAG_SAMPLE_FLAGS=32,s.TFHD_FLAG_DUR_EMPTY=65536,s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,s.TRUN_FLAGS_DATA_OFFSET=1,s.TRUN_FLAGS_FIRST_FLAG=4,s.TRUN_FLAGS_DURATION=256,s.TRUN_FLAGS_SIZE=512,s.TRUN_FLAGS_FLAGS=1024,s.TRUN_FLAGS_CTS_OFFSET=2048,s.Box.prototype.add=function(t){return this.addBox(new s[t+"Box"])},s.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},s.Box.prototype.set=function(t,e){return this[t]=e,this},s.Box.prototype.addEntry=function(t,e){var r=e||"entries";return this[r]||(this[r]=[]),this[r].push(t),this},l.BoxParser=s,s.parseUUID=function(t){return s.parseHex16(t)},s.parseHex16=function(t){for(var e="",r=0;r<16;r++){var n=t.readUint8().toString(16);e+=n.length===1?"0"+n:n}return e},s.parseOneBox=function(t,e,r){var n,a=t.getPosition(),p=0,c,u;if(t.getEndPosition()-a<8)return o.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:s.ERR_NOT_ENOUGH_DATA};if(r&&r<8)return o.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:s.ERR_NOT_ENOUGH_DATA};var f=t.readUint32(),b=t.readString(4),v=b;if(o.debug("BoxParser","Found box of type '"+b+"' and size "+f+" at position "+a),p=8,b=="uuid"){if(t.getEndPosition()-t.getPosition()<16||r-p<16)return t.seek(a),o.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:s.ERR_NOT_ENOUGH_DATA};u=s.parseUUID(t),p+=16,v=u}if(f==1){if(t.getEndPosition()-t.getPosition()<8||r&&r-p<8)return t.seek(a),o.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+b+'" box'),{code:s.ERR_NOT_ENOUGH_DATA};f=t.readUint64(),p+=8}else if(f===0){if(r)f=r;else if(b!=="mdat")return o.error("BoxParser","Unlimited box size not supported for type: '"+b+"'"),n=new s.Box(b,f),{code:s.OK,box:n,size:n.size}}return f!==0&&f<p?(o.error("BoxParser","Box of type "+b+" has an invalid size "+f+" (too small to be a box)"),{code:s.ERR_NOT_ENOUGH_DATA,type:b,size:f,hdr_size:p,start:a}):f!==0&&r&&f>r?(o.error("BoxParser","Box of type '"+b+"' has a size "+f+" greater than its container size "+r),{code:s.ERR_NOT_ENOUGH_DATA,type:b,size:f,hdr_size:p,start:a}):f!==0&&a+f>t.getEndPosition()?(t.seek(a),o.info("BoxParser","Not enough data in stream to parse the entire '"+b+"' box"),{code:s.ERR_NOT_ENOUGH_DATA,type:b,size:f,hdr_size:p,start:a}):e?{code:s.OK,type:b,size:f,hdr_size:p,start:a}:(s[b+"Box"]?n=new s[b+"Box"](f):b!=="uuid"?(o.warn("BoxParser","Unknown box type: '"+b+"'"),n=new s.Box(b,f),n.has_unparsed_data=!0):s.UUIDBoxes[u]?n=new s.UUIDBoxes[u](f):(o.warn("BoxParser","Unknown uuid type: '"+u+"'"),n=new s.Box(b,f),n.uuid=u,n.has_unparsed_data=!0),n.hdr_size=p,n.start=a,n.write===s.Box.prototype.write&&n.type!=="mdat"&&(o.info("BoxParser","'"+v+"' box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),c=t.getPosition()-(n.start+n.size),c<0?(o.warn("BoxParser","Parsing of box '"+v+"' did not read the entire indicated box data size (missing "+-c+" bytes), seeking forward"),t.seek(n.start+n.size)):c>0&&(o.error("BoxParser","Parsing of box '"+v+"' read "+c+" more bytes than the indicated box data size, seeking backwards"),n.size!==0&&t.seek(n.start+n.size)),{code:s.OK,box:n,size:n.size})},s.Box.prototype.parse=function(t){this.type!="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},s.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},s.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},s.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.ContainerBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)if(r=e.box,this.boxes.push(r),this.subBoxNames&&this.subBoxNames.indexOf(r.type)!=-1)this[this.subBoxNames[this.subBoxNames.indexOf(r.type)]+"s"].push(r);else{var n=r.type!=="uuid"?r.type:r.uuid;this[n]?o.warn("Box of type "+n+" already stored in field of this type"):this[n]=r}else return},s.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},s.SAMPLE_ENTRY_TYPE_VISUAL="Visual",s.SAMPLE_ENTRY_TYPE_AUDIO="Audio",s.SAMPLE_ENTRY_TYPE_HINT="Hint",s.SAMPLE_ENTRY_TYPE_METADATA="Metadata",s.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",s.SAMPLE_ENTRY_TYPE_SYSTEM="System",s.SAMPLE_ENTRY_TYPE_TEXT="Text",s.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},s.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},s.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},s.SampleEntry.prototype.parseFooter=function(t){s.ContainerBox.prototype.parse.call(this,t)},s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_HINT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}),s.createMediaSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dav1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"hvt1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"lhe1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvh1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"dvhe"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"avs3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"j2ki"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjp2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"mjpg"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"uncv"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ac-4"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mha2"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm1"),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"mhm2"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_TEXT,"enct"),s.createEncryptedSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"encm"),s.createBoxCtor("a1lx",function(t){var e=t.readUint8()&1,r=((e&1)+1)*16;this.layer_size=[];for(var n=0;n<3;n++)r==16?this.layer_size[n]=t.readUint16():this.layer_size[n]=t.readUint32()}),s.createBoxCtor("a1op",function(t){this.op_index=t.readUint8()}),s.createFullBoxCtor("auxC",function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)}),s.createBoxCtor("av1C",function(t){var e=t.readUint8();if(e>>7&!1){o.error("av1C marker problem");return}if(this.version=e&127,this.version!==1){o.error("av1C version "+this.version+" not supported");return}if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=e&31,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=e&3,e=t.readUint8(),this.reserved_1=e>>5&7,this.reserved_1!==0){o.error("av1C reserved_1 parsing problem");return}if(this.initial_presentation_delay_present=e>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=e&15;else if(this.reserved_2=e&15,this.reserved_2!==0){o.error("av1C reserved_2 parsing problem");return}var r=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(r)}),s.createBoxCtor("avcC",function(t){var e,r;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=t.readUint8()&3,this.nb_SPS_nalus=t.readUint8()&31,r=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),r-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),r--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),r-=2+this.PPS[e].length;r>0&&(this.ext=t.readUint8Array(r))}),s.createBoxCtor("btrt",function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()}),s.createFullBoxCtor("ccst",function(t){var e=t.readUint8();this.all_ref_pics_intra=(e&128)==128,this.intra_pred_used=(e&64)==64,this.max_ref_per_pic=(e&63)>>2,t.readUint24()}),s.createBoxCtor("cdef",function(t){var e;for(this.channel_count=t.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[],e=0;e<this.channel_count;e++)this.channel_indexes.push(t.readUint16()),this.channel_types.push(t.readUint16()),this.channel_associations.push(t.readUint16())}),s.createBoxCtor("clap",function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()}),s.createBoxCtor("clli",function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()}),s.createFullBoxCtor("cmex",function(t){this.flags&1&&(this.pos_x=t.readInt32()),this.flags&2&&(this.pos_y=t.readInt32()),this.flags&4&&(this.pos_z=t.readInt32()),this.flags&8&&(this.version==0?this.flags&16?(this.quat_x=t.readInt32(),this.quat_y=t.readInt32(),this.quat_z=t.readInt32()):(this.quat_x=t.readInt16(),this.quat_y=t.readInt16(),this.quat_z=t.readInt16()):this.version==1),this.flags&32&&(this.id=t.readUint32())}),s.createFullBoxCtor("cmin",function(t){this.focal_length_x=t.readInt32(),this.principal_point_x=t.readInt32(),this.principal_point_y=t.readInt32(),this.flags&1&&(this.focal_length_y=t.readInt32(),this.skew_factor=t.readInt32())}),s.createBoxCtor("cmpd",function(t){for(this.component_count=t.readUint16(),this.component_types=[],this.component_type_urls=[],i=0;i<this.component_count;i++){var e=t.readUint16();this.component_types.push(e),e>=32768&&this.component_type_urls.push(t.readCString())}}),s.createFullBoxCtor("co64",function(t){var e,r;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(r=0;r<e;r++)this.chunk_offsets.push(t.readUint64())}),s.createFullBoxCtor("CoLL",function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()}),s.createBoxCtor("colr",function(t){if(this.colour_type=t.readString(4),this.colour_type==="nclx"){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else this.colour_type==="rICC"?this.ICC_profile=t.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=t.readUint8Array(this.size-4))}),s.createFullBoxCtor("cprt",function(t){this.parseLanguage(t),this.notice=t.readCString()}),s.createFullBoxCtor("cslg",function(t){this.version===0&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())}),s.createFullBoxCtor("ctts",function(t){var e,r;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],this.version===0)for(r=0;r<e;r++){this.sample_counts.push(t.readUint32());var n=t.readInt32();n<0&&o.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(n)}else if(this.version==1)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())}),s.createBoxCtor("dac3",function(t){var e=t.readUint8(),r=t.readUint8(),n=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(e&1)<<2|r>>6&3,this.acmod=r>>3&7,this.lfeon=r>>2&1,this.bit_rate_code=r&3|n>>5&7}),s.createBoxCtor("dec3",function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=e&7,this.ind_subs=[];for(var r=0;r<this.num_ind_sub+1;r++){var n={};this.ind_subs.push(n);var a=t.readUint8(),p=t.readUint8(),c=t.readUint8();n.fscod=a>>6,n.bsid=a>>1&31,n.bsmod=(a&1)<<4|p>>4&15,n.acmod=p>>1&7,n.lfeon=p&1,n.num_dep_sub=c>>1&15,n.num_dep_sub>0&&(n.chan_loc=(c&1)<<8|t.readUint8())}}),s.createFullBoxCtor("dfLa",function(t){var e=127,r=128,n=[],a=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];this.parseFullHeader(t);do{var p=t.readUint8(),c=Math.min(p&e,a.length-1);if(c?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),n.push(a[c]),p&r)break}while(!0);this.numMetadataBlocks=n.length+" ("+n.join(", ")+")"}),s.createBoxCtor("dimm",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("dmed",function(t){this.bytessent=t.readUint64()}),s.createBoxCtor("dOps",function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}}),s.createFullBoxCtor("dref",function(t){var e,r;this.entries=[];for(var n=t.readUint32(),a=0;a<n;a++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)r=e.box,this.entries.push(r);else return}),s.createBoxCtor("drep",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("elng",function(t){this.extended_language=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("elst",function(t){this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var n={};this.entries.push(n),this.version===1?(n.segment_duration=t.readUint64(),n.media_time=t.readInt64()):(n.segment_duration=t.readUint32(),n.media_time=t.readInt32()),n.media_rate_integer=t.readInt16(),n.media_rate_fraction=t.readInt16()}}),s.createFullBoxCtor("emsg",function(t){this.version==1?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version==1&&(e-=4),this.message_data=t.readUint8Array(e)}),s.createEntityToGroupCtor=function(t,e){s[t+"Box"]=function(r){s.FullBox.call(this,t,r)},s[t+"Box"].prototype=new s.FullBox,s[t+"Box"].prototype.parse=function(r){if(this.parseFullHeader(r),e)e.call(this,r);else for(this.group_id=r.readUint32(),this.num_entities_in_group=r.readUint32(),this.entity_ids=[],i=0;i<this.num_entities_in_group;i++){var n=r.readUint32();this.entity_ids.push(n)}}},s.createEntityToGroupCtor("aebr"),s.createEntityToGroupCtor("afbr"),s.createEntityToGroupCtor("albc"),s.createEntityToGroupCtor("altr"),s.createEntityToGroupCtor("brst"),s.createEntityToGroupCtor("dobr"),s.createEntityToGroupCtor("eqiv"),s.createEntityToGroupCtor("favc"),s.createEntityToGroupCtor("fobr"),s.createEntityToGroupCtor("iaug"),s.createEntityToGroupCtor("pano"),s.createEntityToGroupCtor("slid"),s.createEntityToGroupCtor("ster"),s.createEntityToGroupCtor("tsyn"),s.createEntityToGroupCtor("wbbr"),s.createEntityToGroupCtor("prgr"),s.createFullBoxCtor("esds",function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(this.data=e,typeof U<"u"){var r=new U;this.esd=r.parseOneDescriptor(new h(e.buffer,0,h.BIG_ENDIAN))}}),s.createBoxCtor("fiel",function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()}),s.createBoxCtor("frma",function(t){this.data_format=t.readString(4)}),s.createBoxCtor("ftyp",function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var r=0;e>=4;)this.compatible_brands[r]=t.readString(4),e-=4,r++}),s.createFullBoxCtor("hdlr",function(t){this.version===0&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),this.name[this.name.length-1]==="\0"&&(this.name=this.name.slice(0,-1)))}),s.createBoxCtor("hvcC",function(t){var e,r,n,a;this.configurationVersion=t.readUint8(),a=t.readUint8(),this.general_profile_space=a>>6,this.general_tier_flag=(a&32)>>5,this.general_profile_idc=a&31,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=t.readUint16()&4095,this.parallelismType=t.readUint8()&3,this.chroma_format_idc=t.readUint8()&3,this.bit_depth_luma_minus8=t.readUint8()&7,this.bit_depth_chroma_minus8=t.readUint8()&7,this.avgFrameRate=t.readUint16(),a=t.readUint8(),this.constantFrameRate=a>>6,this.numTemporalLayers=(a&13)>>3,this.temporalIdNested=(a&4)>>2,this.lengthSizeMinusOne=a&3,this.nalu_arrays=[];var p=t.readUint8();for(e=0;e<p;e++){var c=[];this.nalu_arrays.push(c),a=t.readUint8(),c.completeness=(a&128)>>7,c.nalu_type=a&63;var u=t.readUint16();for(r=0;r<u;r++){var f={};c.push(f),n=t.readUint16(),f.data=t.readUint8Array(n)}}}),s.createFullBoxCtor("iinf",function(t){var e;this.version===0?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var r=0;r<this.entry_count;r++)if(e=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),e.code===s.OK)e.box.type!=="infe"&&o.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[r]=e.box;else return}),s.createFullBoxCtor("iloc",function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=e&15,e=t.readUint8(),this.base_offset_size=e>>4&15,this.version===1||this.version===2?this.index_size=e&15:this.index_size=0,this.items=[];var r=0;if(this.version<2)r=t.readUint16();else if(this.version===2)r=t.readUint32();else throw"version of iloc box not supported";for(var n=0;n<r;n++){var a={};if(this.items.push(a),this.version<2)a.item_ID=t.readUint16();else if(this.version===2)a.item_ID=t.readUint16();else throw"version of iloc box not supported";switch(this.version===1||this.version===2?a.construction_method=t.readUint16()&15:a.construction_method=0,a.data_reference_index=t.readUint16(),this.base_offset_size){case 0:a.base_offset=0;break;case 4:a.base_offset=t.readUint32();break;case 8:a.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var p=t.readUint16();a.extents=[];for(var c=0;c<p;c++){var u={};if(a.extents.push(u),this.version===1||this.version===2)switch(this.index_size){case 0:u.extent_index=0;break;case 4:u.extent_index=t.readUint32();break;case 8:u.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:u.extent_offset=0;break;case 4:u.extent_offset=t.readUint32();break;case 8:u.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:u.extent_length=0;break;case 4:u.extent_length=t.readUint32();break;case 8:u.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}}),s.createBoxCtor("imir",function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=e&1}),s.createFullBoxCtor("infe",function(t){if((this.version===0||this.version===1)&&(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),this.version===1){this.extension_type=t.readString(4),o.warn("BoxParser","Cannot parse extension type"),t.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=t.readUint16():this.version===3&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),this.item_type==="mime"?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):this.item_type==="uri "&&(this.item_uri_type=t.readCString()))}),s.createFullBoxCtor("ipma",function(t){var e,r;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var n={};this.associations.push(n),this.version<1?n.id=t.readUint16():n.id=t.readUint32();var a=t.readUint8();for(n.props=[],r=0;r<a;r++){var p=t.readUint8(),c={};n.props.push(c),c.essential=(p&128)>>7===1,this.flags&1?c.property_index=(p&127)<<8|t.readUint8():c.property_index=p&127}}}),s.createFullBoxCtor("iref",function(t){var e,r;for(this.references=[];t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)this.version===0?r=new s.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):r=new s.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start),r.write===s.Box.prototype.write&&r.type!=="mdat"&&(o.warn("BoxParser",r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.references.push(r);else return}),s.createBoxCtor("irot",function(t){this.angle=t.readUint8()&3}),s.createFullBoxCtor("ispe",function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()}),s.createFullBoxCtor("kind",function(t){this.schemeURI=t.readCString(),this.value=t.readCString()}),s.createFullBoxCtor("leva",function(t){var e=t.readUint8();this.levels=[];for(var r=0;r<e;r++){var n={};this.levels[r]=n,n.track_ID=t.readUint32();var a=t.readUint8();switch(n.padding_flag=a>>7,n.assignment_type=a&127,n.assignment_type){case 0:n.grouping_type=t.readString(4);break;case 1:n.grouping_type=t.readString(4),n.grouping_type_parameter=t.readUint32();break;case 2:break;case 3:break;case 4:n.sub_track_id=t.readUint32();break;default:o.warn("BoxParser","Unknown leva assignement type")}}}),s.createBoxCtor("lsel",function(t){this.layer_id=t.readUint16()}),s.createBoxCtor("maxr",function(t){this.period=t.readUint32(),this.bytes=t.readUint32()}),s.createBoxCtor("mdcv",function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()}),s.createFullBoxCtor("mdhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()}),s.createFullBoxCtor("mehd",function(t){this.flags&1&&(o.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version==1?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()}),s.createFullBoxCtor("meta",function(t){this.boxes=[],s.ContainerBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("mfhd",function(t){this.sequence_number=t.readUint32()}),s.createFullBoxCtor("mfro",function(t){this._size=t.readUint32()}),s.createFullBoxCtor("mvhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()}),s.createBoxCtor("npck",function(t){this.packetssent=t.readUint32()}),s.createBoxCtor("nump",function(t){this.packetssent=t.readUint64()}),s.createFullBoxCtor("padb",function(t){var e=t.readUint32();this.padbits=[];for(var r=0;r<Math.floor((e+1)/2);r++)this.padbits=t.readUint8()}),s.createBoxCtor("pasp",function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()}),s.createBoxCtor("payl",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createBoxCtor("payt",function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)}),s.createFullBoxCtor("pdin",function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var r=0;r<e;r++)this.rate[r]=t.readUint32(),this.initial_delay[r]=t.readUint32()}),s.createFullBoxCtor("pitm",function(t){this.version===0?this.item_id=t.readUint16():this.item_id=t.readUint32()}),s.createFullBoxCtor("pixi",function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()}),s.createBoxCtor("pmax",function(t){this.bytes=t.readUint32()}),s.createFullBoxCtor("prdi",function(t){if(this.step_count=t.readUint16(),this.item_count=[],this.flags&2)for(var e=0;e<this.step_count;e++)this.item_count[e]=t.readUint16()}),s.createFullBoxCtor("prft",function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),this.version===0?this.media_time=t.readUint32():this.media_time=t.readUint64()}),s.createFullBoxCtor("pssh",function(t){if(this.system_id=s.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var r=0;r<e;r++)this.kid[r]=s.parseHex16(t)}var n=t.readUint32();n>0&&(this.data=t.readUint8Array(n))}),s.createFullBoxCtor("clef",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("enof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createFullBoxCtor("prof",function(t){this.width=t.readUint32(),this.height=t.readUint32()}),s.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),s.createBoxCtor("rtp ",function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)}),s.createFullBoxCtor("saio",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var r=0;r<e;r++)this.version===0?this.offset[r]=t.readUint32():this.offset[r]=t.readUint64()}),s.createFullBoxCtor("saiz",function(t){this.flags&1&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],this.default_sample_info_size===0)for(var r=0;r<e;r++)this.sample_info_size[r]=t.readUint8()}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"mett",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"metx",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}),s.createSampleEntryCtor(s.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",function(t){this.parseHeader(t),this.parseFooter(t)}),s.createSampleGroupCtor("alst",function(t){var e,r=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<r;e++)this.sample_offset[e]=t.readUint32();var n=this.description_length-4-4*r;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<n/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()}),s.createSampleGroupCtor("avll",function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}),s.createSampleGroupCtor("avss",function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var r=t.readUint8(),n=0;n<r;n++){var a={};this.dependency.push(a),a.subSeqDirectionFlag=t.readUint8(),a.layerNumber=t.readUint8(),a.subSequenceIdentifier=t.readUint16()}}),s.createSampleGroupCtor("dtrt",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("mvif",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("prol",function(t){this.roll_distance=t.readInt16()}),s.createSampleGroupCtor("rap ",function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}),s.createSampleGroupCtor("rash",function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)o.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}),s.createSampleGroupCtor("roll",function(t){this.roll_distance=t.readInt16()}),s.SampleGroupEntry.prototype.parse=function(t){o.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},s.createSampleGroupCtor("scif",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("scnm",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("seig",function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=s.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}),s.createSampleGroupCtor("stsa",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("sync",function(t){var e=t.readUint8();this.NAL_unit_type=e&63}),s.createSampleGroupCtor("tele",function(t){var e=t.readUint8();this.level_independently_decodable=e>>7}),s.createSampleGroupCtor("tsas",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("tscl",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createSampleGroupCtor("vipr",function(t){o.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}),s.createFullBoxCtor("sbgp",function(t){this.grouping_type=t.readString(4),this.version===1?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var n={};this.entries.push(n),n.sample_count=t.readInt32(),n.group_description_index=t.readInt32()}}),s.createFullBoxCtor("schm",function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),this.flags&1&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))}),s.createBoxCtor("sdp ",function(t){this.sdptext=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("sdtp",function(t){var e,r=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var n=0;n<r;n++)e=t.readUint8(),this.is_leading[n]=e>>6,this.sample_depends_on[n]=e>>4&3,this.sample_is_depended_on[n]=e>>2&3,this.sample_has_redundancy[n]=e&3}),s.createFullBoxCtor("senc"),s.createFullBoxCtor("sgpd",function(t){this.grouping_type=t.readString(4),o.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var n;s[this.grouping_type+"SampleGroupEntry"]?n=new s[this.grouping_type+"SampleGroupEntry"](this.grouping_type):n=new s.SampleGroupEntry(this.grouping_type),this.entries.push(n),this.version===1?this.default_length===0?n.description_length=t.readUint32():n.description_length=this.default_length:n.description_length=this.default_length,n.write===s.SampleGroupEntry.prototype.write&&(o.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),n.data=t.readUint8Array(n.description_length),t.position-=n.description_length),n.parse(t)}}),s.createFullBoxCtor("sidx",function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),this.version===0?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),r=0;r<e;r++){var n={};this.references.push(n);var a=t.readUint32();n.reference_type=a>>31&1,n.referenced_size=a&2147483647,n.subsegment_duration=t.readUint32(),a=t.readUint32(),n.starts_with_SAP=a>>31&1,n.SAP_type=a>>28&7,n.SAP_delta_time=a&268435455}}),s.SingleItemTypeReferenceBox=function(t,e,r,n){s.Box.call(this,t,e),this.hdr_size=r,this.start=n},s.SingleItemTypeReferenceBox.prototype=new s.Box,s.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var r=0;r<e;r++)this.references[r]={},this.references[r].to_item_ID=t.readUint16()},s.SingleItemTypeReferenceBoxLarge=function(t,e,r,n){s.Box.call(this,t,e),this.hdr_size=r,this.start=n},s.SingleItemTypeReferenceBoxLarge.prototype=new s.Box,s.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var r=0;r<e;r++)this.references[r]={},this.references[r].to_item_ID=t.readUint32()},s.createFullBoxCtor("SmDm",function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()}),s.createFullBoxCtor("smhd",function(t){this.balance=t.readUint16(),t.readUint16()}),s.createFullBoxCtor("ssix",function(t){this.subsegments=[];for(var e=t.readUint32(),r=0;r<e;r++){var n={};this.subsegments.push(n),n.ranges=[];for(var a=t.readUint32(),p=0;p<a;p++){var c={};n.ranges.push(c),c.level=t.readUint8(),c.range_size=t.readUint24()}}}),s.createFullBoxCtor("stco",function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],this.version===0)for(var r=0;r<e;r++)this.chunk_offsets.push(t.readUint32())}),s.createFullBoxCtor("stdp",function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var r=0;r<e;r++)this.priority[r]=t.readUint16()}),s.createFullBoxCtor("sthd"),s.createFullBoxCtor("stri",function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var r=0;r<e;r++)this.attribute_list[r]=t.readUint32()}),s.createFullBoxCtor("stsc",function(t){var e,r;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(r=0;r<e;r++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())}),s.createFullBoxCtor("stsd",function(t){var e,r,n,a;for(this.entries=[],n=t.readUint32(),e=1;e<=n;e++)if(r=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),r.code===s.OK)s[r.type+"SampleEntry"]?(a=new s[r.type+"SampleEntry"](r.size),a.hdr_size=r.hdr_size,a.start=r.start):(o.warn("BoxParser","Unknown sample entry type: "+r.type),a=new s.SampleEntry(r.type,r.size,r.hdr_size,r.start)),a.write===s.SampleEntry.prototype.write&&(o.info("BoxParser","SampleEntry "+a.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),a.parseDataAndRewind(t)),a.parse(t),this.entries.push(a);else return}),s.createFullBoxCtor("stsg",function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var r=0;r<e;r++)this.group_description_index[r]=t.readUint32()}),s.createFullBoxCtor("stsh",function(t){var e,r;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(r=0;r<e;r++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stss",function(t){var e,r;if(r=t.readUint32(),this.version===0)for(this.sample_numbers=[],e=0;e<r;e++)this.sample_numbers.push(t.readUint32())}),s.createFullBoxCtor("stsz",function(t){var e;if(this.sample_sizes=[],this.version===0)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)this.sample_size===0?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size}),s.createFullBoxCtor("stts",function(t){var e,r,n;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],this.version===0)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),n=t.readInt32(),n<0&&(o.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),n=1),this.sample_deltas.push(n)}),s.createFullBoxCtor("stvi",function(t){var e=t.readUint32();this.single_view_allowed=e&3,this.stereo_scheme=t.readUint32();var r=t.readUint32();this.stereo_indication_type=t.readString(r);var n,a;for(this.boxes=[];t.getPosition()<this.start+this.size;)if(n=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),n.code===s.OK)a=n.box,this.boxes.push(a),this[a.type]=a;else return}),s.createBoxCtor("styp",function(t){s.ftypBox.prototype.parse.call(this,t)}),s.createFullBoxCtor("stz2",function(t){var e,r;if(this.sample_sizes=[],this.version===0)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),r=t.readUint32(),this.field_size===4)for(e=0;e<r;e+=2){var n=t.readUint8();this.sample_sizes[e]=n>>4&15,this.sample_sizes[e+1]=n&15}else if(this.field_size===8)for(e=0;e<r;e++)this.sample_sizes[e]=t.readUint8();else if(this.field_size===16)for(e=0;e<r;e++)this.sample_sizes[e]=t.readUint16();else o.error("BoxParser","Error in length field in stz2 box")}),s.createFullBoxCtor("subs",function(t){var e,r,n,a;for(n=t.readUint32(),this.entries=[],e=0;e<n;e++){var p={};if(this.entries[e]=p,p.sample_delta=t.readUint32(),p.subsamples=[],a=t.readUint16(),a>0)for(r=0;r<a;r++){var c={};p.subsamples.push(c),this.version==1?c.size=t.readUint32():c.size=t.readUint16(),c.priority=t.readUint8(),c.discardable=t.readUint8(),c.codec_specific_parameters=t.readUint32()}}}),s.createFullBoxCtor("tenc",function(t){if(t.readUint8(),this.version===0)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=e&15}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=s.parseHex16(t),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))}),s.createFullBoxCtor("tfdt",function(t){this.version==1?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()}),s.createFullBoxCtor("tfhd",function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&s.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0}),s.createFullBoxCtor("tfra",function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=e&3,this.entries=[];for(var r=t.readUint32(),n=0;n<r;n++)this.version===1?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()}),s.createFullBoxCtor("tkhd",function(t){this.version==1?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()}),s.createBoxCtor("tmax",function(t){this.time=t.readUint32()}),s.createBoxCtor("tmin",function(t){this.time=t.readUint32()}),s.createBoxCtor("totl",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpay",function(t){this.bytessent=t.readUint32()}),s.createBoxCtor("tpyl",function(t){this.bytessent=t.readUint64()}),s.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},s.createTrackGroupCtor("msrc"),s.TrackReferenceTypeBox=function(t,e,r,n){s.Box.call(this,t,e),this.hdr_size=r,this.start=n},s.TrackReferenceTypeBox.prototype=new s.Box,s.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},s.trefBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;)if(e=s.parseOneBox(t,!0,this.size-(t.getPosition()-this.start)),e.code===s.OK)r=new s.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start),r.write===s.Box.prototype.write&&r.type!=="mdat"&&(o.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.boxes.push(r);else return},s.createFullBoxCtor("trep",function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;)if(ret=s.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code===s.OK)box=ret.box,this.boxes.push(box);else return}),s.createFullBoxCtor("trex",function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()}),s.createBoxCtor("trpy",function(t){this.bytessent=t.readUint64()}),s.createFullBoxCtor("trun",function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&s.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var r=0;r<this.sample_count;r++)this.flags&s.TRUN_FLAGS_DURATION&&(this.sample_duration[r]=t.readUint32()),this.flags&s.TRUN_FLAGS_SIZE&&(this.sample_size[r]=t.readUint32()),this.flags&s.TRUN_FLAGS_FLAGS&&(this.sample_flags[r]=t.readUint32()),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?this.sample_composition_time_offset[r]=t.readUint32():this.sample_composition_time_offset[r]=t.readInt32())}),s.createFullBoxCtor("tsel",function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var r=0;r<e;r++)this.attribute_list[r]=t.readUint32()}),s.createFullBoxCtor("txtC",function(t){this.config=t.readCString()}),s.createBoxCtor("tyco",function(t){var e=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(var r=0;r<e;r++)this.compatible_brands[r]=t.readString(4)}),s.createFullBoxCtor("udes",function(t){this.lang=t.readCString(),this.name=t.readCString(),this.description=t.readCString(),this.tags=t.readCString()}),s.createFullBoxCtor("uncC",function(t){var e;for(this.profile=t.readUint32(),this.component_count=t.readUint16(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[],e=0;e<this.component_count;e++)this.component_index.push(t.readUint16()),this.component_bit_depth_minus_one.push(t.readUint8()),this.component_format.push(t.readUint8()),this.component_align_size.push(t.readUint8());this.sampling_type=t.readUint8(),this.interleave_type=t.readUint8(),this.block_size=t.readUint8();var r=t.readUint8();this.component_little_endian=r>>7&1,this.block_pad_lsb=r>>6&1,this.block_little_endian=r>>5&1,this.block_reversed=r>>4&1,this.pad_unknown=r>>3&1,this.pixel_size=t.readUint8(),this.row_align_size=t.readUint32(),this.tile_align_size=t.readUint32(),this.num_tile_cols_minus_one=t.readUint32(),this.num_tile_rows_minus_one=t.readUint32()}),s.createFullBoxCtor("url ",function(t){this.flags!==1&&(this.location=t.readCString())}),s.createFullBoxCtor("urn ",function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())}),s.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),s.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,function(t){this.system_id=s.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))}),s.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),s.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=s.parseHex16(t)}),s.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var r={},n=0,a=0;this.version===1?(n=t.readUint64(),a=t.readUint64()):(n=t.readUint32(),a=t.readUint32()),r.absolute_time=n,r.absolute_duration=a,this.entries.push(r)}}),s.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,function(t){this.version===1?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())}),s.createFullBoxCtor("vmhd",function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)}),s.createFullBoxCtor("vpcC",function(t){var e;this.version===1?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=e&1,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=e&15,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=e&1,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))}),s.createBoxCtor("vttC",function(t){this.text=t.readString(this.size-this.hdr_size)}),s.createFullBoxCtor("vvcC",function(t){var e,r,n={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(S){this.held_bits=S.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(S){this.held_bits=S.readUint16(),this.num_held_bits=16},extract_bits:function(S){var N=this.held_bits>>this.num_held_bits-S&(1<<S)-1;return this.num_held_bits-=S,N}};if(n.stream_read_1_bytes(t),n.extract_bits(5),this.lengthSizeMinusOne=n.extract_bits(2),this.ptl_present_flag=n.extract_bits(1),this.ptl_present_flag){n.stream_read_2_bytes(t),this.ols_idx=n.extract_bits(9),this.num_sublayers=n.extract_bits(3),this.constant_frame_rate=n.extract_bits(2),this.chroma_format_idc=n.extract_bits(2),n.stream_read_1_bytes(t),this.bit_depth_minus8=n.extract_bits(3),n.extract_bits(5);{if(n.stream_read_2_bytes(t),n.extract_bits(2),this.num_bytes_constraint_info=n.extract_bits(6),this.general_profile_idc=n.extract_bits(7),this.general_tier_flag=n.extract_bits(1),this.general_level_idc=t.readUint8(),n.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=n.extract_bits(1),this.ptl_multilayer_enabled_flag=n.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var a=n.extract_bits(6);n.stream_read_1_bytes(t);var p=n.extract_bits(2);this.general_constraint_info[e]=a<<2|p}this.general_constraint_info[this.num_bytes_constraint_info-1]=n.extract_bits(6)}else n.extract_bits(6);if(this.num_sublayers>1){for(n.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,r=this.num_sublayers-2;r>=0;--r){var c=n.extract_bits(1);this.ptl_sublayer_present_mask|=c<<r}for(r=this.num_sublayers;r<=8&&this.num_sublayers>1;++r)n.extract_bits(1);for(this.sublayer_level_idc=[],r=this.num_sublayers-2;r>=0;--r)this.ptl_sublayer_present_mask&1<<r&&(this.sublayer_level_idc[r]=t.readUint8())}if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32())}this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}var u=12,f=13;this.nalu_arrays=[];var b=t.readUint8();for(e=0;e<b;e++){var v=[];this.nalu_arrays.push(v),n.stream_read_1_bytes(t),v.completeness=n.extract_bits(1),n.extract_bits(2),v.nalu_type=n.extract_bits(5);var w=1;for(v.nalu_type!=f&&v.nalu_type!=u&&(w=t.readUint16()),r=0;r<w;r++){var C=t.readUint16();v.push({data:t.readUint8Array(C),length:C})}}}),s.createFullBoxCtor("vvnC",function(t){var e=strm.readUint8();this.lengthSizeMinusOne=e&3}),s.SampleEntry.prototype.isVideo=function(){return!1},s.SampleEntry.prototype.isAudio=function(){return!1},s.SampleEntry.prototype.isSubtitle=function(){return!1},s.SampleEntry.prototype.isMetadata=function(){return!1},s.SampleEntry.prototype.isHint=function(){return!1},s.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},s.SampleEntry.prototype.getWidth=function(){return""},s.SampleEntry.prototype.getHeight=function(){return""},s.SampleEntry.prototype.getChannelCount=function(){return""},s.SampleEntry.prototype.getSampleRate=function(){return""},s.SampleEntry.prototype.getSampleSize=function(){return""},s.VisualSampleEntry.prototype.isVideo=function(){return!0},s.VisualSampleEntry.prototype.getWidth=function(){return this.width},s.VisualSampleEntry.prototype.getHeight=function(){return this.height},s.AudioSampleEntry.prototype.isAudio=function(){return!0},s.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},s.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},s.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},s.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},s.MetadataSampleEntry.prototype.isMetadata=function(){return!0},s.decimalToHex=function(t,e){var r=Number(t).toString(16);for(e=typeof e>"u"||e===null?e=2:e;r.length<e;)r="0"+r;return r},s.avc1SampleEntry.prototype.getCodec=s.avc2SampleEntry.prototype.getCodec=s.avc3SampleEntry.prototype.getCodec=s.avc4SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+s.decimalToHex(this.avcC.AVCProfileIndication)+s.decimalToHex(this.avcC.profile_compatibility)+s.decimalToHex(this.avcC.AVCLevelIndication):t},s.hev1SampleEntry.prototype.getCodec=s.hvc1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C";break}e+=this.hvcC.general_profile_idc,e+=".";var r=this.hvcC.general_profile_compatibility,n=0;for(t=0;t<32&&(n|=r&1,t!=31);t++)n<<=1,r>>=1;e+=s.decimalToHex(n,0),e+=".",this.hvcC.general_tier_flag===0?e+="L":e+="H",e+=this.hvcC.general_level_idc;var a=!1,p="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||a)&&(p="."+s.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+p,a=!0);e+=p}return e},s.vvc1SampleEntry.prototype.getCodec=s.vvi1SampleEntry.prototype.getCodec=function(){var t,e=s.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var r="";if(this.vvcC.general_constraint_info){var n=[],a=0;a|=this.vvcC.ptl_frame_only_constraint<<7,a|=this.vvcC.ptl_multilayer_enabled<<6;var p;for(t=0;t<this.vvcC.general_constraint_info.length;++t)a|=this.vvcC.general_constraint_info[t]>>2&63,n.push(a),a&&(p=t),a=this.vvcC.general_constraint_info[t]>>2&3;if(p===void 0)r=".CA";else{r=".C";var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",u=0,f=0;for(t=0;t<=p;++t)for(u=u<<8|n[t],f+=8;f>=5;){var b=u>>f-5&31;r+=c[b],f-=5,u&=(1<<f)-1}f&&(u<<=5-f,r+=c[u&31])}}e+=r}return e},s.mp4aSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),r=this.esds.esd.getAudioConfig();return t+"."+s.decimalToHex(e)+(r?"."+r:"")}else return t},s.stxtSampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},s.vp08SampleEntry.prototype.getCodec=s.vp09SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;e==0&&(e="00");var r=this.vpcC.bitDepth;return r==8&&(r="08"),t+".0"+this.vpcC.profile+"."+e+"."+r},s.av01SampleEntry.prototype.getCodec=function(){var t=s.SampleEntry.prototype.getCodec.call(this),e=this.av1C.seq_level_idx_0;e<10&&(e="0"+e);var r;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?r=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(r=this.av1C.high_bitdepth===1?"10":"08"),t+"."+this.av1C.seq_profile+"."+e+(this.av1C.seq_tier_0?"H":"M")+"."+r},s.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>m&&(this.size+=8),this.type==="uuid"&&(this.size+=16),o.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>m?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),this.type==="uuid"&&t.writeUint8Array(this.uuid),this.size>m&&t.writeUint64(this.size)},s.FullBox.prototype.writeHeader=function(t){this.size+=4,s.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},s.Box.prototype.write=function(t){this.type==="mdat"?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},s.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.TrackReferenceTypeBox.prototype.write=function(t){this.size=this.track_ids.length*4,this.writeHeader(t),t.writeUint32Array(this.track_ids)},s.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},s.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},s.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},s.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),this.version===1?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},s.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},s.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var r=this.entries[e];t.writeUint32(r.segment_duration),t.writeInt32(r.media_time),t.writeInt16(r.media_rate_integer),t.writeInt16(r.media_rate_fraction)}},s.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},s.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},s.hdlrBox.prototype.write=function(t){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},s.hvcCBox.prototype.write=function(t){var e,r;for(this.size=23,e=0;e<this.nalu_arrays.length;e++)for(this.size+=3,r=0;r<this.nalu_arrays[e].length;r++)this.size+=2+this.nalu_arrays[e][r].data.length;for(this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.general_profile_space<<6+this.general_tier_flag<<5+this.general_profile_idc),t.writeUint32(this.general_profile_compatibility),t.writeUint8Array(this.general_constraint_indicator),t.writeUint8(this.general_level_idc),t.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),t.writeUint8(this.parallelismType+252),t.writeUint8(this.chroma_format_idc+252),t.writeUint8(this.bit_depth_luma_minus8+248),t.writeUint8(this.bit_depth_chroma_minus8+248),t.writeUint16(this.avgFrameRate),t.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),t.writeUint8(this.nalu_arrays.length),e=0;e<this.nalu_arrays.length;e++)for(t.writeUint8((this.nalu_arrays[e].completeness<<7)+this.nalu_arrays[e].nalu_type),t.writeUint16(this.nalu_arrays[e].length),r=0;r<this.nalu_arrays[e].length;r++)t.writeUint16(this.nalu_arrays[e][r].data.length),t.writeUint8Array(this.nalu_arrays[e][r].data)},s.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},s.mdhdBox.prototype.write=function(t){this.size=4*4+2*2,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},s.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},s.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},s.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=23*4+2*2,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},s.SampleEntry.prototype.writeHeader=function(t){this.size=8,s.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},s.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},s.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},s.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},s.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},s.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var r=this.entries[e];t.writeInt32(r.sample_count),t.writeInt32(r.group_description_index)}},s.sgpdBox.prototype.write=function(t){var e,r;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)r=this.entries[e],this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=r.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),this.version===1&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)r=this.entries[e],this.version===1&&this.default_length===0&&t.writeUint32(r.description_length),r.write(t)},s.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*4+2+2+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var r=this.references[e];t.writeUint32(r.reference_type<<31|r.referenced_size),t.writeUint32(r.subsegment_duration),t.writeUint32(r.starts_with_SAP<<31|r.SAP_type<<28|r.SAP_delta_time)}},s.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},s.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},s.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},s.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;o.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},s.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},s.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},s.stszBox.prototype.write=function(t){var e,r=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;)if(this.sample_sizes[e+1]!==this.sample_sizes[0]){r=!1;break}else e++;else r=!1;this.size=8,r||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),r?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),r||t.writeUint32Array(this.sample_sizes)},s.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},s.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,this.version===1&&(this.size+=4),this.writeHeader(t),this.version===1?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},s.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&s.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&s.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&s.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&s.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&s.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},s.tkhdBox.prototype.write=function(t){this.version=0,this.size=4*18+2*4,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},s.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},s.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&s.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&s.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&s.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&s.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&s.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&s.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&s.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&s.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&s.TRUN_FLAGS_CTS_OFFSET&&(this.version===0?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},s["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},s["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},s.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},s.cttsBox.prototype.unpack=function(t){var e,r,n;for(n=0,e=0;e<this.sample_counts.length;e++)for(r=0;r<this.sample_counts[e];r++)t[n].pts=t[n].dts+this.sample_offsets[e],n++},s.sttsBox.prototype.unpack=function(t){var e,r,n;for(n=0,e=0;e<this.sample_counts.length;e++)for(r=0;r<this.sample_counts[e];r++)n===0?t[n].dts=0:t[n].dts=t[n-1].dts+this.sample_deltas[e],n++},s.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},s.stscBox.prototype.unpack=function(t){var e,r,n,a,p;for(a=0,p=0,e=0;e<this.first_chunk.length;e++)for(r=0;r<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);r++)for(p++,n=0;n<this.samples_per_chunk[e];n++){if(t[a])t[a].description_index=this.sample_description_index[e],t[a].chunk_index=p;else return;a++}},s.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},s.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],s.boxEqualFields=function(t,e){if(t&&!e)return!1;var r;for(r in t)if(!(s.DIFF_BOXES_PROP_NAMES.indexOf(r)>-1)){if(t[r]instanceof s.Box||e[r]instanceof s.Box||typeof t[r]>"u"||typeof e[r]>"u"||typeof t[r]=="function"||typeof e[r]=="function"||t.subBoxNames&&t.subBoxNames.indexOf(r.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(r.slice(0,4))>-1||r==="data"||r==="start"||r==="size"||r==="creation_time"||r==="modification_time"||s.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(r)>-1)continue;if(t[r]!==e[r])return!1}return!0},s.boxEqual=function(t,e){if(!s.boxEqualFields(t,e))return!1;for(var r=0;r<s.DIFF_BOXES_PROP_NAMES.length;r++){var n=s.DIFF_BOXES_PROP_NAMES[r];if(t[n]&&e[n]&&!s.boxEqual(t[n],e[n]))return!1}return!0};var A=function(){};A.prototype.parseSample=function(t){var e={},r;e.resources=[];var n=new d(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=n.readString(t.data.length);else if(e.documentString=n.readString(t.subsamples[0].size),t.subsamples.length>1)for(r=1;r<t.subsamples.length;r++)e.resources[r]=n.readUint8Array(t.subsamples[r].size);return typeof DOMParser<"u"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e};var z=function(){};z.prototype.parseSample=function(t){var e,r=new d(t.data.buffer);return e=r.readString(t.data.length),e},z.prototype.parseConfig=function(t){var e,r=new d(t.buffer);return r.readUint32(),e=r.readCString(),e},l.XMLSubtitlein4Parser=A,l.Textin4Parser=z;var _=function(t){this.stream=t||new g,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};_.prototype.setSegmentOptions=function(t,e,r){var n=this.getTrackById(t);if(n){var a={};this.fragmentedTracks.push(a),a.id=t,a.user=e,a.trak=n,n.nextSample=0,a.segmentStream=null,a.nb_samples=1e3,a.rapAlignement=!0,r&&(r.nbSamples&&(a.nb_samples=r.nbSamples),r.rapAlignement&&(a.rapAlignement=r.rapAlignement))}},_.prototype.unsetSegmentOptions=function(t){for(var e=-1,r=0;r<this.fragmentedTracks.length;r++){var n=this.fragmentedTracks[r];n.id==t&&(e=r)}e>-1&&this.fragmentedTracks.splice(e,1)},_.prototype.setExtractionOptions=function(t,e,r){var n=this.getTrackById(t);if(n){var a={};this.extractedTracks.push(a),a.id=t,a.user=e,a.trak=n,n.nextSample=0,a.nb_samples=1e3,a.samples=[],r&&r.nbSamples&&(a.nb_samples=r.nbSamples)}},_.prototype.unsetExtractionOptions=function(t){for(var e=-1,r=0;r<this.extractedTracks.length;r++){var n=this.extractedTracks[r];n.id==t&&(e=r)}e>-1&&this.extractedTracks.splice(e,1)},_.prototype.parse=function(){var t,e,r=!1;if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else if(this.saveParsePosition&&this.saveParsePosition(),t=s.parseOneBox(this.stream,r),t.code===s.ERR_NOT_ENOUGH_DATA)if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}else return;else{var n;switch(e=t.box,n=e.type!=="uuid"?e.type:e.uuid,this.boxes.push(e),n){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[n]!==void 0&&o.warn("ISOFile","Duplicate Box of type: "+n+", overriding previous occurrence"),this[n]=e;break}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},_.prototype.checkBuffer=function(t){if(t==null)throw"Buffer must be defined and non empty";if(t.fileStart===void 0)throw"Buffer must have a fileStart property";return t.byteLength===0?(o.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(o.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(o.warn("ISOFile","Not ready to start parsing"),!1))},_.prototype.appendBuffer=function(t,e){var r;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(r=this.nextSeekPosition,this.nextSeekPosition=void 0):r=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(r=this.stream.getEndFilePositionAfter(r))):this.nextParsePosition?r=this.nextParsePosition:r=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(o.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+r),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),o.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),r},_.prototype.getInfo=function(){var t,e,r={},n,a,p,c,u=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(r.hasMoov=!0,r.duration=this.moov.mvhd.duration,r.timescale=this.moov.mvhd.timescale,r.isFragmented=this.moov.mvex!=null,r.isFragmented&&this.moov.mvex.mehd&&(r.fragment_duration=this.moov.mvex.mehd.fragment_duration),r.isProgressive=this.isProgressive,r.hasIOD=this.moov.iods!=null,r.brands=[],r.brands.push(this.ftyp.major_brand),r.brands=r.brands.concat(this.ftyp.compatible_brands),r.created=new Date(u+this.moov.mvhd.creation_time*1e3),r.modified=new Date(u+this.moov.mvhd.modification_time*1e3),r.tracks=[],r.audioTracks=[],r.videoTracks=[],r.subtitleTracks=[],r.metadataTracks=[],r.hintTracks=[],r.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(n=this.moov.traks[t],c=n.mdia.minf.stbl.stsd.entries[0],a={},r.tracks.push(a),a.id=n.tkhd.track_id,a.name=n.mdia.hdlr.name,a.references=[],n.tref)for(e=0;e<n.tref.boxes.length;e++)p={},a.references.push(p),p.type=n.tref.boxes[e].type,p.track_ids=n.tref.boxes[e].track_ids;n.edts&&(a.edits=n.edts.elst.entries),a.created=new Date(u+n.tkhd.creation_time*1e3),a.modified=new Date(u+n.tkhd.modification_time*1e3),a.movie_duration=n.tkhd.duration,a.movie_timescale=r.timescale,a.layer=n.tkhd.layer,a.alternate_group=n.tkhd.alternate_group,a.volume=n.tkhd.volume,a.matrix=n.tkhd.matrix,a.track_width=n.tkhd.width/65536,a.track_height=n.tkhd.height/65536,a.timescale=n.mdia.mdhd.timescale,a.cts_shift=n.mdia.minf.stbl.cslg,a.duration=n.mdia.mdhd.duration,a.samples_duration=n.samples_duration,a.codec=c.getCodec(),a.kind=n.udta&&n.udta.kinds.length?n.udta.kinds[0]:{schemeURI:"",value:""},a.language=n.mdia.elng?n.mdia.elng.extended_language:n.mdia.mdhd.languageString,a.nb_samples=n.samples.length,a.size=n.samples_size,a.bitrate=a.size*8*a.timescale/a.samples_duration,c.isAudio()?(a.type="audio",r.audioTracks.push(a),a.audio={},a.audio.sample_rate=c.getSampleRate(),a.audio.channel_count=c.getChannelCount(),a.audio.sample_size=c.getSampleSize()):c.isVideo()?(a.type="video",r.videoTracks.push(a),a.video={},a.video.width=c.getWidth(),a.video.height=c.getHeight()):c.isSubtitle()?(a.type="subtitles",r.subtitleTracks.push(a)):c.isHint()?(a.type="metadata",r.hintTracks.push(a)):c.isMetadata()?(a.type="metadata",r.metadataTracks.push(a)):(a.type="metadata",r.otherTracks.push(a))}else r.hasMoov=!1;if(r.mime="",r.hasMoov&&r.tracks){for(r.videoTracks&&r.videoTracks.length>0?r.mime+='video/mp4; codecs="':r.audioTracks&&r.audioTracks.length>0?r.mime+='audio/mp4; codecs="':r.mime+='application/mp4; codecs="',t=0;t<r.tracks.length;t++)t!==0&&(r.mime+=","),r.mime+=r.tracks[t].codec;r.mime+='"; profiles="',r.mime+=this.ftyp.compatible_brands.join(),r.mime+='"'}return r},_.prototype.setNextSeekPositionFromSample=function(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)},_.prototype.processSamples=function(t){var e,r;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==null)for(e=0;e<this.fragmentedTracks.length;e++){var n=this.fragmentedTracks[e];for(r=n.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){o.debug("ISOFile","Creating media fragment on track #"+n.id+" for sample "+r.nextSample);var a=this.createFragment(n.id,r.nextSample,n.segmentStream);if(a)n.segmentStream=a,r.nextSample++;else break;if((r.nextSample%n.nb_samples===0||t||r.nextSample>=r.samples.length)&&(o.info("ISOFile","Sending fragmented data on track #"+n.id+" for samples ["+Math.max(0,r.nextSample-n.nb_samples)+","+(r.nextSample-1)+"]"),o.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(n.id,n.user,n.segmentStream.buffer,r.nextSample,t||r.nextSample>=r.samples.length),n.segmentStream=null,n!==this.fragmentedTracks[e]))break}}if(this.onSamples!==null)for(e=0;e<this.extractedTracks.length;e++){var p=this.extractedTracks[e];for(r=p.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){o.debug("ISOFile","Exporting on track #"+p.id+" sample #"+r.nextSample);var c=this.getSample(r,r.nextSample);if(c)r.nextSample++,p.samples.push(c);else{this.setNextSeekPositionFromSample(r.samples[r.nextSample]);break}if((r.nextSample%p.nb_samples===0||r.nextSample>=r.samples.length)&&(o.debug("ISOFile","Sending samples on track #"+p.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(p.id,p.user,p.samples),p.samples=[],p!==this.extractedTracks[e]))break}}}},_.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},_.prototype.getBoxes=function(t,e){var r=[];return _._sweep.call(this,t,r,e),r},_._sweep=function(t,e,r){this.type&&this.type==t&&e.push(this);for(var n in this.boxes){if(e.length&&r)return;_._sweep.call(this.boxes[n],t,e,r)}},_.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);if(e)return e.samples},_.prototype.getTrackSample=function(t,e){var r=this.getTrackById(t),n=this.getSample(r,e);return n},_.prototype.releaseUsedSamples=function(t,e){var r=0,n=this.getTrackById(t);n.lastValidSample||(n.lastValidSample=0);for(var a=n.lastValidSample;a<e;a++)r+=this.releaseSample(n,a);o.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+r+", remaining: "+this.samplesDataSize+")"),n.lastValidSample=e},_.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},_.prototype.stop=function(){this.sampleProcessingStarted=!1},_.prototype.flush=function(){o.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},_.prototype.seekTrack=function(t,e,r){var n,a,p=1/0,c=0,u=0,f;if(r.samples.length===0)return o.info("ISOFile","No sample in track, cannot seek! Using time "+o.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(n=0;n<r.samples.length;n++){if(a=r.samples[n],n===0)u=0,f=a.timescale;else if(a.cts>t*a.timescale){u=n-1;break}e&&a.is_sync&&(c=n)}for(e&&(u=c),t=r.samples[u].cts,r.nextSample=u;r.samples[u].alreadyRead===r.samples[u].size&&r.samples[u+1];)u++;return p=r.samples[u].offset+r.samples[u].alreadyRead,o.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+r.nextSample+" on track "+r.tkhd.track_id+", time "+o.getDurationString(t,f)+" and offset: "+p),{offset:p,time:t/f}},_.prototype.getTrackDuration=function(t){var e;return t.samples?(e=t.samples[t.samples.length-1],(e.cts+e.duration)/e.timescale):1/0},_.prototype.seek=function(t,e){var r=this.moov,n,a,p,c={offset:1/0,time:1/0};if(this.moov){for(p=0;p<r.traks.length;p++)n=r.traks[p],!(t>this.getTrackDuration(n))&&(a=this.seekTrack(t,e,n),a.offset<c.offset&&(c.offset=a.offset),a.time<c.time&&(c.time=a.time));return o.info("ISOFile","Seeking at time "+o.getDurationString(c.time,1)+" needs a buffer with a fileStart position of "+c.offset),c.offset===1/0?c={offset:this.nextParsePosition,time:0}:c.offset=this.stream.getEndFilePositionAfter(c.offset),o.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+c.offset),c}else throw"Cannot seek: moov not received!"},_.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var r=this.boxes[e],n=t.boxes[e];if(!s.boxEqual(r,n))return!1;e++}return!0},l.ISOFile=_,_.prototype.lastBoxStartPosition=0,_.prototype.parsingMdat=null,_.prototype.nextParsePosition=0,_.prototype.discardMdatData=!1,_.prototype.processIncompleteBox=function(t){var e,r,n;return t.type==="mdat"?(e=new s[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,n=this.stream.seek(e.start+e.size,!1,this.discardMdatData),n?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):(t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),r=this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1,r?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},_.prototype.hasIncompleteMdat=function(){return this.parsingMdat!==null},_.prototype.processIncompleteMdat=function(){var t,e;return t=this.parsingMdat,e=this.stream.seek(t.start+t.size,!1,this.discardMdatData),e?(o.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},_.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},_.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},_.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},_.prototype.add=s.Box.prototype.add,_.prototype.addBox=s.Box.prototype.addBox,_.prototype.init=function(t){var e=t||{};this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]);var r=this.add("moov");return r.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),r.add("mvex"),this},_.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var r=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,r.add("tkhd").set("flags",s.TKHD_FLAG_ENABLED|s.TKHD_FLAG_IN_MOVIE|s.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var n=r.add("mdia");n.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),n.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),n.add("elng").set("extended_language",e.language||"fr-FR");var a=n.add("minf");if(s[e.type+"SampleEntry"]!==void 0){var p=new s[e.type+"SampleEntry"];p.data_reference_index=1;var c="";for(var u in s.sampleEntryCodes)for(var f=s.sampleEntryCodes[u],b=0;b<f.length;b++)if(f.indexOf(e.type)>-1){c=u;break}switch(c){case"Visual":if(a.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),p.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var v=new s.avcCBox;v.parse(new d(e.avcDecoderConfigRecord)),p.addBox(v)}else if(e.hevcDecoderConfigRecord){var w=new s.hvcCBox;w.parse(new d(e.hevcDecoderConfigRecord)),p.addBox(w)}break;case"Audio":a.add("smhd").set("balance",e.balance||0),p.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":a.add("hmhd");break;case"Subtitle":switch(a.add("sthd"),e.type){case"stpp":p.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break}break;case"Metadata":a.add("nmhd");break;case"System":a.add("nmhd");break;default:a.add("nmhd");break}e.description&&p.addBox(e.description),e.description_boxes&&e.description_boxes.forEach(function(S){p.addBox(S)}),a.add("dinf").add("dref").addEntry(new s["url Box"]().set("flags",1));var C=a.add("stbl");return C.add("stsd").addEntry(p),C.add("stts").set("sample_counts",[]).set("sample_deltas",[]),C.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),C.add("stco").set("chunk_offsets",[]),C.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(r),e.id}},s.Box.prototype.computeSize=function(t){var e=t||new h;e.endianness=h.BIG_ENDIAN,this.write(e)},_.prototype.addSample=function(t,e,r){var n=r||{},a={},p=this.getTrackById(t);if(p!==null){a.number=p.samples.length,a.track_id=p.tkhd.track_id,a.timescale=p.mdia.mdhd.timescale,a.description_index=n.sample_description_index?n.sample_description_index-1:0,a.description=p.mdia.minf.stbl.stsd.entries[a.description_index],a.data=e,a.size=e.byteLength,a.alreadyRead=a.size,a.duration=n.duration||1,a.cts=n.cts||0,a.dts=n.dts||0,a.is_sync=n.is_sync||!1,a.is_leading=n.is_leading||0,a.depends_on=n.depends_on||0,a.is_depended_on=n.is_depended_on||0,a.has_redundancy=n.has_redundancy||0,a.degradation_priority=n.degradation_priority||0,a.offset=0,a.subsamples=n.subsamples,p.samples.push(a),p.samples_size+=a.size,p.samples_duration+=a.duration,p.first_dts===void 0&&(p.first_dts=n.dts),this.processSamples();var c=this.createSingleSampleMoof(a);return this.addBox(c),c.computeSize(),c.trafs[0].truns[0].data_offset=c.size+8,this.add("mdat").data=new Uint8Array(e),a}},_.prototype.createSingleSampleMoof=function(t){var e=0;t.is_sync?e=1<<25:e=65536;var r=new s.moofBox;r.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var n=r.add("traf"),a=this.getTrackById(t.track_id);return n.add("tfhd").set("track_id",t.track_id).set("flags",s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),n.add("tfdt").set("baseMediaDecodeTime",t.dts-(a.first_dts||0)),n.add("trun").set("flags",s.TRUN_FLAGS_DATA_OFFSET|s.TRUN_FLAGS_DURATION|s.TRUN_FLAGS_SIZE|s.TRUN_FLAGS_FLAGS|s.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),r},_.prototype.lastMoofIndex=0,_.prototype.samplesDataSize=0,_.prototype.resetTables=function(){var t,e,r,n,a,p,c,u;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){e=this.moov.traks[t],e.tkhd.duration=0,e.mdia.mdhd.duration=0,r=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64,r.chunk_offsets=[],n=e.mdia.minf.stbl.stsc,n.first_chunk=[],n.samples_per_chunk=[],n.sample_description_index=[],a=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2,a.sample_sizes=[],p=e.mdia.minf.stbl.stts,p.sample_counts=[],p.sample_deltas=[],c=e.mdia.minf.stbl.ctts,c&&(c.sample_counts=[],c.sample_offsets=[]),u=e.mdia.minf.stbl.stss;var f=e.mdia.minf.stbl.boxes.indexOf(u);f!=-1&&(e.mdia.minf.stbl.boxes[f]=null)}},_.initSampleGroups=function(t,e,r,n,a){var p,c,u,f;function b(v,w,C){this.grouping_type=v,this.grouping_type_parameter=w,this.sbgp=C,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),c=0;c<r.length;c++){for(f=r[c].grouping_type+"/"+r[c].grouping_type_parameter,u=new b(r[c].grouping_type,r[c].grouping_type_parameter,r[c]),e&&(e.sample_groups_info[f]=u),t.sample_groups_info[f]||(t.sample_groups_info[f]=u),p=0;p<n.length;p++)n[p].grouping_type===r[c].grouping_type&&(u.description=n[p],u.description.used=!0);if(a)for(p=0;p<a.length;p++)a[p].grouping_type===r[c].grouping_type&&(u.fragment_description=a[p],u.fragment_description.used=!0,u.is_fragment=!0)}if(e){if(a)for(c=0;c<a.length;c++)!a[c].used&&a[c].version>=2&&(f=a[c].grouping_type+"/0",u=new b(a[c].grouping_type,0),u.is_fragment=!0,e.sample_groups_info[f]||(e.sample_groups_info[f]=u))}else for(c=0;c<n.length;c++)!n[c].used&&n[c].version>=2&&(f=n[c].grouping_type+"/0",u=new b(n[c].grouping_type,0),t.sample_groups_info[f]||(t.sample_groups_info[f]=u))},_.setSampleGroupProperties=function(t,e,r,n){var a,p;e.sample_groups=[];for(a in n)if(e.sample_groups[a]={},e.sample_groups[a].grouping_type=n[a].grouping_type,e.sample_groups[a].grouping_type_parameter=n[a].grouping_type_parameter,r>=n[a].last_sample_in_run&&(n[a].last_sample_in_run<0&&(n[a].last_sample_in_run=0),n[a].entry_index++,n[a].entry_index<=n[a].sbgp.entries.length-1&&(n[a].last_sample_in_run+=n[a].sbgp.entries[n[a].entry_index].sample_count)),n[a].entry_index<=n[a].sbgp.entries.length-1?e.sample_groups[a].group_description_index=n[a].sbgp.entries[n[a].entry_index].group_description_index:e.sample_groups[a].group_description_index=-1,e.sample_groups[a].group_description_index!==0){var c;n[a].fragment_description?c=n[a].fragment_description:c=n[a].description,e.sample_groups[a].group_description_index>0?(e.sample_groups[a].group_description_index>65535?p=(e.sample_groups[a].group_description_index>>16)-1:p=e.sample_groups[a].group_description_index-1,c&&p>=0&&(e.sample_groups[a].description=c.entries[p])):c&&c.version>=2&&c.default_group_description_index>0&&(e.sample_groups[a].description=c.entries[c.default_group_description_index-1])}},_.process_sdtp=function(t,e,r){e&&(t?(e.is_leading=t.is_leading[r],e.depends_on=t.sample_depends_on[r],e.is_depended_on=t.sample_is_depended_on[r],e.has_redundancy=t.sample_has_redundancy[r]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},_.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},_.prototype.buildTrakSampleLists=function(t){var e,r,n,a,p,c,u,f,b,v,w,C,S,N,O,lt,_t,mt,J,pt,Ft,Kt,ct,Ct;if(t.samples=[],t.samples_duration=0,t.samples_size=0,r=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,n=t.mdia.minf.stbl.stsc,a=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,p=t.mdia.minf.stbl.stts,c=t.mdia.minf.stbl.ctts,u=t.mdia.minf.stbl.stss,f=t.mdia.minf.stbl.stsd,b=t.mdia.minf.stbl.subs,C=t.mdia.minf.stbl.stdp,v=t.mdia.minf.stbl.sbgps,w=t.mdia.minf.stbl.sgpds,mt=-1,J=-1,pt=-1,Ft=-1,Kt=0,ct=0,Ct=0,_.initSampleGroups(t,null,v,w),!(typeof a>"u")){for(e=0;e<a.sample_sizes.length;e++){var B={};B.number=e,B.track_id=t.tkhd.track_id,B.timescale=t.mdia.mdhd.timescale,B.alreadyRead=0,t.samples[e]=B,B.size=a.sample_sizes[e],t.samples_size+=B.size,e===0?(N=1,S=0,B.chunk_index=N,B.chunk_run_index=S,_t=n.samples_per_chunk[S],lt=0,S+1<n.first_chunk.length?O=n.first_chunk[S+1]-1:O=1/0):e<_t?(B.chunk_index=N,B.chunk_run_index=S):(N++,B.chunk_index=N,lt=0,N<=O||(S++,S+1<n.first_chunk.length?O=n.first_chunk[S+1]-1:O=1/0),B.chunk_run_index=S,_t+=n.samples_per_chunk[S]),B.description_index=n.sample_description_index[B.chunk_run_index]-1,B.description=f.entries[B.description_index],B.offset=r.chunk_offsets[B.chunk_index-1]+lt,lt+=B.size,e>mt&&(J++,mt<0&&(mt=0),mt+=p.sample_counts[J]),e>0?(t.samples[e-1].duration=p.sample_deltas[J],t.samples_duration+=t.samples[e-1].duration,B.dts=t.samples[e-1].dts+t.samples[e-1].duration):B.dts=0,c?(e>=pt&&(Ft++,pt<0&&(pt=0),pt+=c.sample_counts[Ft]),B.cts=t.samples[e].dts+c.sample_offsets[Ft]):B.cts=B.dts,u?(e==u.sample_numbers[Kt]-1?(B.is_sync=!0,Kt++):(B.is_sync=!1,B.degradation_priority=0),b&&b.entries[ct].sample_delta+Ct==e+1&&(B.subsamples=b.entries[ct].subsamples,Ct+=b.entries[ct].sample_delta,ct++)):B.is_sync=!0,_.process_sdtp(t.mdia.minf.stbl.sdtp,B,B.number),C?B.degradation_priority=C.priority[e]:B.degradation_priority=0,b&&b.entries[ct].sample_delta+Ct==e&&(B.subsamples=b.entries[ct].subsamples,Ct+=b.entries[ct].sample_delta),(v.length>0||w.length>0)&&_.setSampleGroupProperties(t,B,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},_.prototype.updateSampleLists=function(){var t,e,r,n,a,p,c,u,f,b,v,w,C,S,N;if(this.moov!==void 0){for(;this.lastMoofIndex<this.moofs.length;)if(f=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,f.type=="moof")for(b=f,t=0;t<b.trafs.length;t++){for(v=b.trafs[t],w=this.getTrackById(v.tfhd.track_id),C=this.getTrexById(v.tfhd.track_id),v.tfhd.flags&s.TFHD_FLAG_SAMPLE_DESC?n=v.tfhd.default_sample_description_index:n=C?C.default_sample_description_index:1,v.tfhd.flags&s.TFHD_FLAG_SAMPLE_DUR?a=v.tfhd.default_sample_duration:a=C?C.default_sample_duration:0,v.tfhd.flags&s.TFHD_FLAG_SAMPLE_SIZE?p=v.tfhd.default_sample_size:p=C?C.default_sample_size:0,v.tfhd.flags&s.TFHD_FLAG_SAMPLE_FLAGS?c=v.tfhd.default_sample_flags:c=C?C.default_sample_flags:0,v.sample_number=0,v.sbgps.length>0&&_.initSampleGroups(w,v,v.sbgps,w.mdia.minf.stbl.sgpds,v.sgpds),e=0;e<v.truns.length;e++){var O=v.truns[e];for(r=0;r<O.sample_count;r++){S={},S.moof_number=this.lastMoofIndex,S.number_in_traf=v.sample_number,v.sample_number++,S.number=w.samples.length,v.first_sample_index=w.samples.length,w.samples.push(S),S.track_id=w.tkhd.track_id,S.timescale=w.mdia.mdhd.timescale,S.description_index=n-1,S.description=w.mdia.minf.stbl.stsd.entries[S.description_index],S.size=p,O.flags&s.TRUN_FLAGS_SIZE&&(S.size=O.sample_size[r]),w.samples_size+=S.size,S.duration=a,O.flags&s.TRUN_FLAGS_DURATION&&(S.duration=O.sample_duration[r]),w.samples_duration+=S.duration,w.first_traf_merged||r>0?S.dts=w.samples[w.samples.length-2].dts+w.samples[w.samples.length-2].duration:(v.tfdt?S.dts=v.tfdt.baseMediaDecodeTime:S.dts=0,w.first_traf_merged=!0),S.cts=S.dts,O.flags&s.TRUN_FLAGS_CTS_OFFSET&&(S.cts=S.dts+O.sample_composition_time_offset[r]),N=c,O.flags&s.TRUN_FLAGS_FLAGS?N=O.sample_flags[r]:r===0&&O.flags&s.TRUN_FLAGS_FIRST_FLAG&&(N=O.first_sample_flags),S.is_sync=!(N>>16&1),S.is_leading=N>>26&3,S.depends_on=N>>24&3,S.is_depended_on=N>>22&3,S.has_redundancy=N>>20&3,S.degradation_priority=N&65535;var lt=!!(v.tfhd.flags&s.TFHD_FLAG_BASE_DATA_OFFSET),_t=!!(v.tfhd.flags&s.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),mt=!!(O.flags&s.TRUN_FLAGS_DATA_OFFSET),J=0;lt?J=v.tfhd.base_data_offset:_t||e===0?J=b.start:J=u,e===0&&r===0?mt?S.offset=J+O.data_offset:S.offset=J:S.offset=u,u=S.offset+S.size,(v.sbgps.length>0||v.sgpds.length>0||w.mdia.minf.stbl.sbgps.length>0||w.mdia.minf.stbl.sgpds.length>0)&&_.setSampleGroupProperties(w,S,S.number_in_traf,v.sample_groups_info)}}if(v.subs){w.has_fragment_subsamples=!0;var pt=v.first_sample_index;for(e=0;e<v.subs.entries.length;e++)pt+=v.subs.entries[e].sample_delta,S=w.samples[pt-1],S.subsamples=v.subs.entries[e].subsamples}}}},_.prototype.getSample=function(t,e){var r,n=t.samples[e];if(!this.moov)return null;if(!n.data)n.data=new Uint8Array(n.size),n.alreadyRead=0,this.samplesDataSize+=n.size,o.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+n.size+" (total: "+this.samplesDataSize+")");else if(n.alreadyRead==n.size)return n;for(;;){var a=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(a>-1){r=this.stream.buffers[a];var p=r.byteLength-(n.offset+n.alreadyRead-r.fileStart);if(n.size-n.alreadyRead<=p)return o.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-r.fileStart)+" read size: "+(n.size-n.alreadyRead)+" full size: "+n.size+")"),h.memcpy(n.data.buffer,n.alreadyRead,r,n.offset+n.alreadyRead-r.fileStart,n.size-n.alreadyRead),r.usedBytes+=n.size-n.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead=n.size,n;if(p===0)return null;o.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-r.fileStart)+" read size: "+p+" full size: "+n.size+")"),h.memcpy(n.data.buffer,n.alreadyRead,r,n.offset+n.alreadyRead-r.fileStart,p),n.alreadyRead+=p,r.usedBytes+=p,this.stream.logBufferLevel()}else return null}},_.prototype.releaseSample=function(t,e){var r=t.samples[e];return r.data?(this.samplesDataSize-=r.size,r.data=null,r.alreadyRead=0,r.size):0},_.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},_.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){var r=this.moov.traks[t];t>0&&(e+=","),e+=r.mdia.minf.stbl.stsd.entries[0].getCodec()}return e},_.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var r=this.moov.mvex.trexs[e];if(r.track_id==t)return r}return null},_.prototype.getTrackById=function(t){if(this.moov===void 0)return null;for(var e=0;e<this.moov.traks.length;e++){var r=this.moov.traks[e];if(r.tkhd.track_id==t)return r}return null},_.prototype.items=[],_.prototype.itemsDataSize=0,_.prototype.flattenItemInfo=function(){var t=this.items,e,r,n,a=this.meta;if(a!=null&&a.hdlr!==void 0&&a.iinf!==void 0){for(e=0;e<a.iinf.item_infos.length;e++)n={},n.id=a.iinf.item_infos[e].item_ID,t[n.id]=n,n.ref_to=[],n.name=a.iinf.item_infos[e].item_name,a.iinf.item_infos[e].protection_index>0&&(n.protection=a.ipro.protections[a.iinf.item_infos[e].protection_index-1]),a.iinf.item_infos[e].item_type?n.type=a.iinf.item_infos[e].item_type:n.type="mime",n.content_type=a.iinf.item_infos[e].content_type,n.content_encoding=a.iinf.item_infos[e].content_encoding;if(a.iloc)for(e=0;e<a.iloc.items.length;e++){var p=a.iloc.items[e];switch(n=t[p.item_ID],p.data_reference_index!==0&&(o.warn("Item storage with reference to other files: not supported"),n.source=a.dinf.boxes[p.data_reference_index-1]),p.construction_method){case 0:break;case 1:o.warn("Item storage with construction_method : not supported");break;case 2:o.warn("Item storage with construction_method : not supported");break}for(n.extents=[],n.size=0,r=0;r<p.extents.length;r++)n.extents[r]={},n.extents[r].offset=p.extents[r].extent_offset+p.base_offset,n.extents[r].length=p.extents[r].extent_length,n.extents[r].alreadyRead=0,n.size+=n.extents[r].length}if(a.pitm&&(t[a.pitm.item_id].primary=!0),a.iref)for(e=0;e<a.iref.references.length;e++){var c=a.iref.references[e];for(r=0;r<c.references.length;r++)t[c.from_item_ID].ref_to.push({type:c.type,id:c.references[r]})}if(a.iprp)for(var u=0;u<a.iprp.ipmas.length;u++){var f=a.iprp.ipmas[u];for(e=0;e<f.associations.length;e++){var b=f.associations[e];for(n=t[b.id],n.properties===void 0&&(n.properties={},n.properties.boxes=[]),r=0;r<b.props.length;r++){var v=b.props[r];if(v.property_index>0&&v.property_index-1<a.iprp.ipco.boxes.length){var w=a.iprp.ipco.boxes[v.property_index-1];n.properties[w.type]=w,n.properties.boxes.push(w)}}}}}},_.prototype.getItem=function(t){var e,r;if(!this.meta)return null;if(r=this.items[t],!r.data&&r.size)r.data=new Uint8Array(r.size),r.alreadyRead=0,this.itemsDataSize+=r.size,o.debug("ISOFile","Allocating item #"+t+" of size "+r.size+" (total: "+this.itemsDataSize+")");else if(r.alreadyRead===r.size)return r;for(var n=0;n<r.extents.length;n++){var a=r.extents[n];if(a.alreadyRead!==a.length){var p=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(p>-1){e=this.stream.buffers[p];var c=e.byteLength-(a.offset+a.alreadyRead-e.fileStart);if(a.length-a.alreadyRead<=c)o.debug("ISOFile","Getting item #"+t+" extent #"+n+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+(a.length-a.alreadyRead)+" full extent size: "+a.length+" full item size: "+r.size+")"),h.memcpy(r.data.buffer,r.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,a.length-a.alreadyRead),e.usedBytes+=a.length-a.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead+=a.length-a.alreadyRead,a.alreadyRead=a.length;else return o.debug("ISOFile","Getting item #"+t+" extent #"+n+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+c+" full extent size: "+a.length+" full item size: "+r.size+")"),h.memcpy(r.data.buffer,r.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,c),a.alreadyRead+=c,r.alreadyRead+=c,e.usedBytes+=c,this.stream.logBufferLevel(),null}else return null}}return r.alreadyRead===r.size?r:null},_.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var r=0;r<e.extents.length;r++){var n=e.extents[r];n.alreadyRead=0}return e.size}else return 0},_.prototype.processItems=function(t){for(var e in this.items){var r=this.items[e];this.getItem(r.id),t&&!r.sent&&(t(r),r.sent=!0,r.data=null)}},_.prototype.hasItem=function(t){for(var e in this.items){var r=this.items[e];if(r.name===t)return r.id}return-1},_.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},_.prototype.getPrimaryItem=function(){return!this.meta||!this.meta.pitm?null:this.getItem(this.meta.pitm.item_id)},_.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},r=null;if(e.itemId?r=this.getItem(e.itemId):r=this.getPrimaryItem(),r==null)return null;var n=new _;n.discardMdatData=!1;var a={type:r.type,description_boxes:r.properties.boxes};r.properties.ispe&&(a.width=r.properties.ispe.image_width,a.height=r.properties.ispe.image_height);var p=n.addTrack(a);return p?(n.addSample(p,r.data),n):null},_.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},_.prototype.createFragment=function(t,e,r){var n=this.getTrackById(t),a=this.getSample(n,e);if(a==null)return this.setNextSeekPositionFromSample(n.samples[e]),null;var p=r||new h;p.endianness=h.BIG_ENDIAN;var c=this.createSingleSampleMoof(a);c.write(p),c.trafs[0].truns[0].data_offset=c.size+8,o.debug("MP4Box","Adjusting data_offset with new value "+c.trafs[0].truns[0].data_offset),p.adjustUint32(c.trafs[0].truns[0].data_offset_position,c.trafs[0].truns[0].data_offset);var u=new s.mdatBox;return u.data=a.data,u.write(p),p},_.writeInitializationSegment=function(t,e,r,n){var a;o.debug("ISOFile","Generating initialization segment");var p=new h;p.endianness=h.BIG_ENDIAN,t.write(p);var c=e.add("mvex");for(r&&c.add("mehd").set("fragment_duration",r),a=0;a<e.traks.length;a++)c.add("trex").set("track_id",e.traks[a].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",n).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(p),p.buffer},_.prototype.save=function(t){var e=new h;e.endianness=h.BIG_ENDIAN,this.write(e),e.save(t)},_.prototype.getBuffer=function(){var t=new h;return t.endianness=h.BIG_ENDIAN,this.write(t),t.buffer},_.prototype.initializeSegmentation=function(){var t,e,r,n;for(this.onSegment===null&&o.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var a=new s.moovBox;a.mvhd=this.moov.mvhd,a.boxes.push(a.mvhd),r=this.getTrackById(this.fragmentedTracks[t].id),a.boxes.push(r),a.traks.push(r),n={},n.id=r.tkhd.track_id,n.user=this.fragmentedTracks[t].user,n.buffer=_.writeInitializationSegment(this.ftyp,a,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(n)}return e},s.Box.prototype.printHeader=function(t){this.size+=8,this.size>m&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},s.FullBox.prototype.printHeader=function(t){this.size+=4,s.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},s.Box.prototype.print=function(t){this.printHeader(t)},s.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var r=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=r}},_.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},s.mvhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},s.tkhdBox.prototype.print=function(t){s.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var I={};I.createFile=function(t,e){var r=t!==void 0?t:!0,n=new _(e);return n.discardMdatData=!r,n},l.createFile=I.createFile})(he);const Rt={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2"};var wt,at,ut,xt,ot,vt,Ot,$t;const zt=class{constructor(l,o={}){R(this,Ot),L(this,"ready"),R(this,wt,{duration:0,width:0,height:0}),R(this,at,new Float32Array),R(this,ut,new Float32Array),R(this,xt,0),R(this,ot,0),R(this,vt,void 0),F(this,vt,Dt({loop:!1,volume:1},o)),this.ready=gt(this,Ot,$t).call(this,l).then(()=>({width:0,height:0,duration:o.loop?1/0:x(this,wt).duration}))}getPCMData(){return[x(this,at),x(this,ut)]}tick(l){return Q(this,null,function*(){if(l<x(this,xt))throw Error("time not allow rollback");if(!x(this,vt).loop&&l>=x(this,wt).duration)return{audio:[],state:"done"};const o=l-x(this,xt);F(this,xt,l);const d=Math.ceil(o*(Rt.sampleRate/1e6)),h=x(this,ot)+d,m=x(this,vt).loop?[Xt(x(this,at),x(this,ot),h),Xt(x(this,ut),x(this,ot),h)]:[x(this,at).slice(x(this,ot),h),x(this,ut).slice(x(this,ot),h)];return F(this,ot,h),{audio:m,state:"success"}})}destroy(){F(this,at,new Float32Array(0)),F(this,ut,new Float32Array(0)),Z.info("---- audioclip destroy ----")}};let de=zt;wt=new WeakMap,at=new WeakMap,ut=new WeakMap,xt=new WeakMap,ot=new WeakMap,vt=new WeakMap,Ot=new WeakSet,$t=function(l){return Q(this,null,function*(){var m;zt.ctx==null&&(zt.ctx=new AudioContext({sampleRate:Rt.sampleRate}));const o=performance.now(),d=l instanceof ReadableStream?yield le(l,zt.ctx):l;Z.info("Audio clip decoded complete:",performance.now()-o);const h=x(this,vt).volume;if(h!==1)for(const g of d)for(let U=0;U<g.length;U+=1)g[U]*=h;x(this,wt).duration=d[0].length/Rt.sampleRate*1e6,F(this,at,d[0]),F(this,ut,(m=d[1])!=null?m:x(this,at)),Z.info("Audio clip convert to AudioData, time:",performance.now()-o)})},L(de,"ctx",null);function le(l,o){return Q(this,null,function*(){const d=yield new Response(l).arrayBuffer();return oe(yield o.decodeAudioData(d))})}const pe=["t","b","l","r","lt","lb","rt","rb","rotate"],$=class{constructor(l,o,d,h,m){L(this,"x",0),L(this,"y",0),L(this,"w",0),L(this,"h",0),L(this,"angle",0),L(this,"master",null),this.x=l!=null?l:0,this.y=o!=null?o:0,this.w=d!=null?d:0,this.h=h!=null?h:0,this.master=m!=null?m:null}get center(){const{x:l,y:o,w:d,h}=this;return{x:l+d/2,y:o+h/2}}get ctrls(){const{w:l,h:o}=this,d=$.CTRL_SIZE,h=d/2,m=l/2,g=o/2,U=d*1.5,s=U/2;return{t:new $(-h,-g-h,d,d,this),b:new $(-h,g-h,d,d,this),l:new $(-m-h,-h,d,d,this),r:new $(m-h,-h,d,d,this),lt:new $(-m-h,-g-h,d,d,this),lb:new $(-m-h,g-h,d,d,this),rt:new $(m-h,-g-h,d,d,this),rb:new $(m-h,g-h,d,d,this),rotate:new $(-s,-g-d*2-s,U,U,this)}}clone(){const{x:l,y:o,w:d,h,master:m}=this;return new $(l,o,d,h,m)}checkHit(l,o){var n,a;let{angle:d,center:h,x:m,y:g,w:U,h:s,master:A}=this;const z=(n=A==null?void 0:A.center)!=null?n:h,_=(a=A==null?void 0:A.angle)!=null?a:d;A==null&&(m=m-z.x,g=g-z.y);const I=l-z.x,t=o-z.y;let e=I,r=t;return _!==0&&(e=I*Math.cos(_)+t*Math.sin(_),r=t*Math.cos(_)-I*Math.sin(_)),!(e<m||e>m+U||r<g||r>g+s)}};let Nt=$;L(Nt,"CTRL_SIZE",16);var Et,ft;class It{constructor(o){L(this,"rect",new Nt),L(this,"visible",!0),L(this,"zIndex",0),L(this,"opacity",1),L(this,"flip",null),R(this,Et,null),R(this,ft,null),L(this,"audioNode",null),L(this,"initReady",Promise.resolve()),this.name=o}render(o){const{rect:{center:d,angle:h}}=this;o.setTransform(this.flip==="horizontal"?-1:1,0,0,this.flip==="vertical"?-1:1,d.x,d.y),o.rotate((this.flip==null?1:-1)*h),o.globalAlpha=this.opacity}setAnimation(o,d){var h,m;F(this,Et,Object.entries(o).map(([g,U])=>{var A;const s=(A={from:0,to:100}[g])!=null?A:Number(g.slice(0,-1));if(isNaN(s)||s>100||s<0)throw Error("keyFrame must between 0~100");return[s/100,U]})),F(this,ft,Object.assign({},x(this,ft),{duration:d.duration*1e6,delay:((h=d.delay)!=null?h:0)*1e6,iterCount:(m=d.iterCount)!=null?m:1/0}))}animate(o){if(x(this,Et)==null||x(this,ft)==null||o<x(this,ft).delay)return;const d=ce(o,x(this,Et),x(this,ft));for(const h in d)switch(h){case"opacity":this.opacity=d[h];break;case"x":case"y":case"w":case"h":case"angle":this.rect[h]=d[h];break}}}Et=new WeakMap,ft=new WeakMap;function ce(l,o,d){if(l/d.duration>=d.iterCount)return{};const h=l%d.duration,m=l===d.duration?1:h/d.duration,g=o.findIndex(t=>t[0]>=m);if(g===-1)return{};const U=o[g-1],s=o[g],A=s[1];if(U==null)return A;const z=U[1],_={},I=(m-U[0])/(s[0]-U[0]);for(const t in A){const e=t;z[e]!=null&&(_[e]=(A[e]-z[e])*I+z[e])}return _}function At(l){return document.createElement(l)}var ht;class ue{constructor(){T(this,ht,new Map),M(this,"on",(o,d)=>{var m;const h=(m=y(this,ht).get(o))!=null?m:new Set;return h.add(d),y(this,ht).has(o)||y(this,ht).set(o,h),()=>{h.delete(d),h.size===0&&y(this,ht).delete(o)}}),M(this,"emit",(o,...d)=>{const h=y(this,ht).get(o);h!=null&&h.forEach(m=>m(...d))})}destroy(){y(this,ht).clear()}}ht=new WeakMap;var Pt=(l=>(l.ActiveSpriteChange="activeSpriteChange",l.AddSprite="addSprite",l))(Pt||{}),q,Bt,bt,Gt,qt;class fe{constructor(){T(this,Gt),T(this,q,[]),T(this,Bt,null),T(this,bt,new ue),M(this,"audioCtx",new AudioContext),M(this,"audioMSDest",this.audioCtx.createMediaStreamDestination()),M(this,"on",y(this,bt).on),tt(this,Gt,qt).call(this)}get activeSprite(){return y(this,Bt)}set activeSprite(o){o!==y(this,Bt)&&(D(this,Bt,o),y(this,bt).emit("activeSpriteChange",o))}addSprite(o){return Q(this,null,function*(){var d;yield o.initReady,y(this,q).push(o),D(this,q,y(this,q).sort((h,m)=>h.zIndex-m.zIndex)),(d=o.audioNode)==null||d.connect(this.audioMSDest),y(this,bt).emit("addSprite",o)})}sortSprite(){D(this,q,y(this,q).sort((o,d)=>o.zIndex-d.zIndex))}removeSprite(o){D(this,q,y(this,q).filter(d=>d!==o)),o.destroy()}getSprites(){return[...y(this,q)]}destroy(){y(this,bt).destroy(),y(this,q).forEach(o=>o.destroy()),D(this,q,[]),this.audioMSDest.disconnect(),this.audioCtx.close().catch(console.error)}}q=new WeakMap,Bt=new WeakMap,bt=new WeakMap,Gt=new WeakSet,qt=function(){const l=this.audioCtx.createOscillator(),o=this.audioCtx.createPeriodicWave(new Float32Array([0,0]),new Float32Array([0,0]),{disableNormalization:!0});l.setPeriodicWave(o),l.connect(this.audioMSDest),l.start()};function _e(l,o,d){const h={w:o.clientWidth/o.width,h:o.clientHeight/o.height},m=new ResizeObserver(()=>{h.w=o.clientWidth/o.width,h.h=o.clientHeight/o.height,d.activeSprite!=null&&Ht(d.activeSprite,g,U,h)});m.observe(o);const{rectEl:g,ctrlsEl:U}=me(l),s=d.on(Pt.ActiveSpriteChange,t=>{if(t==null){g.style.display="none";return}Ht(t,g,U,h),g.style.display=""});let A=!1;const z=t=>{t.button===0&&(A=!0)},_=()=>{A=!1},I=()=>{!A||d.activeSprite==null||Ht(d.activeSprite,g,U,h)};return o.addEventListener("mousedown",z),window.addEventListener("mouseup",_),window.addEventListener("mousemove",I),()=>{m.disconnect(),s(),g.remove(),o.removeEventListener("mousedown",z),window.removeEventListener("mouseup",_),window.removeEventListener("mousemove",I)}}function me(l){const o=At("div");o.style.cssText=`
    position: absolute;
    pointer-events: none;
    border: 1px solid #eee;
    box-sizing: border-box;
    display: none;
  `;const d=Object.fromEntries(pe.map(h=>{const m=At("div");return m.style.cssText=`
      position: absolute;
      border: 1px solid #3ee;
      box-sizing: border-box;
      border-radius: 50%;
      background-color: #fff;
    `,[h,m]}));return Object.values(d).forEach(h=>o.appendChild(h)),l.appendChild(o),{rectEl:o,ctrlsEl:d}}function Ht(l,o,d,h){const{x:m,y:g,w:U,h:s,angle:A,ctrls:z}=l.rect;Object.assign(o.style,{left:`${m*h.w}px`,top:`${g*h.h}px`,width:`${U*h.w}px`,height:`${s*h.h}px`,rotate:`${A}rad`}),Object.entries(z).forEach(([_,{x:I,y:t,w:e,h:r}])=>{Object.assign(d[_].style,{left:"50%",top:"50%",width:`${e*h.w}px`,height:`${r*h.h}px`,transform:`translate(${I*h.w}px, ${t*h.h}px)`})})}function ge(l,o){const d={w:l.clientWidth/l.width,h:l.clientHeight/l.height},h=new ResizeObserver(()=>{d.w=l.clientWidth/l.width,d.h=l.clientHeight/l.height});h.observe(l);const m=g=>{var _,I;if(g.button!==0)return;const{offsetX:U,offsetY:s}=g,A=U/d.w,z=s/d.h;if(o.activeSprite!=null){const[t]=(_=Object.entries(o.activeSprite.rect.ctrls).find(([,e])=>e.checkHit(A,z)))!=null?_:[];if(t!=null)return}o.activeSprite=(I=o.getSprites().reverse().find(t=>t.rect.checkHit(A,z)))!=null?I:null};return l.addEventListener("mousedown",m),()=>{h.disconnect(),l.removeEventListener("mousedown",m)}}function ye(l,o){const d={w:l.clientWidth/l.width,h:l.clientHeight/l.height},h=new ResizeObserver(()=>{d.w=l.clientWidth/l.width,d.h=l.clientHeight/l.height});h.observe(l);let m=0,g=0,U=null,s=null,A=null;const z=t=>{if(t.button!==0||o.activeSprite==null)return;A=o.activeSprite;const{offsetX:e,offsetY:r,clientX:n,clientY:a}=t;Ue({rect:A.rect,offsetX:e,offsetY:r,clientX:n,clientY:a,cvsRatio:d,cvsEl:l})||(U=A.rect.clone(),s={xl:-U.w+10,xr:l.width-10,yt:-U.h+10,yb:l.height-10},m=n,g=a,window.addEventListener("mousemove",_),window.addEventListener("mouseup",I))},_=t=>{if(A==null||U==null||s==null)return;const{clientX:e,clientY:r}=t;let n=U.x+(e-m)/d.w,a=U.y+(r-g)/d.h;n=n<=s.xl?s.xl:n>=s.xr?s.xr:n,a=a<=s.yt?s.yt:a>=s.yb?s.yb:a,A.rect.x=n,A.rect.y=a};l.addEventListener("mousedown",z);const I=()=>{window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",I)};return()=>{h.disconnect(),I(),l.removeEventListener("mousedown",z)}}function ve({sprRect:l,startX:o,startY:d,ctrlKey:h,cvsRatio:m}){const g=l.clone(),U=A=>{const{clientX:z,clientY:_}=A,I=(z-o)/m.w,t=(_-d)/m.h,e=h.length===1?be:Se,{x:r,y:n,w:a,h:p}=g,c=Math.atan2(p,a),{incW:u,incH:f,incS:b,rotateAngle:v}=e({deltaX:I,deltaY:t,angle:l.angle,ctrlKey:h,diagonalAngle:c}),w=10;let C=a+u;C=C<w?w:C;let S=p+f;S=S<w?w:S;const N=b/2*Math.cos(v)+r+a/2,O=b/2*Math.sin(v)+n+p/2,lt=N-C/2,_t=O-S/2;l.x=lt,l.y=_t,l.w=C,l.h=S},s=()=>{window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",s)};window.addEventListener("mousemove",U),window.addEventListener("mouseup",s)}function be({deltaX:l,deltaY:o,angle:d,ctrlKey:h}){let m=0,g=0,U=0,s=d;return h==="l"||h==="r"?(m=l*Math.cos(d)+o*Math.sin(d),g=m*(h==="l"?-1:1)):(h==="t"||h==="b")&&(s=d-Math.PI/2,m=l*Math.cos(s)+o*Math.sin(s),U=m*(h==="b"?-1:1)),{incW:g,incH:U,incS:m,rotateAngle:s}}function Se({deltaX:l,deltaY:o,angle:d,ctrlKey:h,diagonalAngle:m}){const g=(h==="lt"||h==="rb"?1:-1)*m+d,U=l*Math.cos(g)+o*Math.sin(g),s=h==="lt"||h==="lb"?-1:1,A=U*Math.cos(m)*s,z=U*Math.sin(m)*s;return{incW:A,incH:z,incS:U,rotateAngle:g}}function Ue({rect:l,cvsRatio:o,offsetX:d,offsetY:h,clientX:m,clientY:g,cvsEl:U}){var _;const s=d/o.w,A=h/o.h,[z]=(_=Object.entries(l.ctrls).find(([,I])=>I.checkHit(s,A)))!=null?_:[];return z==null?!1:(z==="rotate"?we(l,xe(l.center,o,U)):ve({sprRect:l,ctrlKey:z,startX:m,startY:g,cvsRatio:o}),!0)}function we(l,o){const d=({clientX:m,clientY:g})=>{const U=m-o.x,s=g-o.y,A=Math.atan2(s,U)+Math.PI/2;l.angle=A},h=()=>{window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",h)};window.addEventListener("mousemove",d),window.addEventListener("mouseup",h)}function xe(l,o,d){const h=l.x*o.w,m=l.y*o.h,{left:g,top:U}=d.getBoundingClientRect();return{x:h+g,y:m+U}}function Ee(l){const o=At("canvas");return o.style.cssText=`
    width: 100%;
    height: 100%;
  `,o.width=l.width,o.height=l.height,o}var V,St,Lt,kt,Yt,Jt;class Ae{constructor(o,d){T(this,Yt),T(this,V,void 0),M(this,"spriteManager"),T(this,St,void 0),T(this,Lt,!1),T(this,kt,[]),D(this,V,Ee(d.resolution));const h=y(this,V).getContext("2d",{alpha:!1});if(h==null)throw Error("canvas context is null");D(this,St,h),o.appendChild(y(this,V)),Nt.CTRL_SIZE=14/(y(this,V).clientWidth/y(this,V).width),this.spriteManager=new fe,y(this,kt).push(ge(y(this,V),this.spriteManager),Be(y(this,V),this.spriteManager),ye(y(this,V),this.spriteManager),_e(o,y(this,V),this.spriteManager),this.spriteManager.on(Pt.AddSprite,g=>{const{rect:U}=g;U.x===0&&U.y===0&&(U.x=(y(this,V).width-U.w)/2,U.y=(y(this,V).height-U.h)/2)}));const m=()=>{y(this,Lt)||(y(this,St).fillStyle=d.bgColor,y(this,St).fillRect(0,0,d.resolution.width,d.resolution.height),tt(this,Yt,Jt).call(this),requestAnimationFrame(m))};m()}destroy(){D(this,Lt,!0),y(this,V).remove(),y(this,kt).forEach(o=>o()),this.spriteManager.destroy()}captureStream(){this.spriteManager.audioCtx.state==="suspended"&&(Z.info("AVCanvas.captureStream resume AudioContext"),this.spriteManager.audioCtx.resume().catch(Z.error));const o=new MediaStream;return y(this,V).captureStream().getTracks().concat(this.spriteManager.audioMSDest.stream.getTracks()).forEach(d=>{o.addTrack(d)}),Z.info("AVCanvas.captureStream, tracks:",o.getTracks().map(d=>d.kind)),o}}V=new WeakMap,St=new WeakMap,Lt=new WeakMap,kt=new WeakMap,Yt=new WeakSet,Jt=function(){const l=y(this,St);this.spriteManager.getSprites().forEach(o=>o.render(l)),l.resetTransform()};function Be(l,o){const d={w:l.clientWidth/l.width,h:l.clientHeight/l.height},h=new ResizeObserver(()=>{d.w=l.clientWidth/l.width,d.h=l.clientHeight/l.height});h.observe(l);const m=l.style;let g=o.activeSprite;o.on(Pt.ActiveSpriteChange,t=>{g=t,t==null&&(m.cursor="")});let U=!1;const s=({offsetX:t,offsetY:e})=>{U=!0;const r=t/d.w,n=e/d.h;(g==null?void 0:g.rect.checkHit(r,n))===!0&&m.cursor===""&&(m.cursor="move")},A=()=>{U=!1},z=["ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize"],_={t:0,rt:1,r:2,rb:3,b:4,lb:5,l:6,lt:7},I=t=>{var c;if(g==null||U)return;const{offsetX:e,offsetY:r}=t,n=e/d.w,a=r/d.h,[p]=(c=Object.entries(g.rect.ctrls).find(([,u])=>u.checkHit(n,a)))!=null?c:[];if(p!=null){if(p==="rotate"){m.cursor="crosshair";return}const u=g.rect.angle,f=u<0?u+2*Math.PI:u,b=(_[p]+Math.floor((f+Math.PI/8)/(Math.PI/4)))%8;m.cursor=z[b];return}if(g.rect.checkHit(n,a)){m.cursor="move";return}m.cursor=""};return l.addEventListener("mousemove",I),l.addEventListener("mousedown",s),window.addEventListener("mouseup",A),()=>{h.disconnect(),l.removeEventListener("mousemove",I),l.removeEventListener("mousedown",s),window.removeEventListener("mouseup",A)}}var dt;class Ce extends It{constructor(o,d,h={}){if(super(o),T(this,dt,At("audio")),M(this,"visible",!1),!["audio/mpeg","audio/ogg","audio/wav"].includes(d.type))throw new Error("Unsupport audio format");h.audioCtx!=null&&(this.audioNode=h.audioCtx.createGain(),h.audioCtx.createMediaElementSource(y(this,dt)).connect(this.audioNode)),y(this,dt).loop=!0,y(this,dt).src=URL.createObjectURL(d),y(this,dt).play().catch(console.error)}destroy(){var o;y(this,dt).remove(),(o=this.audioNode)==null||o.disconnect(),URL.revokeObjectURL(y(this,dt).src)}}dt=new WeakMap;var st,Vt,Qt,Wt,te;class Te extends It{constructor(o,d,h={}){super(o),T(this,Vt),T(this,Wt),T(this,st,null),this.initReady=(d instanceof MediaStream?tt(this,Vt,Qt).call(this,d,h):tt(this,Wt,te).call(this,d,h)).then(({videoEl:m,audioSource:g})=>{m.loop=!0,this.rect.w=m.videoWidth,this.rect.h=m.videoHeight,D(this,st,m),g!=null&&h.audioCtx!=null&&(this.audioNode=h.audioCtx.createGain(),g.connect(this.audioNode))})}render(o){if(y(this,st)==null)return;super.render(o);const{w:d,h}=this.rect;o.drawImage(y(this,st),-d/2,-h/2,d,h)}get volume(){var d;var o;return(d=(o=this.audioNode)==null?void 0:o.gain.value)!=null?d:0}set volume(o){this.audioNode!=null&&(this.audioNode.gain.value=o)}destroy(){var o,d,h;(o=y(this,st))==null||o.remove(),((d=y(this,st))==null?void 0:d.src)!=null&&URL.revokeObjectURL(y(this,st).src),D(this,st,null),(h=this.audioNode)==null||h.disconnect()}}st=new WeakMap,Vt=new WeakSet,Qt=function(l,o){return Q(this,null,function*(){const d=new MediaStream;l.getAudioTracks().forEach(g=>{l.removeTrack(g),d.addTrack(g)});const h=yield ze(l);yield h.play();let m=null;return o.audioCtx!=null&&d.getAudioTracks().length>0&&(m=o.audioCtx.createMediaStreamSource(d)),{videoEl:h,audioSource:m}})},Wt=new WeakSet,te=function(l,o){return Q(this,null,function*(){if(!["video/mp4","video/webm"].includes(l.type))throw Error("Unsupport video format");const d=At("video");d.src=URL.createObjectURL(l),yield d.play();let h=null;return o.audioCtx!=null&&(h=o.audioCtx.createMediaElementSource(d)),{videoEl:d,audioSource:h}})};function ze(l){return Q(this,null,function*(){const o=document.createElement("video");let d;return o.srcObject=l,yield new Promise((h,m)=>{let g=!1;o.addEventListener("loadeddata",()=>{g||(clearTimeout(d),h(o))}),d=window.setTimeout(()=>{g=!0,m(new Error("video load failed"))},2e3)})})}var Ut;class Ie extends It{constructor(o,d,h={}){super(o),T(this,Ut,void 0);const m=Dt({color:"#ffffff",size:100,family:"sans-serif"},h);D(this,Ut,X(d,`
        font-size: ${m.size}px;
        color: ${m.color};
        font-family: ${m.family};
      `)),this.rect.w=y(this,Ut).width,this.rect.h=y(this,Ut).height}render(o){super.render(o);const{w:d,h}=this.rect;o.drawImage(y(this,Ut),-d/2,-h/2,d,h)}destroy(){}}Ut=new WeakMap;var nt,jt,ee;class Pe extends It{constructor(o,d){if(super(o),T(this,jt),T(this,nt,new Image),d instanceof File&&!["image/png","image/jpg","image/jpeg","image/bmp","image/gif"].includes(d.type))throw Error("Unsupport image format");this.initReady=tt(this,jt,ee).call(this,d).catch(console.error)}render(o){super.render(o);const{w:d,h}=this.rect;o.drawImage(y(this,nt),-d/2,-h/2,d,h)}destroy(){y(this,nt).remove()}}nt=new WeakMap,jt=new WeakSet,ee=function(l){return Q(this,null,function*(){const o=new Promise((d,h)=>{y(this,nt).onload=()=>{this.rect.w=y(this,nt).width,this.rect.h=y(this,nt).height,d()},y(this,nt).onerror=h});y(this,nt).src=l instanceof File?yield Le(l):l,yield o})};function Le(l){return Q(this,null,function*(){return yield new Promise(o=>{const d=new FileReader;d.onload=function(h){o(h.target.result)},d.readAsDataURL(l)})})}}}]);
}());